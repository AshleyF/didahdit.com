<html>
    <head>
        <title>Icom 705 CI-V Test</title>
        <style>
            body {
                background-color: black;
                color: white;
                font-family: sans-serif;
                cursor: hand }
            a { color: #eee; }
            button { background-color: #555; color: #eee; }
            textarea { background-color: #555; color: #eee; }
            h5 { color: #555; }
            hr { color: #555; }
        </style>
        <script>
            var connectedPort = null;

            function load() {
                if ('serial' in navigator) {
                    navigator.serial.addEventListener('connect', (e) => {
                        // Connect to `e.target` or add it to a list of available ports.
                        //alert('Connected: ' + JSON.stringify(e));
                    });
                    navigator.serial.addEventListener('disconnect', (e) => {
                        // Remove `e.target` from the list of available ports.
                        //alert('Disconnected: ' + JSON.stringify(e));
                    });
                } else {
                    alert('SERIAL UNAVAILABLE'); // The Web Serial API is supported.
                }
                document.body.addEventListener('keydown', (e) => {
                    if (!e.repeat && e.srcElement.id != 'message') {
                        switch (e.code) {
                            case 'KeyC':
                                connect();
                                break;
                        }
                    }
                });
                read();
            }

            function connect() {
                // const port = await navigator.serial.requestPort();
                //const usbVendorId = 0xABCD;
                //navigator.serial.requestPort({ filters: [{ usbVendorId }]}).then((port) => {
                navigator.serial.requestPort().then((port) => {
                    // Connect to `port` or add it to the list of available ports.
                    port.open({ baudRate: 115200 }).then(() => {
                        connectedPort = port;
                    }).catch(e => {
                        alert('ERROR OPENING: ' + e);
                    });
                    //navigator.serial.getPorts().then((ports) => {
                    //    // Initialize the list of available ports with `ports` on page load.
                    //    alert('Ports: ' + JSON.stringify(ports));
                    //});
                }).catch((e) => {
                    // The user didn't select a port.
                    alert('ERROR NO PORT CHOSEN: ' + JSON.stringify(e));
                });
            }
            
            //function disconnect() {
            //    if (connectedPort != null) {
            //        connectedPort.close();
            //        connectedPort = null;
            //        // TODO: reader busy/locked https://stackoverflow.com/questions/65748344/how-can-i-interrupt-a-reader-when-it-hangs-need-a-timeout-on-reader-read
            //    }
            //}

            function log(message) {
                document.getElementById('log').innerHTML += '<br />' + message;
            }

            function read() {
                if (connectedPort != null) {
                    const reader = connectedPort.readable.getReader();
                    reader.read().then(x =>
                    {
                        var msg = "Read: ";
                        for (var i in x.value) {
                            var v = x.value[i];
                            msg += v + " ";
                        }
                        log(msg);
                        reader.releaseLock();
                        window.setTimeout(read, 10);
                    });
                } else {
                    window.setTimeout(read, 10);
                }
            }

            var writer = null;
            function sendCommand(command, subcommand, data, transceiver, controller) {
                if (connectedPort != null) {
                    var message = [0xfe, 0xfe]; // preamble
                    message.push(transceiver || 0xa4); // transceiver address (default 0xa4, IC-705)
                    message.push(controller || 0xe0); // default controller address
                    message.push(command);
                    if (subcommand) message.push(subcommand);
                    if (data) message = message.concat(data);
                    message.push(0xfd); // end of message
                    if (!writer) writer = connectedPort.writable.getWriter();
                    //const writer = connectedPort.writable.getWriter();
                    writer.write(new Uint8Array(message));
                    //writer.write(new Uint8Array(message)).then(() => { writer.releaseLock(); });
                }
            }

            function speakMode() {
                sendCommand(0x13 /* speak */, 0x02 /* mode */);
            }

            function setMode(mode) {
                sendCommand(0x01 /* send mode data */, mode);
            }

            function setModeCW() {
                setMode(0x03 /* CW */);
            }

            function setModeLSB() {
                setMode(0x00 /* LSB */);
            }

            function setModeUSB() {
                setMode(0x01 /* USB */);
            }

            function sendCW(message) {
                var ascii = [];
                for (var i in message) {
                    ascii.push(message.charCodeAt(i));
                }
                sendCommand(0x17 /* send CW */, null, ascii);
            }

            function test() {
                log("Testing");
                sendCW("cq pota");
                sendCW(" kk7hxu");
                sendCW(" ^kn test");
                //sendCW("I love you Tracey");
                //sendCW("Ann");
            }
        </script>
    </head>
    <body onload="load()">
        <h5 id="log"></h5>
        <a href="javascript:setModeCW()">CW</a>
        <a href="javascript:setModeUSB()">USB</a>
        <a href="javascript:setModeLSB()">LSB</a>
        <a href="javascript:test()">Test</a>
    </body>
</html>