<html>
    <head>
        <title>CW Practice</title>
        <style>body { margin: 0; padding: 0; }</style>
        <meta name="viewport" content="width=device-width" />
        <link rel="shortcut icon" href="tx.png"> 
        <link rel="apple-touch-icon" href="tx.png">
        <script src="../script/NoSleep.min.js"></script>
        <script src="../utility/keyer.js"></script>
        <script src="../utility/debouncer.js"></script>
        <script src="../utility/decoder.js"></script>
        <script src="../content/library.js"></script>
        <script>
            function testing(message) {
                document.getElementById('trace').innerHTML += '<br />' + JSON.stringify(message);
            }

            var _polarity = 'ditdah';
            var keyedCharacter = '';
            var decoder = Decoder(value => {
                var done = false;
                function advanceCount(char) {
                    if (!done) {
                        var phrase = convertPhrase(getContent().lessons[getLessonNum()].phrases[getPhraseNum()]);
                        var i = phrase.toUpperCase().indexOf(char, ui.count);
                        if (i == ui.count) {
                            ui.count++;
                            if (phrase[ui.count - 1] == '<' || phrase[ui.count - 2] == '<') {
                                while (phrase[ui.count++] != '>');
                            }
                            if (ui.count == phrase.length) {
                                done = true;
                                playDing();
                                setTimeout(function () {
                                    simulateTouchButton('nextPhrase', false);
                                    ui.keying = true;
                                    redraw();
                                    done = false;
                                }, dinglen / 2 * 1000);
                            }
                        }
                    }
                }
                ui.keying = ui.progress = true;
                ui.keyingComplete = false;
                switch (value.kind) {
                    case 'character':
                        if (value.complete) {
                            advanceCount(value.value);
                            if (value.value == ' ') ui.keyingComplete = true;
                        } else {
                            keyedCharacter = value.value;
                        }
                        break;
                    case 'prosign':
                        if (value.complete) {
                            advanceCount('<' + value.value + '>');
                        } else {
                            keyedCharacter = '<' + value.value + '>';
                        }
                        break;
                    case 'invalid':
                        keyedCharacter = '□';
                        break;
                    case 'control':
                        break;
                }
                redraw();
            });
            var keyer = Keyer(element => {
                switch (element) {
                    case 'dit':
                        playTone(ditlen);
                        silence(ditlen);
                        break;
                    case 'dah':
                        playTone(ditlen * 3);
                        silence(ditlen);
                        break;
                    case 'letter':
                        //silence(fditlen * 3);
                        decoder.element(element);
                        break;
                    case 'word':
                        //silence(wditlen * 7);
                        decoder.element(element);
                        break;
                }
            }, tone => {
                switch (tone) {
                    case 'tone':
                        makeTone(true);
                        break;
                    case 'silent':
                        makeTone(false);
                        break;
                    case 'dit':
                    case 'dah':
                    case 'letter':
                    case 'word':
                        decoder.element(tone);
                        break;
                }
            });
            keyer.setMode(getKeyerMode());
            var debouncerLeft = Debouncer(pressed => keyer.key(_polarity == 'ditdah' ? 'dit' : 'dah', pressed));
            var debouncerRight = Debouncer(pressed => keyer.key(_polarity == 'ditdah' ? 'dah' : 'dit', pressed));

            var canvas;

            var ui = {
                dialog: null,
                playing: false,
                keying: false,
                keyingComplete: false,
                hide: (getBoolSetting('rx_hide_phrase', false)),
                progress: false,
                count: 0,
                buttons: [],
                dialog: { left: 0, right: 0, top: 0, bottom: 0 },
                speed: 20,
                farnsworth: 5,
                wordsworth: 5,
            };

            function trace(message) {
                //alert(message);
            }

            var audioCtx;
            var toneGain;
            var toneOscillator;
            var dingGain;
            var dingOscillator;
            var audioStarted = false;
            function audio() {
                if (!audioStarted) {
                    audioCtx = new (AudioContext || webkitAudioContext)();
                    toneOscillator = audioCtx.createOscillator();
                    dingOscillator = audioCtx.createOscillator();
                    toneOscillator.frequency.value = getPitch();
                    dingOscillator.frequency.value = 1500;
                    toneGain = audioCtx.createGain();
                    dingGain = audioCtx.createGain();
                    toneGain.gain.value = 0;
                    dingGain.gain.value = 0;
                    toneOscillator.connect(toneGain);
                    dingOscillator.connect(dingGain);
                    toneGain.connect(audioCtx.destination);
                    dingGain.connect(audioCtx.destination);
                    toneOscillator.start(0);
                    dingOscillator.start(0);
                    audioStarted = true;
                    say('');
                }
                return audioCtx.currentTime;
            }

            var t = 0;
            function stopAudio() {
                if (audioStarted) {
                    audioCtx.close();
                    t = 0;
                    audioStarted = false;
                }
            }

            const ramp = 0.005;
            function makeTone(on) {
                var c = audio();
                t = c > t ? c : t;
                toneGain.gain.setTargetAtTime(on ? 1 : 0, t, ramp);
            }

            function playTone(len) {
                makeTone(true);
                t += len;
                toneGain.gain.setTargetAtTime(0, t, ramp);
            }

            function silence(len) {
                t += len;
            }

            function convertPhrase(phrase) {
                var split = phrase.split('|');
                return split[0].replace(/#/g, '');
            }

            function overscoreProsigns(phrase) {
                //return phrase.replace(/\<(.)/g, '$1̅').replace(/\>/g, '̅');
                return phrase.replace(/\</g, '⟨').replace(/\>/g, '⟩');
            }

            function convertUtterance(utterance) {
                var utter = '';
                var numberMode = false;
                for (var i in utterance) {
                    var c = utterance[i];
                    if (c == '|') {
                        utter += ', ' + utterance.substring(utterance.indexOf('|') + 1);
                        break;
                    }
                    switch (c) {
                        case '#':
                            numberMode = true;
                            break;
                        case ' ':
                            numberMode = false;
                            utter += ' ';
                            break;
                        default:
                            if (c == c.toUpperCase() && (!numberMode || c < '0' || c > '9')) {
                                var spell = {
                                    'A': 'alfa',
                                    'B': 'bravo',
                                    'C': 'charlie',
                                    'D': 'delta',
                                    'E': 'echo',
                                    'F': 'foxtrot',
                                    'G': 'golf',
                                    'H': 'hotel',
                                    'I': 'india',
                                    'J': 'juliet',
                                    'K': 'key-low', // kilo
                                    'L': 'lee-ma', // lima
                                    'M': 'mike',
                                    'N': 'november',
                                    'O': 'oscar',
                                    'P': 'papa',
                                    'Q': 'quebec',
                                    'R': 'romeo',
                                    'S': 'sierra',
                                    'T': 'tango',
                                    'U': 'uniform',
                                    'V': 'victor',
                                    'W': 'whiskey',
                                    'X': 'x-ray',
                                    'Y': 'yanky',
                                    'Z': 'zulu',
                                    '1': 'one',
                                    '2': 'two',
                                    '3': 'three', // tree?
                                    '4': 'four', // fower?
                                    '5': 'five', // fife?
                                    '6': 'six',
                                    '7': 'seven',
                                    '8': 'eight',
                                    '9': 'niner',
                                    '0': 'zero',
                                    '?': 'question mark',
                                    '.': 'full stop',
                                    ',': 'comma',
                                    ':': 'colon',
                                    '-': 'dash',
                                    ';': 'semicolon',
                                    '!': 'exclamation point',
                                    '/': 'slash',
                                    "'": 'apostrophe',
                                    '"': 'quotation mark',
                                    '_': 'underscore',
                                    '=': 'double dash',
                                    '&': 'ampersand',
                                    '$': 'dollar sign',
                                    '(': 'left parenthesis',
                                    ')': 'right parenthesis',
                                    '+': 'plus',
                                    '@': 'at sign',
                                    '<': ' ', // nothing
                                    '>': 'pro-sign',
                                }[c];
                                utter += ' ' + (spell || c) + ' ';
                            } else {
                                utter += c;
                            }
                            break;
                    }
                }
                return utter;
            }

            function say(utterance) {
                if ('speechSynthesis' in window) {
                    speechSynthesis.speak(new SpeechSynthesisUtterance(utterance));
                }
            }

            var dinglen = 2.5;
            function playDing() {
                var c = audio();
                var dingt = c > t ? c : t;
                dingGain.gain.linearRampToValueAtTime(0.2, dingt + 0.005);
                dingGain.gain.exponentialRampToValueAtTime(0.000001, dingt + dinglen);
            }

            var morse = "  ETIANMSURWDKGOHVFÜL PJBXCYZQ  54 3   2& +    16=/   ( 7   8 90     $      ?_    \"  .    @   '  -        ;! )     ,    :";
            var playContinuation = function() {};
            var continuationTimeout0 = null;
            var continuationTimeout1 = null;

            function stopPhrase() {
                playContinuation = function() {};
                if (continuationTimeout0) clearTimeout(continuationTimeout0);
                if (continuationTimeout1) clearTimeout(continuationTimeout1);
            }

            var shuffleCache = {};
            function randomPhrase(index, len) {
                if (getScramble()) {
                    var id = 'rx_shuffle_' + getContent().id;
                    var shuffle = shuffleCache[id];
                    if (shuffle == null)
                    {
                        shuffle = localStorage.getItem(id);
                        if (shuffle != null) {
                            try {
                                shuffle = JSON.parse(shuffle);
                            } catch { }
                        }
                    }
                    if (shuffle == null || shuffle.length != len) {
                        shuffle = [];
                        for (var i = 0; i < len; i++) { shuffle.push(i); }
                        for (var i = len - 1; i > 0; i--)
                        {
                            var r = Math.floor(Math.random() * i); // swap with random
                            var t = shuffle[r];
                            shuffle[r] = shuffle[i];
                            shuffle[i] = t;
                        }
                        localStorage.setItem(id, JSON.stringify(shuffle));
                        shuffleCache[id] = shuffle;
                    }
                    return shuffle[index];
                } else {
                    return index;
                }
            }

            function getCurrentPhrase() {
                var phrases = getContent().lessons[getLessonNum()].phrases;
                var phraseIndex = randomPhrase(getPhraseNum(), phrases.length);
                return phrases[phraseIndex]
            }

            function encodePhrase(phrase) {
                function trim(str) { return str.endsWith(' ') ? str.substring(0, str.length - 1) : str; }
                var prosign = false;
                var code = '';
                for (var i in phrase) {
                    var c = phrase[i];
                    if (c == ' ') { // word break
                        code = trim(code) + '/';
                    } else {
                        if (c == '<') prosign = true;
                        if (c == '>') prosign = false;
                        var letter = '';
                        var j = morse.indexOf(c.toUpperCase());
                        while (j > 1) {
                            if (j % 2 == 0) {
                                letter = '.' + letter;
                                j /= 2;
                            } else {
                                letter = '-' + letter;
                                j = (j - 1) / 2;
                            }
                        }
                        code += letter;
                        if (!prosign) {
                            code += ' ';
                        }
                    }
                }
                return trim(code);
            }

            function playCode(code) {
                function continuation(j) {
                    if (code.length > j) {
                        var continueCode = code.substring(j);
                        continuationTimeout0 = setTimeout(
                            function() { playCode(continueCode); },
                            (t - startTime) * 1000);
                    }
                }
                var startTime = audio();
                for (var i = 0; i < code.length; i++) {
                    switch (code[i]) {
                        case '.':
                            playTone(ditlen);
                            silence(ditlen);
                            break;
                        case '-':
                            playTone(ditlen * 3);
                            silence(ditlen);
                            break;
                        case ' ':
                            ui.count++;
                            redraw();
                            silence(fditlen * 3);
                            continuation(i + 1);
                            return;
                        case '/':
                            ui.count += 2;
                            redraw();
                            silence(wditlen * 7);
                            continuation(i + 1);
                            return;
                    }
                }
                ui.count += 2;
                redraw();
            }

            function saveHiddenState() {
                localStorage.setItem('rx_hide_phrase', ui.hide);
            }

            function playPhrase(phrase, speakAndAdvance) {
                function codeMilliseconds(code) {
                    var s = 0;
                    for (var i = 0; i < code.length; i++) {
                        switch (code[i]) {
                            case '.':
                                s += ditlen * 2;
                                break;
                            case '-':
                                s += ditlen * 4;
                                break;
                            case ' ':
                                s += fditlen * 3;
                                break;
                            case '/':
                                s += wditlen * 7;
                                break;
                        }
                    }
                    return s * 1000;
                }
                if (speakAndAdvance && !ui.hide) {
                    ui.hide = true;
                    saveHiddenState();
                    redraw();
                }
                var code = encodePhrase(convertPhrase(phrase));
                playCode(code);
                const trainingSpeechPause = 2000;
                const trainingSpeechCharacterPause = 130;
                var delay = codeMilliseconds(code);
                if (speakAndAdvance) {
                    continuationTimeout1 = setTimeout(
                        function () {
                            if (ui.playing) {
                                if (!ui.progress) playDing();
                                continuationTimeout1 = setTimeout(
                                    function () {
                                        if (ui.playing) {
                                            ui.hide = false;
                                            saveHiddenState();
                                            redraw();
                                            var utter = convertUtterance(getCurrentPhrase());
                                            say(utter);
                                            continuationTimeout1 = setTimeout(
                                                function () {
                                                    if (ui.playing) {
                                                        if (nextPhrase()) {
                                                            ui.count = 0;
                                                            var play = function() { playPhrase(getCurrentPhrase(), speakAndAdvance, false) };
                                                            if (ui.progress) {
                                                                continuationTimeout1 = setTimeout(play, fditlen * 3 * 1000);
                                                            } else {
                                                                play();
                                                            }
                                                        } else {
                                                            say('lesson complete');
                                                            ui.keying = ui.playing = ui.hide = false;
                                                            saveHiddenState();
                                                            noSleep.disable();
                                                            nextLesson();
                                                        }
                                                        redraw();
                                                    }
                                                },
                                                (ui.progress ? 0 : trainingSpeechPause) + utter.length * trainingSpeechCharacterPause);
                                        }
                                    },
                                    ui.progress ? 0 : trainingSpeechPause);
                            }
                        },
                        delay + ditlen * 7 * 1000); // not farnsworth/wordsworth at end, just 7*ditlen
                } else {
                    continuationTimeout1 = setTimeout(
                        function () {
                            if (ui.playing) {
                                ui.keying = ui.playing = false;
                                noSleep.disable();
                                redraw();
                            }
                        },
                        delay);

                }
            }

            function getContent() {
                var id = localStorage.getItem('rx_content');
                var content = library.find(c => c.id == id);
                if (content) return content;
                var dflt = library[0];
                localStorage.setItem('rx_content', dflt.id);
                return dflt;
            }

            function setContent(id) {
                localStorage.setItem('rx_content', id);
            }

            function getLessonNum() {
                var content = getContent();
                var id = localStorage.getItem('rx_lesson_' + content.id);
                if (id) {
                    for (var i = 0; i < content.lessons.length; i++) {
                        if (content.lessons[i].id == id) return i;
                    }
                    trace('Missing lesson: ' + id);
                    localStorage.setItem('rx_lesson_' + content.id, content.lessons[0].id);
                }
                return 0;
            }

            function setLessonNum(num) {
                var content = getContent();
                var key = 'rx_lesson_' + content.id;
                var id = content.lessons[num].id;
                if (localStorage.getItem(key) != id) {
                    localStorage.setItem(key, id);
                    localStorage.removeItem('rx_shuffle_' + content.id); // force rescramble
                }
            }

            function setLesson(id) {
                var lessons = getContent().lessons;
                for (var i = 0; i < lessons.length; i++) {
                    if (lessons[i].id == id) {
                        setLessonNum(i);
                        setPhraseNum(0);
                        return;
                    }
                }
            }

            function getIntSetting(name, dflt) {
                return parseInt(localStorage.getItem(name) || dflt);
            }

            function getBoolSetting(name, dflt) {
                return localStorage.getItem(name) === 'true' || dflt;
            }

            function getPhraseNum() {
                var content = getContent();
                var phrase = getIntSetting('rx_phrase_' + content.id, 0);
                if (phrase >= 0 && phrase < content.lessons[getLessonNum()].phrases.length) return phrase;
                trace('Missing phrase: ' + phrase);
                localStorage.setItem('rx_phrase_' + content.id, 0);
                return 0;
            }

            function setPhraseNum(num) {
                var content = getContent();
                localStorage.setItem('rx_phrase_' + content.id, num);
            }

            function getDarkMode() {
                return (localStorage.getItem('rx_ui_mode') || 'dark') == 'dark';
            }

            function setDarkMode(dark) {
                var val = dark ? 'dark' : 'light';
                localStorage.setItem('rx_ui_mode', val);
                localStorage.setItem('rx_ui_mode_default', val);
            }

            var ditlen;
            var fditlen;
            var wditlen;
            function computeSpeedVariables(wpm, farnsworth, wordsworth) {
                ditlen = 1.2 / wpm;
                fditlen = (60 / farnsworth - 31 * ditlen) / 19;
                wditlen = (60 / wordsworth - 31 * ditlen) / 19;
            }

            function setSpeed(wpm) {
                keyer.setSpeed(wpm);
                var speed = getSpeed();
                var farnsworth = getFarnsworth();
                if (wpm < farnsworth || speed == farnsworth)
                {
                    localStorage.setItem('rx_farnsworth', wpm); // farnsworth should track (when equal) and never be faster
                    localStorage.setItem('rx_farnsworth_default', wpm);
                }
                var wordsworth = getWordsworth();
                if (wpm < wordsworth || speed == wordsworth)
                {
                    localStorage.setItem('rx_wordsworth', wpm); // wordssworth should track (when equal) and never be faster
                    localStorage.setItem('rx_wordsworth_default', wpm);
                }
                localStorage.setItem('rx_speed', wpm);
                localStorage.setItem('rx_speed_default', wpm);
                computeSpeedVariables(wpm, getFarnsworth(), getWordsworth());
            }

            function getSpeed() {
                return getIntSetting('rx_speed', 25);
            }

            function setFarnsworth(farnsworthWpm) {
                if (farnsworthWpm > getSpeed())
                {
                    localStorage.setItem('rx_speed', farnsworthWpm); // farnsworth cannot be faster than WPM
                    localStorage.setItem('rx_speed_default', farnsworthWpm);
                }
                var wordsworth = getWordsworth();
                if (farnsworthWpm < wordsworth || getFarnsworth() == wordsworth)
                {
                    localStorage.setItem('rx_wordsworth', farnsworthWpm); // wordssworth should track (when equal) and never be faster
                    localStorage.setItem('rx_wordsworth_default', farnsworthWpm);
                }
                localStorage.setItem('rx_farnsworth', farnsworthWpm);
                localStorage.setItem('rx_farnsworth_default', farnsworthWpm);
                computeSpeedVariables(getSpeed(), farnsworthWpm, getWordsworth());
            }

            function getFarnsworth() {
                return getIntSetting('rx_farnsworth', 5);
            }

            function setWordsworth(wordsworthWpm) {
                if (wordsworthWpm > getSpeed())
                {
                    localStorage.setItem('rx_speed', wordsworthWpm); // wordsworth cannot be faster than WPM
                    localStorage.setItem('rx_speed_default', wordsworthWpm);
                }
                if (wordsworthWpm > getFarnsworth())
                {
                    localStorage.setItem('rx_farnsworth', wordsworthWpm); // wordsworth cannot be faster than farnsworth
                    localStorage.setItem('rx_farnsworth_default', wordsworthWpm);
                }
                localStorage.setItem('rx_wordsworth', wordsworthWpm);
                localStorage.setItem('rx_wordsworth_default', wordsworthWpm);
                computeSpeedVariables(getSpeed(), getFarnsworth(), wordsworthWpm);
            }

            function getWordsworth() {
                return getIntSetting('rx_wordsworth', 5);
            }

            function setPitch(hz) {
                localStorage.setItem('rx_pitch', hz);
                localStorage.setItem('rx_pitch_default', hz);
                if (audioStarted) toneOscillator.frequency.value = hz;
            }

            function getPitch() {
                return getIntSetting('rx_pitch', 650);
            }

            function setScramble(scramble) {
                localStorage.setItem('rx_scramble', scramble);
            }

            function getScramble() {
                return getBoolSetting('rx_scramble', false);
            }

            function setKeyerMode(mode) {
                keyer.setMode(mode);
                localStorage.setItem('tx_keyer', mode);
            }

            function getKeyerMode() {
                return localStorage.getItem('tx_keyer') || 'B';
            }

            function setPolarity(polarity) {
                _polarity = polarity;
                localStorage.setItem('tx_polarity', polarity);
            }


            function getPolarity() {
                return localStorage.getItem('tx_polarity') || 'ditdah';
            }

            function resizeCanvas() {
                var ratio = 1; // devicePixelRatio;
                var w = window.innerWidth;
                var h = window.innerHeight;
                canvas.width = w * ratio;
                canvas.height = h * ratio;
                canvas.style.width = w + 'px';
                canvas.style.height = h + 'px';
            }

            function redraw() {
                const phraseTextColor = '#f43'; // red
                const lessonTextColor = '#07d'; // blue
                const phraseNumTextColor = '#2c4'; // green
                const dimColor = '#000b';

                var darkMode = getDarkMode();
                var backgroundColor = darkMode ? '#111' : '#eee'; // black/white
                var foregroundColor = darkMode ? '#eee' : '#111'; // white/black
                var mainButtonColor = foregroundColor;
                var subduedButtonColor = darkMode ? '#ccc' : '#333'; // gray
                var disabledButtonColor = darkMode ? '#333' : '#ccc'; // gray
                var dialogBackgroundColor = darkMode ? '#222' : '#ddd';
                var dialogAttributionColor = darkMode ? '#444' : '#bbb';
                var keyedCharacterColor = darkMode ? '#fc0' : '#da0';

                var ctx = canvas.getContext('2d');
                ctx.scale(1, 1);
                var w = canvas.width;
                var h = canvas.height;

                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, w, h);
                document.body.style.backgroundColor = backgroundColor;

                function drawFittedText(txt, color, x, y, width, height, weight, actual, align, progress, count, overlay) {
                    txt = overscoreProsigns(txt.toString());
                    ctx.fillStyle = color;
                    //ctx.letterSpacing = "-0.02em"
                    function setFont(size) { ctx.font = weight + ' ' + size + 'px sans-serif' };
                    const sampleSize = 100;
                    setFont(sampleSize);
                    var size = ctx.measureText(txt);
                    var ascent = actual ? size.actualBoundingBoxAscent : size.fontBoundingBoxAscent;
                    var descent = actual ? size.actualBoundingBoxDescent : size.fontBoundingBoxDescent;
                    var textHeight = ascent + descent;
                    var textWidth = size.actualBoundingBoxLeft + size.actualBoundingBoxRight;
                    var scale = Math.min(width / textWidth, height / textHeight);
                    setFont(scale * sampleSize);
                    size = ctx.measureText(txt);
                    textWidth = size.actualBoundingBoxRight - size.actualBoundingBoxLeft;
                    var xx = x;
                    if (align == 'right') xx += (width - textWidth);
                    else if (align == 'center') xx += (width - textWidth) / 2;
                    ctx.fillText(txt, xx, y + ascent * scale + (height - textHeight * scale) / 2);
                    if (progress) {
                        ctx.fillStyle = overlay;
                        ctx.fillText(txt.substr(0, count), xx, y + ascent * scale + (height - textHeight * scale) / 2);
                    }
                }

                function fillRoundedRect(left, top, right, bottom, radius, color) {
                    ctx.beginPath();
                    ctx.moveTo(left + radius, top);
                    ctx.lineTo(right - radius, top);
                    ctx.arcTo(right, top, right, top + radius, radius);
                    ctx.lineTo(right, bottom - radius);
                    ctx.arcTo(right, bottom, right - radius, bottom, radius);
                    ctx.lineTo(left + radius, bottom);
                    ctx.arcTo(left, bottom, left, bottom - radius, radius);
                    ctx.lineTo(left, top + radius);
                    ctx.arcTo(left, top, left + radius, top, radius);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                }

                var padding = Math.min(canvas.width / 24, canvas.height / 24);

                var buttons = [];
                function drawButton(name, label, color, x, y, width, height, align, actual = true, weight = 'normal') {
                    drawFittedText(label, color, x, y, width, height, weight, actual, align);
                    var p = padding / 2;
                    buttons.push({
                        name: name,
                        left: x - p,
                        top: y - p,
                        right: x + width + p,
                        bottom: y + height + p })
                }

                const numButtons = 5;
                const largeButton = 1.5;
                var buttonWidth = (w - (numButtons + 1) * padding) / (numButtons + largeButton - 1);
                var buttonSize = Math.min(buttonWidth, canvas.width / 12, canvas.height / 12);

                var content = getContent();
                var lessonNum = getLessonNum();
                var phraseNum = getPhraseNum();

                drawButton(
                    'settings',
                    '⁝',
                    subduedButtonColor,
                    w - padding - buttonSize,
                    padding, buttonSize, buttonSize,
                    'right');
                drawButton(
                    'prevLesson',
                    '⇤',
                    lessonNum > 0 ? subduedButtonColor : disabledButtonColor,
                    padding * 1 + buttonWidth * 0,
                    h - padding - buttonSize,
                    buttonWidth, buttonSize,
                    'left');
                drawButton(
                    'prevPhrase',
                    '⟲',
                    phraseNum > 0 ? subduedButtonColor : disabledButtonColor,
                    padding * 2 + buttonWidth * 1,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize,
                    'center');
                drawButton(
                    'nextPhrase',
                    '⟳',
                    phraseNum < content.lessons[lessonNum].phrases.length - 1 ? subduedButtonColor : disabledButtonColor,
                    padding * 4 + buttonWidth * 2 + buttonWidth * largeButton,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize,
                    'center');
                drawButton(
                    'nextLesson',
                    '⇥',
                    lessonNum < content.lessons.length - 1 ? subduedButtonColor : disabledButtonColor,
                    padding * 5 + buttonWidth * 3 + buttonWidth * largeButton,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize,
                    'right');
                if (ui.keying && keyedCharacter.length > 0) {
                    drawButton(
                        'playPause',
                        keyedCharacter,
                        ui.keyingComplete ? foregroundColor : keyedCharacterColor,
                        padding * 2 + buttonWidth * 2,
                        h - padding - buttonSize * largeButton,
                        buttonWidth * largeButton + padding * 2,
                        buttonSize * largeButton,
                        'center',
                        true,
                        'bold');
                } else {
                    drawButton(
                        'playPause',
                        ui.playing ? 'II' : '▸',
                        foregroundColor,
                        padding * 3 + buttonWidth * 2,
                        h - padding - buttonSize * largeButton,
                        buttonWidth * largeButton,
                        buttonSize * largeButton,
                        'center');
                }
                ui.buttons = buttons;

                const progressHeight = Math.max(2, padding / 4);
                var lessonPercent = lessonNum/ content.lessons.length;
                var phraseCount = content.lessons[lessonNum].phrases.length;
                var phrasePercent = phraseNum / Math.max(1, phraseCount - 1);
                var lessonWidth = w * lessonPercent;
                ctx.fillStyle = lessonTextColor;
                ctx.fillRect(0, 0, lessonWidth, progressHeight);
                ctx.fillStyle = phraseNumTextColor;
                ctx.fillRect(lessonWidth, 0, (w - lessonWidth) * phrasePercent, progressHeight);

                drawButton(
                    'content',
                    '☰',
                    subduedButtonColor,
                    padding / 2,
                    padding + progressHeight,
                    buttonSize,
                    buttonSize,
                    'left');
                drawButton(
                    'lesson',
                    content.lessons[lessonNum].name,
                    lessonTextColor,
                    padding * 2 + buttonSize,
                    padding + progressHeight,
                    w - padding * 5 - buttonSize * 3,
                    buttonSize,
                    'left');
                drawButton(
                    'phraseNum',
                    phraseCount - phraseNum,
                    phraseNumTextColor,
                    w - padding * 2 - buttonSize * 2,
                    padding + progressHeight,
                    buttonSize,
                    buttonSize,
                    'right');
                var phraseX = padding;
                var phraseY = buttonSize + padding * 2 + progressHeight;
                var phraseWidth = w - padding * 2;
                var phraseHeight = h - padding * 4 - progressHeight - buttonSize - buttonSize * largeButton;
                var phraseIndex = randomPhrase(phraseNum, content.lessons[lessonNum].phrases.length);
                var phrase = convertPhrase(content.lessons[lessonNum].phrases[phraseIndex]);
                if (ui.keying) phrase = phrase.replace(/\ /g, '⎵');
                if ((ui.keying || ui.playing) && ui.progress && phrase.length > ui.count) {
                    if (phrase[ui.count - 1] == '<' || phrase[ui.count - 2] == '<') {
                        while (phrase[ui.count++] != '>');
                    }
                    drawFittedText(
                        phrase,
                        disabledButtonColor,
                        phraseX,
                        phraseY,
                        phraseWidth,
                        phraseHeight,
                        'bold',
                        false,
                        'center',
                        true,
                        ui.count,
                        phraseTextColor);
                } else {
                    drawFittedText(
                        ui.hide && !ui.progress ? '?' : phrase, 
                        ui.hide && !ui.progress ? disabledButtonColor : phraseTextColor,
                        phraseX,
                        phraseY,
                        phraseWidth,
                        phraseHeight,
                        'bold',
                        false,
                        'center');
                }
                ui.buttons.push({
                    name: 'phrase',
                    left: phraseX - padding,
                    top: phraseY - padding,
                    right: phraseWidth + padding,
                    bottom: phraseHeight + padding })
                if (ui.show == 'settings') {
                    ctx.fillStyle = dimColor;
                    ctx.fillRect(0, 0, w, h);
                    var settingRows = 8;
                    var left = padding * (w > h ? 4 : 1);
                    var right = w - padding * (w > h ? 4 : 1);
                    var top = padding * (h > w ? 4 : 1);
                    var approximateBottom = Math.min(h - top + padding, top + buttonSize * settingRows + padding * (settingRows + 1));
                    var rowHeight = (approximateBottom - top - padding * 2) / settingRows;
                    var bottom = top + padding + rowHeight * settingRows;
                    ui.dialog = {
                        left: left,
                        right: right,
                        top: top,
                        bottom: bottom
                    };
                    fillRoundedRect(left, top, right, bottom, padding, dialogBackgroundColor);
                    controlLeft = right - padding - buttonSize * 4;
                    const switchThinFactor = 1.1;
                    function drawSwitch(name, label, switchText, on, top) {
                        drawFittedText(
                            label,
                            subduedButtonColor,
                            left + padding,
                            top + padding,
                            controlLeft - left - padding * 2,
                            buttonSize,
                            'normal',
                            false,
                            'left');
                        fillRoundedRect(
                            controlLeft + padding * 2 * switchThinFactor,
                            top + padding * switchThinFactor,
                            right - padding * 2 * switchThinFactor - padding,
                            top + padding / switchThinFactor + buttonSize,
                            buttonSize / switchThinFactor / 2,
                            subduedButtonColor);
                        ctx.beginPath();
                        ctx.arc(
                            (on ? right - padding * 3 - buttonSize : controlLeft + padding * 2) + buttonSize / 2,
                            top + padding + buttonSize / 2,
                            buttonSize / 2,
                            0,
                            2 * Math.PI,
                            false);
                        ctx.fillStyle = backgroundColor;
                        ctx.fill();
                        ctx.lineWidth = padding / 10;
                        ctx.strokeStyle = subduedButtonColor;
                        ctx.stroke();
                        var margin = buttonSize / 4;
                        drawFittedText(
                            switchText,
                            subduedButtonColor,
                            (on ? right - padding * 3 - buttonSize : controlLeft + padding * 2) + margin,
                            top + padding + margin,
                            buttonSize - margin * 2,
                            buttonSize - margin * 2,
                            'normal',
                            true,
                            'center');
                        buttons.push({
                            name: name,
                            left: controlLeft,
                            top: top,
                            right: right,
                            bottom: top + rowHeight })
                    }
                    var dark = getDarkMode();
                    drawSwitch('mode', 'Light/Dark:', dark ? '☽' : '☼', dark, top);
                    function drawGenericUpDownControl(label, name, val, showMin, showMax, row) {
                        drawFittedText(
                            label,
                            subduedButtonColor,
                            left + padding,
                            row,
                            controlLeft - left - padding * 2,
                            buttonSize,
                            'normal',
                            false,
                            'left');
                        const arrowScale = 0.5;
                        drawFittedText(
                            '❰',
                            showMin ? subduedButtonColor : disabledButtonColor,
                            controlLeft,
                            row + (buttonSize * arrowScale / 2),
                            buttonSize * arrowScale,
                            buttonSize * arrowScale,
                            'normal',
                            true,
                            'center');
                        if (showMin) {
                            buttons.push({
                                name: name + 'Down',
                                left: controlLeft,
                                top: row,
                                right: controlLeft + buttonSize,
                                bottom: row + rowHeight
                            });
                        }
                        drawButton(
                            name,
                            val,
                            subduedButtonColor,
                            controlLeft + buttonSize,
                            row + 3,
                            buttonSize * 2,
                            buttonSize - 6,
                            'center')
                        drawFittedText(
                            '❱',
                            showMax ? subduedButtonColor : disabledButtonColor,
                            controlLeft + buttonSize * 3 + buttonSize * arrowScale,
                            row + (buttonSize * arrowScale / 2),
                            buttonSize * arrowScale,
                            buttonSize * arrowScale,
                            'normal',
                            true,
                            'center');
                        if (showMax) {
                            buttons.push({
                                name: name + 'Up',
                                left: controlLeft + buttonSize * 2,
                                top: row,
                                right: controlLeft + buttonSize * 4,
                                bottom: row + rowHeight });
                        }
                    }
                    function drawUpDownControl(label, name, val, min, max, row) {
                        drawGenericUpDownControl(label, name, val, val >= min, val <= max, row)
                    }
                    drawUpDownControl('Speed:', 'speed', getSpeed(), 5, 50, top + padding + rowHeight);
                    drawUpDownControl('Farnsworth:', 'farnsworth', getFarnsworth(), 1, 50, top + padding + rowHeight * 2);
                    drawUpDownControl('Wordsworth:', 'wordsworth', getWordsworth(), 1, 50, top + padding + rowHeight * 3);
                    drawUpDownControl('Pitch:', 'pitch', getPitch(), 100, 900, top + padding + rowHeight * 4);
                    var scramble = getScramble();
                    drawSwitch('scramble', 'Scramble:', scramble ? 'on' : 'off', scramble, top + rowHeight * 5);
                    var keyer = getKeyerMode();
                    var keyerName = keyer == 'A' ? 'Iambic A' : keyer == 'B' ? 'Iambic B' : keyer == 'U' ? 'Ultimatic' : 'Straight';
                    drawGenericUpDownControl('Keyer:', 'keyer', keyerName, true, true, top + padding + rowHeight * 6);
                    var polarity = getPolarity() == 'ditdah' ? 'Left Dit' : 'Right Dit';
                    drawGenericUpDownControl('Polarity:', 'polarity', polarity, true, true, top + padding + rowHeight * 7);
                    ui.buttons = buttons;
                }
                function drawMenu(len, fnGetId, fnGetName, color) {
                    ctx.fillStyle = dimColor;
                    ctx.fillRect(0, 0, w, h);
                    var left = padding * (w > h ? 4 : 1);
                    var right = w - padding * (w > h ? 4 : 1);
                    var top = padding * (h > w ? 4 : 1);
                    var bottom = h - padding * (h > w ? 4 : 1) - padding;
                    var rowHeight = (bottom - top - padding * 2) / len;
                    if (rowHeight > buttonSize + padding * 2) {
                        rowHeight = buttonSize + padding * 2;
                        bottom = top + padding * 2 + rowHeight * len;
                    }
                    ui.dialog = {
                        left: left,
                        right: right,
                        top: top,
                        bottom: bottom
                    };
                    var rowWidth = right - left - padding * 2;
                    fillRoundedRect(left, top, right, bottom, padding, dialogBackgroundColor);
                    for (var i = 0; i < len; i++) {
                        drawButton(
                            'menu_' + fnGetId(i),
                            fnGetName(i),
                            color,
                            left + padding,
                            top + padding + rowHeight * i,
                            rowWidth,
                            rowHeight,
                            'left',
                            false)
                    }
                }
                switch (ui.show) {
                    case 'content':
                        drawMenu(library.length, i => library[i].id, i => library[i].name, subduedButtonColor);
                        break;
                    case 'lesson':
                        var lessons = content.lessons;
                        drawMenu(lessons.length, i => lessons[i].id, i => lessons[i].name, lessonTextColor);
                        break;
                    case 'phrase':
                        //var phrases = content.lessons[lessonNum].phrases;
                        //drawMenu(phrases.length, p => p, p => (p + 1) + ' ' + phrases[p]);
                        break;
                }
            }

            function prevLesson() {
                var lesson = getLessonNum();
                if (lesson > 0) setLessonNum(lesson - 1);
                setPhraseNum(0);
            }

            function nextLesson() {
                var lesson = getLessonNum();
                if (lesson < getContent().lessons.length - 1) setLessonNum(lesson + 1);
                setPhraseNum(0);
            }

            function prevPhrase() {
                ui.count = 0;
                var phrase = getPhraseNum();
                if (phrase > 0) setPhraseNum(phrase - 1);
            }

            function nextPhrase() {
                ui.count = 0;
                var phrase = getPhraseNum();
                if (phrase < getContent().lessons[getLessonNum()].phrases.length - 1) {
                    setPhraseNum(phrase + 1);
                    return true;
                }
                return false;
            }

            function dismissDialog(x, y) {
                if (x < ui.dialog.left || x > ui.dialog.right || y < ui.dialog.top || y > ui.dialog.bottom) {
                    ui.show = null;
                    redraw();
                    return true;
                }
                return false;
            }

            function selectDialogMenu(x, y, fnSelect) {
                if (dismissDialog(x, y)) return;
                for (var b = ui.buttons.length - 1; b >= 0; b--) {
                    var button = ui.buttons[b];
                    if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                        fnSelect(button.name.substring(5)); // sans 'menu_'
                        ui.show = null;
                        redraw();
                        return;
                    }
                }
            }

            function playV(n) {
                stopPhrase();
                continuationTimeout0 = setTimeout(function() {
                    playTone(ditlen); // dit
                    continuationTimeout0 = setTimeout(function() {
                        playTone(ditlen); // dit
                        continuationTimeout0 = setTimeout(function() {
                            playTone(ditlen); // dit
                            continuationTimeout0 = setTimeout(function() {
                                playTone(ditlen * 3); // dah
                                if (n > 1) {
                                    continuationTimeout0 = setTimeout(function() {
                                        playV(n - 1);
                                    }, ditlen * 3000 + wditlen * 7000);
                                }
                            }, ditlen * 2000);
                        }, ditlen * 2000);
                    }, ditlen * 2000);
                }, 550); // small delay to allow for quick succession with cancelability (and repeate timeout to start)
            }

            function touch(x, y) {
                if (ui.show == 'settings') {
                    if (dismissDialog(x, y)) return;
                    for (var b = 0; b < ui.buttons.length; b++) {
                        var button = ui.buttons[b];
                        if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                            switch (button.name) {
                                case 'mode':
                                    cancelRepeat();
                                    setDarkMode(!getDarkMode());
                                    redraw();
                                    return;
                                case 'speed':
                                    cancelRepeat();
                                    playV(1);
                                    return;
                                case 'speedUp':
                                    setSpeed(getSpeed() + 1);
                                    redraw();
                                    playV(1);
                                    return;
                                case 'speedDown':
                                    setSpeed(getSpeed() - 1);
                                    redraw();
                                    playV(1);
                                    return;
                                case 'farnsworth':
                                    cancelRepeat();
                                    playV(2);
                                    return;
                                case 'farnsworthUp':
                                    setFarnsworth(getFarnsworth() + 1);
                                    redraw();
                                    playV(2);
                                    return;
                                case 'farnsworthDown':
                                    setFarnsworth(getFarnsworth() - 1);
                                    redraw();
                                    playV(2);
                                    return;
                                case 'wordsworth':
                                    cancelRepeat();
                                    playV(2);
                                    return;
                                case 'wordsworthUp':
                                    setWordsworth(getWordsworth() + 1);
                                    redraw();
                                    playV(2);
                                    return;
                                case 'wordsworthDown':
                                    setWordsworth(getWordsworth() - 1);
                                    redraw();
                                    playV(2);
                                    return;
                                case 'pitch':
                                    cancelRepeat();
                                    playV(1);
                                    return;
                                case 'pitchUp':
                                    setPitch(getPitch() + 10);
                                    redraw();
                                    playV(1);
                                    return;
                                case 'pitchDown':
                                    setPitch(getPitch() - 10);
                                    redraw();
                                    playV(1);
                                    return;
                                case 'scramble':
                                    cancelRepeat();
                                    setScramble(!getScramble());
                                    redraw();
                                    return;
                                case 'keyer':
                                    return;
                                case 'keyerUp':
                                    switch (getKeyerMode()) {
                                        case 'A':
                                            setKeyerMode('B');
                                            break;
                                        case 'B':
                                            setKeyerMode('U');
                                            break;
                                        case 'U':
                                            setKeyerMode('S');
                                            break;
                                        case 'S':
                                            setKeyerMode('A');
                                            break;
                                    }
                                    redraw();
                                    return;
                                case 'keyerDown':
                                    switch (getKeyerMode()) {
                                        case 'A':
                                            setKeyerMode('S');
                                            break;
                                        case 'B':
                                            setKeyerMode('A');
                                            break;
                                        case 'U':
                                            setKeyerMode('B');
                                            break;
                                        case 'S':
                                            setKeyerMode('U');
                                            break;
                                    }
                                    redraw();
                                    return;
                                case 'polarity':
                                    return;
                                case 'polarityUp':
                                case 'polarityDown':
                                    switch (getPolarity()) {
                                        case 'ditdah':
                                            setPolarity('dahdit');
                                            break;
                                        case 'dahdit':
                                            setPolarity('ditdah');
                                            break;
                                    }
                                    redraw();
                                    return;
                            }
                        }
                    }
                } else if (ui.show == 'content') {
                    selectDialogMenu(x, y, c => setContent(c));
                    return;
                } else if (ui.show == 'lesson') {
                    selectDialogMenu(x, y, c => setLesson(c));
                    return;
                } else if (ui.show == 'phrase') {
                    selectDialogMenu(x, y, c => setPhraseNum(c));
                    return;
                } else {
                    for (var b in ui.buttons) {
                        var button = ui.buttons[b];
                        if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                            switch (button.name) {
                                case 'settings':
                                    cancelRepeat();
                                    stopPhrase();
                                    ui.keying = ui.playing = false;
                                    ui.count = 0;
                                    noSleep.disable();
                                    ui.show = 'settings';
                                    redraw();
                                    return;
                                case 'content':
                                    cancelRepeat();
                                    stopPhrase();
                                    ui.keying = ui.playing = ui.hide = false;
                                    saveHiddenState();
                                    noSleep.disable();
                                    ui.show = 'content';
                                    redraw();
                                    return;
                                case 'lesson':
                                    cancelRepeat();
                                    stopPhrase();
                                    ui.keying = ui.playing = ui.hide = false;
                                    saveHiddenState();
                                    noSleep.disable();
                                    ui.show = 'lesson';
                                    redraw();
                                    return;
                                case 'phraseNum':
                                    cancelRepeat();
                                    stopPhrase();
                                    ui.keying = ui.playing = ui.hide = false;
                                    saveHiddenState();
                                    noSleep.disable();
                                    ui.show = 'phrase';
                                    redraw();
                                    return;
                                case 'phrase':
                                    cancelRepeat();
                                    if (ui.playing) {
                                        ui.progress = !ui.progress;
                                    } else {
                                        if (ui.hide) {
                                            ui.hide = false;
                                            saveHiddenState();
                                        } else {
                                            stopPhrase();
                                            ui.playing = true;
                                            ui.keying = false;
                                            noSleep.enable();
                                            ui.progress = true;
                                            ui.count = 0;
                                            playPhrase(getCurrentPhrase(), false);
                                        }
                                    }
                                    redraw();
                                    return;
                                case 'playPause':
                                    if (!ui.keying) {
                                        cancelRepeat();
                                        ui.hide = !(!ui.hide || ui.progress); // show if already unhidden or in progress
                                        saveHiddenState();
                                        ui.progress = false;
                                        ui.count = 0;
                                        stopPhrase();
                                        ui.keying = ui.playing = !ui.playing;
                                        if (ui.playing) noSleep.enable(); else noSleep.disable();
                                        if (ui.playing) {
                                            playPhrase(getCurrentPhrase(), true);
                                        }
                                    }
                                    ui.keying = false;
                                    redraw();
                                    return;
                                case 'prevLesson':
                                    cancelRepeat();
                                    stopPhrase();
                                    ui.keying = ui.playing = ui.hide = false;
                                    saveHiddenState();
                                    noSleep.disable();
                                    prevLesson();
                                    redraw();
                                    return;
                                case 'nextLesson':
                                    cancelRepeat();
                                    stopPhrase();
                                    ui.keying = ui.playing = ui.hide = false;
                                    saveHiddenState();
                                    noSleep.disable();
                                    nextLesson();
                                    redraw();
                                    return;
                                case 'prevPhrase':
                                    stopPhrase();
                                    ui.keying = ui.playing = ui.hide = false;
                                    saveHiddenState();
                                    noSleep.disable();
                                    prevPhrase();
                                    redraw();
                                    return;
                                case 'nextPhrase':
                                    stopPhrase();
                                    ui.keying = ui.playing = ui.hide = false;
                                    saveHiddenState();
                                    noSleep.disable();
                                    nextPhrase();
                                    redraw();
                                    return;
                            }
                        }
                    }
                }
            }

            var repeatTimer = null;
            function cancelRepeat() {
                if (repeatTimer != null) clearTimeout(repeatTimer);
            }

            function repeatTouch(x, y) {
                cancelRepeat(); // in case touchend was lost somehow
                repeatTimer = setTimeout(function() {
                    repeatTimer = setInterval(function() { touch(x, y); redraw(); }, 150);
                }, 350);
                touch(x, y);
            }

            function simulateTouchButton(name, repeat) {
                for (var b = 0; b < ui.buttons.length; b++) {
                    var button = ui.buttons[b];
                    if (button.name == name) {
                        var x = button.left + (button.right - button.left) / 2;
                        var y = button.top + (button.bottom - button.top) / 2;
                        if (repeat) repeatTouch(x, y); else touch(x, y);
                        return;
                    }
                }
            }

            var noSleep;
            onload = function() {
                noSleep = new NoSleep();
                //noSleep.enable = function() {};
                //noSleep.disable = function() {};
                if (location.hash.length > 0)
                {
                    var hash = decodeURIComponent(location.hash.substr(1));
                    var phrases = hash.split('|');
                    library.push(
                        { id: '_dynamic',
                          name: 'Custom Content',
                          lessons: [
                          { id: 'CUST0',
                            name: 'Custom',
                            phrases: phrases}]});
                    if (localStorage.getItem('rx_lasthash') != hash) {
                        localStorage.setItem('rx_lasthash', hash);
                        localStorage.setItem('rx_content', '_dynamic');
                    }
                }
                if (location.search == '?clear-settings') localStorage.clear();
                var ratio = 1; // devicePixelRatio;
                canvas = document.getElementById('canvas');
                var firstPress = true;
                var noTouch = true; // until first event
                canvas.ontouchstart = function(e) {
                    noTouch = false;
                    if (!firstPress) {
                        e.preventDefault();
                        var p = e.touches[0];
                        repeatTouch(p.pageX * ratio, p.pageY * ratio);
                    }
                };
                canvas.onmousedown = function(e) {
                    // audio and speech must be enabled during first user interaction
                    // and ontouchstart doesn't seem to count, so first touch does this
                    // and repeating doesn't work. Thereafter, ontouchstart takes over.
                    var x = e.x * ratio;
                    var y = e.y * ratio;
                    if (firstPress) {
                        firstPress = false;
                        say('');
                        audio();
                        repeatTouch(x, y);
                        return;
                    }
                    if (noTouch)
                    {
                        repeatTouch(x, y);
                    }
                }
                canvas.ontouchend = function(e) { cancelRepeat(); };
                canvas.onmouseup = function(e) { cancelRepeat(); }
                resizeRedrawCanvas();
                setDarkMode(getDarkMode());
                setSpeed(getSpeed());
                setFarnsworth(getFarnsworth());
                setWordsworth(getWordsworth());
                document.onvisibilitychange = function(e) {
                    if (document.hidden) {
                        cancelRepeat();
                        stopPhrase();
                        stopAudio();
                        ui.keying = ui.playing = false;
                        ui.count = 0;
                        noSleep.disable();
                        redraw();
                    }
                };
                window.onblur = function(e) {
                    cancelRepeat();
                }

                document.body.addEventListener('keydown', (e) => {
                    if (!e.repeat) {
                        switch (e.code) {
                            case 'BracketLeft':
                            case 'ControlLeft':
                                if (!ui.playing) debouncerLeft.key(true);
                                break;
                            case 'BracketRight':
                            case 'ControlRight':
                                if (!ui.playing) debouncerRight.key(true);
                                break;
                            case 'ArrowLeft':
                                simulateTouchButton(e.shiftKey ? 'prevLesson' : 'prevPhrase', true);
                                break;
                            case 'ArrowRight':
                                simulateTouchButton(e.shiftKey ? 'nextLesson' : 'nextPhrase', true);
                                break;
                            case 'Enter':
                                simulateTouchButton('playPause', false);
                                break;
                        }
                    }
                });

                document.body.addEventListener('keyup', (e) => {
                    if (!e.repeat) {
                        switch (e.code) {
                            case 'BracketLeft':
                            case 'ControlLeft':
                                if (!ui.playing) debouncerLeft.key(false);
                                break;
                            case 'BracketRight':
                            case 'ControlRight':
                                if (!ui.playing) debouncerRight.key(false);
                                break;
                            case 'ArrowLeft':
                            case 'ArrowRight':
                            case 'Space':
                                cancelRepeat();
                                break;
                        }
                    }
                });
            }

            function resizeRedrawCanvas() {
                resizeCanvas();
                redraw();
            }

            onresize = function() {
                resizeRedrawCanvas();
                for (var i = 0; i < 500; i += 50) {
                    setTimeout(resizeRedrawCanvas, i); // repeatedly because of browser timing bug! (https://bugs.webkit.org/show_bug.cgi?id=185886)
                }
            }
        </script>
    </head>
    <body class="dark">
        <div id="trace" style="color: white"></div>
        <canvas id="canvas"></canvas>
    </body>
    <!--
        TODO:
        - Phrase picker?

        Local Storage:
        - 'rx_content'
        - 'rx_lesson_<ID>' (within content)
        - 'rx_phrase_<ID>' (within lesson)
        - 'rx_ui.mode' ('light'/'dark')
        - 'rx_ui.mode_default' ('light'/'dark')
        - 'rx_speed'
        - 'rx_speed_default'
        - 'rx_farnsworth'
        - 'rx_farnsworth_default'
        - 'rx_wordsworth'
        - 'rx_wordsworth_default'
        - 'rx_pitch'
        - 'rx_pitch_default'
        - 'rx_hide_phrase'
        - 'tx_mode' ('A', 'B', 'U')
        - 'tx_polarity' ('ditdah', 'dahdit')
        - 'tx_buffer' (int size)
        - 'scramble'
        - 'shuffle_<ID>' (within lesson)
    -->
</html>