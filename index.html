<html>
    <head>
        <title>Learn Morse Code</title>
        <style>body { margin: 0; padding: 0; }</style>
        <script>
            var lessons = [
                { name: 'E T A N — 1a',
                  phrases: ['E', 'T', 'A', 'N', 'E E E E E', 'T T T T T', 'A A A A A', 'N N N N N'] },
                { name: 'E T A N — 1b',
                  phrases: ['tea', 'tee', 'eat', 'ate', 'at', 'tat', 'teen', 'neat', 'ten', 'net', 'tan', 'eat at ten', 'ate at ten', 'at tee'] },
                { name: 'O I S 1 4 — 2a',
                  phrases: ['O', 'I', 'S', '1', '4', 'O O O O O', 'I I I I I', 'S S S S S', '1 1 1 1 1', '4 4 4 4 4', 'T T T T T', 'E E E E E', 'A A A A A', 'N N N N N'] },
                { name: 'O I S 1 4 — 2b',
                  phrases: ['ten', 'ton', 'tin', 'tie', 'toe', 'no', 'not', 'note', 'it', 'at', 'one', 'neat', 'net', 'nit', 'toes', 'stone', 'tease', 'noise', 'one neat note', 'no noise', 'tie it', '1 ton stone'] },
                { name: 'O I S 1 4 — 2c',
                  phrases: ['N1AS', 'N4ON', 'S41T', 'NO1S', 'AI1E', 'IT4O', 'EA1ON', 'ES4IT'] },
            ];

            var canvas;

            var ui = {
                playing: false,
                buttons: [],
            };

            var audioCtx;
            var audioStarted = false;
            function startAudio() {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                var oscillator = audioCtx.createOscillator();
                oscillator.frequency.value = 750;
                gain = audioCtx.createGain();
                gain.gain.value = 0;
                oscillator.connect(gain);
                gain.connect(audioCtx.destination);
                oscillator.start(0);
                audioStarted = true;
            }

            var t = 0;
            function playTone(len) {
                const ramp = 0.01;
                if (!audioStarted) startAudio();
                var c = audioCtx.currentTime;
                t = c > t ? c : t;
                gain.gain.setTargetAtTime(1, t, ramp);
                t += len;
                gain.gain.setTargetAtTime(0, t, ramp);
                t += ditlen;
            }

            function silence(len) {
                t += len;
            }

            var ditlen;
            function setSpeed(wpm) {
                ditlen = 1.2 / wpm;
            }

            var farnsworth;
            function setFarnsworth(dits) {
                farnsworth = dits;
            }

            function say(utterance, delay) {
                var utter = '';
                for (var i in utterance) {
                    var c = utterance[i];
                    if (c == c.toUpperCase()) {
                        var spell = {
                            'A': 'ay',
                            'B': 'bee',
                            'C': 'cee',
                            'D': 'dee',
                            'E': 'ee',
                            'F': 'ef',
                            'G': 'gee',
                            'H': 'aych',
                            'I': 'eye',
                            'J': 'jay',
                            'K': 'kay',
                            'L': 'el',
                            'M': 'em',
                            'N': 'in',
                            'O': 'oh',
                            'P': 'pee',
                            'Q': 'cue',
                            'R': 'ar',
                            'S': 'ess',
                            'T': 'tee',
                            'U': 'you',
                            'V': 'vee',
                            'W': 'double you',
                            'X': 'ex',
                            'Y': 'wye',
                            'Z': 'zee',
                            '?': 'question mark',
                            '.': 'full stop',
                            ',': 'comma',
                            ':': 'colon',
                            '-': 'dash',
                            ';': 'semicolon',
                            '!': 'exclamation point',
                            '/': 'slash',
                            "'": 'apostrophe',
                            '"': 'quotation mark',
                            '_': 'underscore',
                            '=': 'double dash',
                            '&': 'ampersand',
                            '$': 'dollar sign',
                            '(': 'left parenthesis',
                            ')': 'right parenthesis',
                            '+': 'plus',
                            '@': 'at sign',
                            '<': ' ', // nothing
                            '>': 'prosign',
                        }[c];
                        utter += ' ' + (spell || c) + ' ';
                    } else {
                        utter += c;
                    }
                }
                if ('speechSynthesis' in window) {
                    window.setTimeout(function() {
                        window.speechSynthesis.speak(
                            new SpeechSynthesisUtterance(utter)
                        )
                    }, delay * 1000);
                }
            }

            var morse = "  ETIANMSURWDKGOHVF L PJBXCYZQ  54 3   2& +    16=/   ( 7   8 90     $      ?_    \"  .    @   '  -        ;! )     ,    :";
            function playPhrase(speakAndAdvance) {
                var phrase = lessons[getLesson()].phrases[getPhrase()];
                var prosign = false;
                if (!audioStarted) startAudio();
                var startTime = audioCtx.currentTime;
                for (var i in phrase) {
                    var c = phrase[i];
                    if (c == ' ') { // word break
                        silence(ditlen * 7 + (ditlen * farnsworth));
                    } else {
                        if (c == '<') prosign = true;
                        if (c == '>') prosign = false;
                        var j = morse.indexOf(c.toUpperCase());
                        var letter = [];
                        while (j > 1) {
                            if (j % 2 == 0) {
                                letter.push(true);
                                j /= 2;
                            } else {
                                letter.push(false);
                                j = (j - 1) / 2;
                            }
                        }
                        letter.reverse();
                        for (var j in letter) {
                            playTone(letter[j] ? ditlen : ditlen * 3);
                            silence(ditlen);
                        }
                        if (!prosign) {
                            silence(ditlen * 3 + (ditlen * farnsworth));
                        }
                    }
                }
                const trainingSpeechPause = 2; // TODO: settings
                if (speakAndAdvance) {
                    say(phrase, t - startTime + trainingSpeechPause);
                    silence(trainingSpeechPause * 2);
                }
                silence(ditlen * 7); // final word break
                window.setTimeout(function () {
                    if (ui.playing) {
                        nextPhrase();
                        redraw();
                        playPhrase();
                    }
                 }, t - startTime);
            }

            function getIntSetting(name) {
                return parseInt(window.localStorage.getItem(name) || '0');
            }

            function getLesson() {
                return getIntSetting('lesson');
            }

            function setLesson(num) {
                window.localStorage.setItem('lesson', num);
            }

            function getPhrase() {
                return getIntSetting('phrase');
            }

            function setPhrase(num) {
                window.localStorage.setItem('phrase', num);
            }

            function getDarkMode() {
                return (window.localStorage.getItem('mode') || 'dark') == 'dark';
            }

            function setDarkMode(dark) {
                window.localStorage.setItem('mode', dark ? 'dark' : 'light');
            }

            function resizeCanvas() {
                //canvas.width = document.body.clientWidth;
                //canvas.height = document.body.clientHeight;

                var ratio = window.devicePixelRatio;
                var w = document.body.clientWidth;
                var h = document.body.clientHeight;
                canvas.width = w * ratio;
                canvas.height = h * ratio;
                canvas.style.width = w + 'px';
                canvas.style.height = h + 'px';
            }

            function redraw() {
                const phraseTextColor = '#f43'; // red
                const lessonTextColor = '#07d'; // blue
                const phraseNumTextColor = '#2c4'; // green

                var darkMode = getDarkMode();
                var backgroundColor = darkMode ? '#111' : '#eee'; // black/white
                var foregroundColor = darkMode ? '#eee' : '#111'; // white/black
                var mainButtonColor = foregroundColor;
                var subduedButtonColor = darkMode ? '#ccc' : '#333'; // gray
                var disabledButtonColor = darkMode ? '#333' : '#ddd'; // gray

                var ctx = canvas.getContext('2d');
                ctx.scale(1, 1);
                var ratio = window.devicePixelRatio;
                var w = canvas.width;
                var h = canvas.height;

                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, w, h);
                document.body.style.backgroundColor = backgroundColor;

                function drawFittedText(txt, color, x, y, width, height, weight, actual, centered) {
                    ctx.fillStyle = color;
                    function setFont(size) { ctx.font = weight + ' ' + size + 'px sans-serif'; }
                    const sampleSize = 100;
                    setFont(sampleSize);
                    var size = ctx.measureText(txt);
                    var ascent = actual ? size.actualBoundingBoxAscent : size.fontBoundingBoxAscent;
                    var descent = actual ? size.actualBoundingBoxDescent : size.fontBoundingBoxDescent;
                    var textHeight = ascent + descent;
                    var textWidth = size.actualBoundingBoxLeft + size.actualBoundingBoxRight;
                    var scale = Math.min(width / textWidth, height / textHeight);
                    setFont(scale * sampleSize);
                    ctx.textAlign = centered ? 'center' : 'left';
                    ctx.fillText(txt, x + (centered ? width / 2 : 0), y + ascent * scale + (height - textHeight * scale) / 2);
                }

                var padding = 40 * ratio;

                var buttons = [];
                function drawButton(name, label, color, x, y, width, height) {
                    drawFittedText(label, color, x, y, width, height, 'normal', true, true);
                    var p = padding / 2;
                    buttons.push({
                        name: name,
                        left: x - p,
                        top: y - p,
                        right: x + width + p,
                        bottom: y + height + p })
                }

                const numButtons = 5;
                const largeButton = 1.5;
                var buttonWidth = (w - (numButtons + 1) * padding) / (numButtons + largeButton - 1);
                var buttonHeight = Math.min(buttonWidth, canvas.width / 10, canvas.height / 10);

                drawButton(
                    'mode',
                    getDarkMode() ? '☼' : '☽',
                    subduedButtonColor,
                    w - padding - buttonHeight,
                    padding, buttonHeight, buttonHeight);
                drawButton(
                    'prevLesson',
                    '⇤',
                    getLesson() > 0 ? subduedButtonColor : disabledButtonColor,
                    padding * 1 + buttonWidth * 0,
                    h - padding - buttonHeight,
                    buttonWidth, buttonHeight);
                drawButton(
                    'prevPhrase',
                    '⟲',
                    subduedButtonColor,
                    padding * 2 + buttonWidth * 1,
                    h - padding - buttonHeight,
                    buttonWidth,
                    buttonHeight);
                drawButton(
                    'nextPhrase',
                    '⟳',
                    subduedButtonColor,
                    padding * 4 + buttonWidth * 2 + buttonWidth * largeButton,
                    h - padding - buttonHeight,
                    buttonWidth,
                    buttonHeight);
                drawButton(
                    'nextLesson',
                    '⇥',
                    getLesson() < lessons.length - 1 ? subduedButtonColor : disabledButtonColor,
                    padding * 5 + buttonWidth * 3 + buttonWidth * largeButton,
                    h - padding - buttonHeight,
                    buttonWidth,
                    buttonHeight);
                drawButton(
                    'playPause',
                     ui.playing ? 'II' : '▸',
                     foregroundColor,
                     padding * 3 + buttonWidth * 2,
                     h - padding - buttonHeight * largeButton,
                     buttonWidth * largeButton,
                     buttonHeight * largeButton);
                ui.buttons = buttons;

                drawFittedText(
                    lessons[getLesson()].name,
                    lessonTextColor,
                    padding,
                    padding,
                    w - padding * 6 - buttonHeight * 2,
                    buttonHeight,
                    'normal',
                    false,
                    false);
                drawFittedText(
                    getPhrase() + 1,
                    phraseNumTextColor,
                    w - padding * 3 - buttonHeight * 2,
                    padding,
                    buttonHeight,
                    buttonHeight,
                    'normal',
                    false,
                    false);
                var phraseX = padding;
                var phraseY = buttonHeight + padding * 2;
                var phraseWidth = w - padding * 2;
                var phraseHeight = h - padding * 4 - buttonHeight - buttonHeight * largeButton;
                drawFittedText(
                    lessons[getLesson()].phrases[getPhrase()], 
                    phraseTextColor,
                    phraseX,
                    phraseY,
                    phraseWidth,
                    phraseHeight,
                    'bold',
                    false,
                    true);
                ui.buttons.push({
                    name: 'phrase',
                    left: phraseX - padding,
                    top: phraseY - padding,
                    right: phraseWidth + padding,
                    bottom: phraseHeight + padding })
            }

            function nextPhrase() {
                var phrase = getPhrase();
                setPhrase(
                    phrase > 0 ?
                    phrase - 1 :
                    lessons[phrase].phrases.length - 1);
            }

            function touch(x, y) {
                ui.x = x;
                ui.y = y;
                for (var b in ui.buttons) {
                    var button = ui.buttons[b];
                    if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                        switch (button.name) {
                            case 'mode':
                                setDarkMode(!getDarkMode());
                                break;
                            case 'phrase':
                                playPhrase(false);
                                break;
                            case 'playPause':
                                ui.playing = !ui.playing;
                                if (ui.playing) playPhrase(true);
                                break;
                            case 'prevLesson':
                                var lesson = getLesson();
                                if (lesson > 0) setLesson(lesson - 1);
                                setPhrase(0);
                                break;
                            case 'nextLesson':
                                var lesson = getLesson();
                                if (lesson < lessons.length - 1) setLesson(lesson + 1);
                                setPhrase(0);
                                break;
                            case 'prevPhrase':
                                nextPhrase();
                                break;
                            case 'nextPhrase':
                                setPhrase((getPhrase() + 1) % lessons[getLesson()].phrases.length);
                                break;
                        }
                    }
                }
                redraw();
            }

            window.onload = function() {
                if (window.location.search == '?clear-settings') window.localStorage.clear();
                var ratio = window.devicePixelRatio;
                canvas = document.getElementById('canvas');
                canvas.onmousedown = function(e) { e.preventDefault(); touch(e.x * ratio, e.y * ratio); }
                // canvas.ontouchstart = function(e) { e.preventDefault(); touch(e.touches[0].clientX * ratio, e.touches[0].clientY * ratio); }
                resizeCanvas();
                redraw();
                setSpeed(25); // TODO: settings
                setFarnsworth(21); // TODO: settings
            }

            window.onresize = function() {
                resizeCanvas();
                redraw();
            }
        </script>
    </head>
    <body class="dark">
        <canvas id="canvas"></canvas>
    </body>
</html>