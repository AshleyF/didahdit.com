<html>
    <head>
        <title>Learn Morse Code</title>
        <style>body { margin: 0; padding: 0; }</style>
        <script>
            var lessons = [
                { name: '1a Characters E T A N',
                  phrases: ['E', 'T', 'A', 'N', 'E E E', 'T T T', 'A A A', 'N N N'] },
                { name: '1b Words E T A N',
                  phrases: ['tea', 'tee', 'eat', 'ate', 'at', 'tat', 'teen', 'neat', 'ten', 'net', 'tan'] },
                { name: '1c Phrases E T A N',
                  phrases: ['eat at ten', 'ate at ten', 'at tee'] },
                { name: '2a Characters O I S 1 4',
                  phrases: ['O', 'I', 'S', '1', '4', 'O O O', 'I I I', 'S S S', '1 1 1', '4 4 4', 'T T T', 'E E E', 'A A A', 'N N N'] },
                { name: '2b Words O I S 1 4',
                  phrases: ['ten', 'ton', 'tin', 'tie', 'toe', 'no', 'not', 'note', 'it', 'at', 'one', 'neat', 'net', 'nit', 'toes', 'stone', 'tease', 'noise'] },
                { name: '2c Phrases O I S 1 4',
                  phrases: ['one neat note', 'no noise', 'tie it', '1 ton stone'] },
                { name: '2d Calls O I S 1 4',
                  phrases: ['N1AS', 'N4ON', 'S41T', 'NO1S', 'AI1E', 'IT4O', 'EA1ON', 'ES4IT'] },
                { name: '3a Characters R H D L 2 5',
                  phrases: ['R', 'H', 'D', 'L', '2', '5', 'R R R', 'H H H', 'D D D', 'L L L', '2 2 2', '5 5 5', 'O O O', 'I I I', 'S S S'] },
                { name: '3b Words R H D L 2 5',
                  phrases: ['all', 'tell', 'tall', 'deal', 'the', 'their', 'doll', 'dell', 'hall', 'hill', 'hole', 'load', 'lead', 'late', 'later', 'seal', 'sell', 'sole', 'she', 'shed', 'her', 'hear', '142', '451', '1425'] },
                { name: '3b Phrases R H D L 2 5',
                  phrases: ['a tall hill', 'she is here', 'he is late', '4 sheds', '12 hills'] },
                { name: '3c Calls R H D L 2 5',
                  phrases: ['DL1AT', 'HH5H', 'HS1TD', 'ND2T', 'NA4T'] },
                { name: '4a Characters U C',
                  phrases: ['U', 'C', 'U U U', 'C C C', 'R R R', 'H H H', 'D D D', 'L L L', '1 1 1', '4 4 4'] },
                { name: '4b Words U C',
                  phrases: ['chat', 'chair', 'chin', 'chart', 'ouch', 'couch', 'touch', 'such', 'teach', 'reach', 'sun', 'son', 'hold', 'told', 'sail', 'rail', 'tail', 'nail', 'oil', 'soil', 'toil', 'coil', 'rain', 'cause', 'sauce', 'toss', 'toll', 'tall', 'tell', 'cell', 'call', '4241', '1452'] },
                { name: '4c Phrases U C',
                  phrases: ['in the cell', 'that hurts', 'at the hall', 'hole in 1', 'sail on sailor', 'tell all', 'hold on'] },
                { name: '4d Calls U C',
                  phrases: ['NC5A', 'NA2T', 'CU1LL', 'CO5NO', 'NU4R', 'CT1AC', 'CE1NI'] },
                { name: '5a Characters M W 3 6 ?',
                  phrases: ['M', 'W', '3', '6', '?', 'M M M', 'W W W', '3 3 3', '6 6 6', '? ? ?', 'U U U', 'C C C', '2 2 2', '5 5 5'] },
                { name: '5b Words M W 3 6 ?',
                  phrases: ['wait', 'wall', 'well', 'will', 'mall', 'mill', 'chum', 'mow', 'much', 'such', 'water', 'wet', 'what', 'dew', 'date', 'atom', 'tow', 'tower', 'were', 'where', 'was', 'wish', 'wash', 'mat', 'matt', 'mel', 'him', 'her', 'his', 'hw?'] },
                { name: '5c Phrases M W 3 6 ?',
                  phrases: ['well water', 'how is it?', 'is this it?', 'this is it', 'this is it', '1432 hill street', '1 and 4 is 5'] },
                { name: '5d Calls M W 3 6 ?',
                  phrases: ['W3AA', 'N3AM', 'DM5RA', 'W6AM', 'N2AT', 'RW5L', 'ON4UN', '335', '1432', '6122'] },
                { name: '6a Characters F Y',
                  phrases: ['F', 'Y', 'F F F', 'Y Y Y', 'M M M', 'W W W', '3 3 3', '6 6 6'] },
                { name: '6b Words F Y',
                  phrases: ['you', 'toy', 'foot', 'tooth', 'root', 'cute', 'noise', 'larry', 'roy', 'ton', 'teeth', 'feet', 'yet', 'they', 'say', 'ray', 'hay', 'your', 'fair', 'fare', 'far', 'fur', 'furry', 'hw?'] },
                { name: '6c Phrases F Y',
                  phrases: ['is this fair?', 'yes it is', 'the fur flies', 'she is shy', 'I say no', 'she says yes', 'he says no', 'who is he?', 'he is will', 'no he is walt'] },
                { name: '6d Calls F Y',
                  phrases: ['F5IN', 'YO1AR', 'HH5H', 'NO3M', 'AA3U', 'S52R', '1512', '3316'] },
                { name: '7a Characters P G 7 9 /',
                  phrases: ['P', 'G', '7', '9', '/', 'P P P', 'G G G', '7 7 7', '9 9 9', '/ / /', 'F F F', 'Y Y Y', '3 3 3', '6 6 6'] },
                { name: '7b Words P G 7 9 /',
                  phrases: ['page', 'paper', 'pepper', 'glad', 'glare', 'large', 'ledge', 'george', 'geo', 'chas', 'chase', 'change', 'peg', 'pug', 'pig', 'pen', 'pencil', 'pipe', 'pit', 'gain', 'garage', 'guard', 'gas', 'gus', 'chug', 'yes', 'yet', 'yonder', 'coy', '7423', '14253679', '14253679'] },
                { name: '7c Phrases P G 7 9 /',
                  phrases: ['he is a pro', 'she is near', 'do not gape', 'he is at 19 glen street', 'go to her', 'read the page', 'wat page?', 'page 15'] },
                { name: '7d Calls P G 7 9 /',
                  phrases: ['G4AN/3', 'N1AR/5', 'W9UCA/9', 'W3/PY2AA', 'F6/N6AM', '2N2222'] },
                { name: '8a Characters B V',
                  phrases: ['B', 'V', 'B B B', 'V V V', '7 7 7', '9 9 9', '/ / /'] },
                { name: '8b Words B V',
                  phrases: ['vote', 'vat', 'view', 'wave', 'pave', 'save', 'vow', 'valve', 'solve', 'volt', 'vault', 'bad', 'body', 'bore', 'born', 'barn', 'barney', 'brad', 'bread', 'bed', 'better', 'best', 'bill', 'build', 'built', 'bolt', 'bulb', 'blame', 'blend', 'bland', 'blow', '6146', '5514'] },
                { name: '8c Phrases B V',
                  phrases: ['name is bob', 'name is bill', 'name is ted', 'name is vinnie', 'name is art', 'ur rst is 559', 'ur rst is 459', 'ur rst is 579', 'ur rst is 449' ] },
                { name: '8d Calls B V',
                  phrases: ['BV2AA', 'BA1RO', 'WB2AE', 'N6RB/4', 'W2/VE1AR', 'VE2/W2LE'] },
                { name: '9a Characters J K 8 0 <BT>',
                  phrases: ['J', 'K', '8', '0', '<BT>', 'J J J', 'K K K', '8 8 8', '0 0 0', '<BT> <BT> <BT>', 'B B B', 'V V V'] },
                { name: '9b Words J K 8 0 <BT>',
                  phrases: ['jack', 'jay', 'john', 'jim', 'jerry', 'back', 'rack', 'tack', 'tech', 'tach', 'reach', 'each', 'teach', 'help', 'high', 'hill', 'fact', 'face', 'far', 'fear', 'then', 'their', 'him', 'her', 'his', 'hers', 'them', 'they', 'their', 'switch', 'line', 'ant', 'dipole', 'vertical', 'ohms', 'home', 'away', 'test', 'asia', 'africa', '807', '3500Z', '4250A'] },
                { name: '9c Phrases J K 8 0 <BT>',
                  phrases: ['hw is he?', 'name is joe <BT> age is 49', 'name is john <BT> age is 66', 'name is jim <BT> age is 17', 'name is fred <BT> age is 44', 'name is tom <BT> age is 72', 'name is john <BT> age is 23', 'name is bob <BT> age is 51', 'ur rst is 549', 'ur rst is 579', 'ur rst is 339', 'sri no cpy'] },
                { name: '9d Calls J K 8 0 <BT>',
                  phrases: ['K1JD', 'N1AR', 'W2TT', 'K2UMU', 'N2NW', 'VE3NE', 'VA3KP', 'K4BAI', 'N5KO'] },
                { name: '10a Characters X Q Z <BK>',
                  phrases: ['X', 'Q', 'Z', '<BK>', 'x x x', 'q q q', 'z z z', '<BK> <BK> <BK>', 'k k k', 'j j j', '8 8 8', '0 0 0'] },
                { name: '10b Words X Q Z <BK>',
                  phrases: ['wl', 'ur', 'ok', 'hw?', 'qrx', 'qrz', 'qth', 'qrs', 'qro', 'qrp', 'rig', 'wx', 'ant', 'pwr', 'kw', 'name', 'memphis', 'nyc', 'sf', 'dallas', 'houston', 'nm', 'nj', 'ca', 'ut', 'al', 'ar', 'il', 'in', 'me', 'ma', 'ct', 'co', 'qrm', 'ne', 'sd', 'nd', 'pa', 'ky', 'fl', 'nc', 'sc', 'sdgo', 'lax', 'la', 'on', 'sk', 'mb', 'nt', 'ab', 'qc', 'nb', 'ns', 'nr', 'rst', 'uk', 'usa', 'tokyo', 'paris', 'london', 'hamburg', 'sydney', '8044', '7400', '73'] },
                { name: '10c Phrases X Q Z <BK>',
                  phrases: ['u hv qsb', 'u hv qrm', 'name?', 'qth?', 'qth is ny <BK>', 'qth is paris <BK>', 'pse qsy to 7054', 'ur rst is 579 <BK>', 'qth is nr tulsa <BK>', 'name is barry <BK>', 'ur rst is 559 <BK>', 'qth is dayton oh <BK>', 'name is john'] },
                { name: '10d Calls X Q Z <BK>',
                  phrases: ['ZL2TT', 'VK4OM', 'JE1TRV', 'BA1CW', 'KH6LC', 'AL2A', 'AA3B'] },
            ];

            var canvas;

            var ui = {
                settings: false,
                playing: false,
                hide: false,
                buttons: [],
                dialog: { left: 0, right: 0, top: 0, bottom: 0 },
                speed: 20,
                delay: 8,
            };

            var audioCtx;
            var gain;
            var oscillator;
            var audioStarted = false;
            function startAudio() {
                say('');
                (new Audio('silent.wav')).play();
                audioCtx = new (AudioContext || webkitAudioContext)();
                oscillator = audioCtx.createOscillator();
                oscillator.frequency.value = getPitch();
                gain = audioCtx.createGain();
                gain.gain.value = 0;
                oscillator.connect(gain);
                gain.connect(audioCtx.destination);
                oscillator.start(0);
                audioStarted = true;
            }

            var t = 0;
            function stopAudio() {
                if (audioStarted) {
                    audioCtx.close();
                    t = 0;
                    audioStarted = false;
                }
            }

            function playTone(len) {
                const ramp = 0.01;
                if (!audioStarted) startAudio();
                var c = audioCtx.currentTime;
                t = c > t ? c : t;
                gain.gain.setTargetAtTime(1, t, ramp);
                t += len;
                gain.gain.setTargetAtTime(0, t, ramp);
            }

            function silence(len) {
                t += len;
            }

            function say(utterance) {
                var utter = '';
                for (var i in utterance) {
                    var c = utterance[i];
                    if (c == c.toUpperCase()) {
                        var spell = {
                            'A': 'alfa',
                            'B': 'bravo',
                            'C': 'charlie',
                            'D': 'delta',
                            'E': 'echo',
                            'F': 'foxtrot',
                            'G': 'golf',
                            'H': 'hotel',
                            'I': 'india',
                            'J': 'juliet',
                            'K': 'kilo',
                            'L': 'lima',
                            'M': 'mike',
                            'N': 'november',
                            'O': 'oscar',
                            'P': 'papa',
                            'Q': 'quebec',
                            'R': 'romeo',
                            'S': 'sierra',
                            'T': 'tango',
                            'U': 'uniform',
                            'V': 'victor',
                            'W': 'whiskey',
                            'X': 'x-ray',
                            'Y': 'yanky',
                            'Z': 'zulu',
                            '1': 'one',
                            '2': 'two',
                            '3': 'three', // tree?
                            '4': 'four', // fower?
                            '5': 'five', // fife?
                            '6': 'six',
                            '7': 'seven',
                            '8': 'eight',
                            '9': 'niner',
                            '0': 'zero',
                            '?': 'question mark',
                            '.': 'full stop',
                            ',': 'comma',
                            ':': 'colon',
                            '-': 'dash',
                            ';': 'semicolon',
                            '!': 'exclamation point',
                            '/': 'slash',
                            "'": 'apostrophe',
                            '"': 'quotation mark',
                            '_': 'underscore',
                            '=': 'double dash',
                            '&': 'ampersand',
                            '$': 'dollar sign',
                            '(': 'left parenthesis',
                            ')': 'right parenthesis',
                            '+': 'plus',
                            '@': 'at sign',
                            '<': ' ', // nothing
                            '>': 'pro-sign',
                        }[c];
                        utter += ' ' + (spell || c) + ' ';
                    } else {
                        utter += c;
                    }
                }
                if ('speechSynthesis' in window) {
                    speechSynthesis.speak(new SpeechSynthesisUtterance(utter));
                }
            }

            var ding = new Audio('ding.wav');
            function playDing() {
                ding.play();
            }

            var morse = "  ETIANMSURWDKGOHVF L PJBXCYZQ  54 3   2& +    16=/   ( 7   8 90     $      ?_    \"  .    @   '  -        ;! )     ,    :";
            var playContinuation = function() {};
            var continuationTimeout0 = null;
            var continuationTimeout1 = null;

            function stopPhrase() {
                playContinuation = function() {};
                if (continuationTimeout0) clearTimeout(continuationTimeout0);
                if (continuationTimeout1) clearTimeout(continuationTimeout1);
                if (ui.hide) {
                    ui.hide = false;
                    redraw();
                }
            }

            function getCurrentPhrase() {
                return lessons[getLesson()].phrases[getPhrase()]
            }

            function encodePhrase(phrase) {
                function trim(str) { return str.endsWith(' ') ? str.substring(0, str.length - 1) : str; }
                var prosign = false;
                var code = '';
                for (var i in phrase) {
                    var c = phrase[i];
                    if (c == ' ') { // word break
                        code = trim(code) + '/';
                    } else {
                        if (c == '<') prosign = true;
                        if (c == '>') prosign = false;
                        var letter = '';
                        var j = morse.indexOf(c.toUpperCase());
                        while (j > 1) {
                            if (j % 2 == 0) {
                                letter = '.' + letter;
                                j /= 2;
                            } else {
                                letter = '-' + letter;
                                j = (j - 1) / 2;
                            }
                        }
                        code += letter;
                        if (!prosign) {
                            code += ' ';
                        }
                    }
                }
                return trim(code);
            }

            function playCode(code) {
                function continuation(j) {
                    if (code.length > j) {
                        var continueCode = code.substring(j);
                        continuationTimeout0 = setTimeout(
                            function() { playCode(continueCode); },
                            (t - startTime) * 1000);
                    }
                }
                if (!audioStarted) startAudio();
                var startTime = audioCtx.currentTime;
                for (var i = 0; i < code.length; i++) {
                    switch (code[i]) {
                        case '.':
                            playTone(ditlen);
                            silence(ditlen);
                            break;
                        case '-':
                            playTone(ditlen * 3);
                            silence(ditlen);
                            break;
                        case ' ':
                            silence(ditlen * 3 * farnsworth);
                            continuation(i + 1);
                            return;
                        case '/':
                            silence(ditlen * 7 * farnsworth);
                            continuation(i + 1);
                            return;
                    }
                }
            }

            function playPhrase(phrase, speakAndAdvance) {
                function codeMilliseconds(code) {
                    var s = 0;
                    for (var i = 0; i < code.length; i++) {
                        switch (code[i]) {
                            case '.':
                                s += ditlen * 2;
                                break;
                            case '-':
                                s += ditlen * 4;
                                break;
                            case ' ':
                                s += ditlen * 3 * farnsworth;
                                break;
                            case '/':
                                s += ditlen * 7 * farnsworth;
                                break;
                        }
                    }
                    return s * 1000;
                }
                if (speakAndAdvance && !ui.hide) {
                    ui.hide = true;
                    redraw();
                }
                var code = encodePhrase(phrase);
                playCode(code);
                const trainingSpeechPause = 3000; // TODO: settings
                var delay = codeMilliseconds(code) + ditlen * 7 * 1000;
                if (speakAndAdvance) {
                    continuationTimeout1 = setTimeout(
                        function () {
                            if (ui.playing) {
                                playDing();
                                continuationTimeout1 = setTimeout(
                                    function () {
                                        if (ui.playing) {
                                            ui.hide = false;
                                            redraw();
                                            say(getCurrentPhrase());
                                            continuationTimeout1 = setTimeout(
                                                function () {
                                                    if (ui.playing) {
                                                        nextPhrase(true);
                                                        redraw();
                                                        playPhrase(getCurrentPhrase(), speakAndAdvance, false);
                                                    }
                                                },
                                                trainingSpeechPause);
                                        }
                                    },
                                    trainingSpeechPause);
                            }
                        },
                        delay);
                } else {
                    continuationTimeout1 = setTimeout(
                        function () {
                            if (ui.playing) {
                                ui.playing = false;
                                redraw();
                            }
                        },
                        delay);

                }
            }

            function getIntSetting(name, dflt) {
                return parseInt(localStorage.getItem(name) || dflt);
            }

            function getLesson() {
                return getIntSetting('lesson', 0);
            }

            function setLesson(num) {
                localStorage.setItem('lesson', num);
            }

            function getPhrase() {
                return getIntSetting('phrase', 0);
            }

            function setPhrase(num) {
                localStorage.setItem('phrase', num);
            }

            function getDarkMode() {
                return (localStorage.getItem('mode') || 'dark') == 'dark';
            }

            function setDarkMode(dark) {
                localStorage.setItem('mode', dark ? 'dark' : 'light');
            }

            var ditlen;
            function setSpeed(wpm) {
                localStorage.setItem('speed', wpm);
                ditlen = 1.2 / wpm;
            }

            function getSpeed() {
                return getIntSetting('speed', 20);
            }

            var farnsworth;
            function setDelay(factor) {
                localStorage.setItem('delay', factor);
                farnsworth = factor;
            }

            function getDelay() {
                return getIntSetting('delay', 7);
            }

            function setPitch(hz) { // TODO
                localStorage.setItem('pitch', hz);
                if (audioStarted) oscillator.frequency.value = hz;
            }

            function getPitch() { // TODO
                return getIntSetting('pitch', 650);
            }

            function resizeCanvas() {
                //canvas.width = document.body.clientWidth;
                //canvas.height = document.body.clientHeight;

                var ratio = devicePixelRatio;
                var w = document.body.clientWidth;
                var h = document.body.clientHeight;
                canvas.width = w * ratio;
                canvas.height = h * ratio;
                canvas.style.width = w + 'px';
                canvas.style.height = h + 'px';
            }

            function redraw() {
                const phraseTextColor = '#f43'; // red
                const lessonTextColor = '#07d'; // blue
                const phraseNumTextColor = '#2c4'; // green
                const dimColor = '#000b';

                var darkMode = getDarkMode();
                var backgroundColor = darkMode ? '#111' : '#eee'; // black/white
                var foregroundColor = darkMode ? '#eee' : '#111'; // white/black
                var mainButtonColor = foregroundColor;
                var subduedButtonColor = darkMode ? '#ccc' : '#333'; // gray
                var disabledButtonColor = darkMode ? '#333' : '#ccc'; // gray
                var dialogBackgroundColor = darkMode ? '#222' : '#ddd';
                var dialogAttributionColor = darkMode ? '#444' : '#bbb';

                var ctx = canvas.getContext('2d');
                ctx.scale(1, 1);
                var ratio = devicePixelRatio;
                var w = canvas.width;
                var h = canvas.height;

                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, w, h);
                document.body.style.backgroundColor = backgroundColor;

                function drawFittedText(txt, color, x, y, width, height, weight, actual, centered) {
                    ctx.fillStyle = color;
                    function setFont(size) { ctx.font = weight + ' ' + size + 'px sans-serif'; }
                    const sampleSize = 100;
                    setFont(sampleSize);
                    var size = ctx.measureText(txt);
                    var ascent = actual ? size.actualBoundingBoxAscent : size.fontBoundingBoxAscent;
                    var descent = actual ? size.actualBoundingBoxDescent : size.fontBoundingBoxDescent;
                    var textHeight = ascent + descent;
                    var textWidth = size.actualBoundingBoxLeft + size.actualBoundingBoxRight;
                    var scale = Math.min(width / textWidth, height / textHeight);
                    setFont(scale * sampleSize);
                    ctx.textAlign = centered ? 'center' : 'left';
                    ctx.fillText(txt, x + (centered ? width / 2 : 0), y + ascent * scale + (height - textHeight * scale) / 2);
                }

                function fillRoundedRect(left, top, right, bottom, radius, color) {
                    ctx.beginPath();
                    ctx.moveTo(left + radius, top);
                    ctx.lineTo(right - radius, top);
                    ctx.arcTo(right, top, right, top + radius, radius);
                    ctx.lineTo(right, bottom - radius);
                    ctx.arcTo(right, bottom, right - radius, bottom, radius);
                    ctx.lineTo(left + radius, bottom);
                    ctx.arcTo(left, bottom, left, bottom - radius, radius);
                    ctx.lineTo(left, top + radius);
                    ctx.arcTo(left, top, left + radius, top, radius);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                }

                var padding = 40 * ratio;

                var buttons = [];
                function drawButton(name, label, color, x, y, width, height) {
                    drawFittedText(label, color, x, y, width, height, 'normal', true, true);
                    var p = padding / 2;
                    buttons.push({
                        name: name,
                        left: x - p,
                        top: y - p,
                        right: x + width + p,
                        bottom: y + height + p })
                }

                const numButtons = 5;
                const largeButton = 1.5;
                var buttonWidth = (w - (numButtons + 1) * padding) / (numButtons + largeButton - 1);
                var buttonSize = Math.min(buttonWidth, canvas.width / 10, canvas.height / 10);

                drawButton(
                    'settings',
                    '⁝',
                    subduedButtonColor,
                    w - padding - buttonSize,
                    padding, buttonSize, buttonSize);
                drawButton(
                    'prevLesson',
                    '⇤',
                    getLesson() > 0 ? subduedButtonColor : disabledButtonColor,
                    padding * 1 + buttonWidth * 0,
                    h - padding - buttonSize,
                    buttonWidth, buttonSize);
                drawButton(
                    'prevPhrase',
                    '⟲',
                    getPhrase() > 0 ? subduedButtonColor : disabledButtonColor,
                    padding * 2 + buttonWidth * 1,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize);
                drawButton(
                    'nextPhrase',
                    '⟳',
                    getPhrase() < lessons[getLesson()].phrases.length - 1 ? subduedButtonColor : disabledButtonColor,
                    padding * 4 + buttonWidth * 2 + buttonWidth * largeButton,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize);
                drawButton(
                    'nextLesson',
                    '⇥',
                    getLesson() < lessons.length - 1 ? subduedButtonColor : disabledButtonColor,
                    padding * 5 + buttonWidth * 3 + buttonWidth * largeButton,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize);
                drawButton(
                    'playPause',
                    ui.playing ? 'II' : '▸',
                    foregroundColor,
                    padding * 3 + buttonWidth * 2,
                    h - padding - buttonSize * largeButton,
                    buttonWidth * largeButton,
                    buttonSize * largeButton);
                ui.buttons = buttons;

                drawFittedText(
                    lessons[getLesson()].name,
                    lessonTextColor,
                    padding,
                    padding,
                    w - padding * 6 - buttonSize * 2,
                    buttonSize,
                    'normal',
                    false,
                    false);
                drawFittedText(
                    getPhrase() + 1,
                    phraseNumTextColor,
                    w - padding * 3 - buttonSize * 2,
                    padding,
                    buttonSize,
                    buttonSize,
                    'normal',
                    false,
                    false);
                var phraseX = padding;
                var phraseY = buttonSize + padding * 2;
                var phraseWidth = w - padding * 2;
                var phraseHeight = h - padding * 4 - buttonSize - buttonSize * largeButton;
                drawFittedText(
                    ui.hide ? '?' : lessons[getLesson()].phrases[getPhrase()], 
                    ui.hide ? disabledButtonColor : phraseTextColor,
                    phraseX,
                    phraseY,
                    phraseWidth,
                    phraseHeight,
                    'bold',
                    false,
                    true);
                ui.buttons.push({
                    name: 'phrase',
                    left: phraseX - padding,
                    top: phraseY - padding,
                    right: phraseWidth + padding,
                    bottom: phraseHeight + padding })
                if (ui.settings) {
                    ctx.fillStyle = dimColor;
                    ctx.fillRect(0, 0, w, h);
                    const attributionHeight = padding;
                    var left = padding * (w > h ? 4 : 1);
                    var right = w - padding * (w > h ? 4 : 1);
                    var top = padding * (h > w ? 4 : 1);
                    var bottom = top + buttonSize * 4 + padding * 6 + attributionHeight;
                    ui.dialog = {
                        left: left,
                        right: right,
                        top: top,
                        bottom: bottom
                    };
                    fillRoundedRect(left, top, right, bottom, padding, dialogBackgroundColor);
                    drawFittedText(
                        'Feedback to Ashley 73 de KK7HXU',
                        dialogAttributionColor,
                        left + padding,
                        bottom - padding - attributionHeight,
                        right - left - padding * 2,
                        attributionHeight,
                        'normal',
                        false,
                        true);
                    drawFittedText(
                        'Light/Dark:',
                        subduedButtonColor,
                        left + padding,
                        top + padding,
                        right - padding - buttonSize * 3,
                        buttonSize,
                        'normal',
                        false,
                        false);
                    controlLeft = right - padding - buttonSize * 3;
                    const switchThinFactor = 1.3;
                    fillRoundedRect(
                        controlLeft + padding * switchThinFactor,
                        top + padding * switchThinFactor,
                        right - padding * switchThinFactor - padding,
                        top + padding / switchThinFactor + buttonSize,
                        buttonSize / switchThinFactor / 2,
                        subduedButtonColor);
                    var dark = getDarkMode();
                    ctx.beginPath();
                    ctx.arc(
                        (dark ? right - padding * 2 - buttonSize : controlLeft + padding) + buttonSize / 2,
                        top + padding + buttonSize / 2,
                        buttonSize / 2,
                        0,
                        2 * Math.PI,
                        false);
                    ctx.fillStyle = backgroundColor;
                    ctx.fill();
                    ctx.lineWidth = padding / 10;
                    ctx.strokeStyle = subduedButtonColor;
                    ctx.stroke();
                    var margin = padding / 2;
                    drawFittedText(
                        dark ? '☽' : '☼',
                        subduedButtonColor,
                        (dark ? right - padding * 2 - buttonSize : controlLeft + padding) + margin,
                        top + padding + margin,
                        buttonSize - margin * 2,
                        buttonSize - margin * 2,
                        'normal',
                        true,
                        true);
                    buttons.push({
                        name: 'mode',
                        left: controlLeft,
                        top: top,
                        right: right,
                        bottom: top + buttonSize + padding / 2 })
                    function drawUpDownControl(label, name, val, min, max, row) {
                        drawFittedText(
                            label,
                            subduedButtonColor,
                            left + padding,
                            row,
                            right - padding - buttonSize * 3,
                            buttonSize,
                            'normal',
                            false,
                            false);
                        const arrowScale = 0.5;
                        drawFittedText(
                            '❰',
                            val <= min ? disabledButtonColor : subduedButtonColor,
                            controlLeft,
                            row + (buttonSize * arrowScale / 2),
                            buttonSize * arrowScale,
                            buttonSize * arrowScale,
                            'normal',
                            true,
                            true);
                        if (val > min) {
                            buttons.push({
                                name: name + 'Down',
                                left: controlLeft,
                                top: row,
                                right: controlLeft + buttonSize,
                                bottom: row + buttonSize
                            });
                        }
                        drawButton(
                            name,
                            val,
                            subduedButtonColor,
                            controlLeft + buttonSize,
                            row,
                            buttonSize,
                            buttonSize)
                        drawFittedText(
                            '❱',
                            val >= max ? disabledButtonColor : subduedButtonColor,
                            controlLeft + buttonSize * 2 + buttonSize * arrowScale,
                            row + (buttonSize * arrowScale / 2),
                            buttonSize * arrowScale,
                            buttonSize * arrowScale,
                            'normal',
                            true,
                            true);
                        if (val < max) {
                            buttons.push({
                                name: name + 'Up',
                                left: controlLeft + buttonSize * 2,
                                top: row,
                                right: controlLeft + buttonSize * 4,
                                bottom: row + buttonSize });
                        }
                    }
                    drawUpDownControl('Speed', 'speed', getSpeed(), 5, 30, top + padding * 2 + buttonSize);
                    drawUpDownControl('Delay', 'delay', getDelay(), 1, 15, top + padding * 3 + buttonSize * 2);
                    drawUpDownControl('Pitch', 'pitch', getPitch(), 100, 900, top + padding * 4 + buttonSize * 3);
                    ui.buttons = buttons;
                }
            }

            function prevLesson() {
                var lesson = getLesson();
                if (lesson > 0) setLesson(lesson - 1);
                setPhrase(0);
            }

            function nextLesson() {
                var lesson = getLesson();
                if (lesson < lessons.length - 1) setLesson(lesson + 1);
                setPhrase(0);
            }

            function prevPhrase() {
                var phrase = getPhrase();
                if (phrase > 0) setPhrase(phrase - 1);
            }

            function nextPhrase(autoAdvanceLesson) {
                var phrase = getPhrase();
                if (phrase < lessons[getLesson()].phrases.length - 1) {
                    setPhrase(phrase + 1);
                } else if (autoAdvanceLesson) {
                    nextLesson();
                    setPhrase(0);
                }
            }

            function touch(x, y) {
                if (ui.settings) {
                    if (x < ui.dialog.left || x > ui.dialog.right || y < ui.dialog.top || y > ui.dialog.bottom) {
                        ui.settings = false;
                        redraw();
                    } else {
                    }
                    for (var b = 0; b < ui.buttons.length; b++) {
                        var button = ui.buttons[b];
                        if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                            switch (button.name) {
                                case 'mode':
                                    setDarkMode(!getDarkMode());
                                    redraw();
                                    return;
                                case 'speed':
                                    stopPhrase();
                                    playPhrase('r', false);
                                    return;
                                case 'speedUp':
                                    stopPhrase();
                                    setSpeed(getSpeed() + 1);
                                    redraw();
                                    playPhrase('r', false);
                                    return;
                                case 'speedDown':
                                    stopPhrase();
                                    setSpeed(getSpeed() - 1);
                                    redraw();
                                    playPhrase('r', false);
                                    return;
                                case 'delay':
                                    stopPhrase();
                                    playPhrase('ee', false);
                                    return;
                                case 'delayUp':
                                    stopPhrase();
                                    setDelay(getDelay() + 1);
                                    redraw();
                                    playPhrase('ee', false);
                                    return;
                                case 'delayDown':
                                    stopPhrase();
                                    setDelay(getDelay() - 1);
                                    redraw();
                                    playPhrase('ee', false);
                                    return;
                                case 'pitch':
                                    stopPhrase();
                                    playPhrase('v', false);
                                    return;
                                case 'pitchUp':
                                    stopPhrase();
                                    setPitch(getPitch() + 10);
                                    redraw();
                                    playPhrase('v', false);
                                    return;
                                case 'pitchDown':
                                    stopPhrase();
                                    setPitch(getPitch() - 10);
                                    redraw();
                                    playPhrase('v', false);
                                    return;
                            }
                        }
                    }
                } else {
                    for (var b in ui.buttons) {
                        var button = ui.buttons[b];
                        if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                            switch (button.name) {
                                case 'settings':
                                    stopPhrase();
                                    ui.settings = true;
                                    redraw();
                                    return;
                                case 'phrase':
                                    stopPhrase();
                                    ui.playing = true;
                                    playPhrase(getCurrentPhrase(), false);
                                    redraw();
                                    return;
                                case 'playPause':
                                    stopPhrase();
                                    ui.playing = !ui.playing;
                                    if (ui.playing) playPhrase(getCurrentPhrase(), true);
                                    redraw();
                                    return;
                                case 'prevLesson':
                                    stopPhrase();
                                    ui.playing = false;
                                    prevLesson();
                                    redraw();
                                    return;
                                case 'nextLesson':
                                    stopPhrase();
                                    ui.playing = false;
                                    nextLesson(false);
                                    redraw();
                                    return;
                                case 'prevPhrase':
                                    stopPhrase();
                                    ui.playing = false;
                                    prevPhrase();
                                    redraw();
                                    return;
                                case 'nextPhrase':
                                    stopPhrase();
                                    ui.playing = false;
                                    nextPhrase(false);
                                    redraw();
                                    return;
                            }
                        }
                    }
                }
            }

            onload = function() {
                if (location.search == '?clear-settings') localStorage.clear();
                var ratio = devicePixelRatio;
                canvas = document.getElementById('canvas');
                canvas.onmousedown = function(e) { e.preventDefault(); touch(e.x * ratio, e.y * ratio); };

                resizeCanvas();
                redraw();
                setSpeed(getSpeed());
                setDelay(getDelay());
                document.onvisibilitychange = function(e) {
                    if (document.hidden) {
                        stopPhrase();
                        stopAudio();
                        ui.playing = false;
                        redraw();
                    }
                };
            }

            onresize = function() {
                resizeCanvas();
                redraw();
            }
        </script>
    </head>
    <body class="dark">
        <canvas id="canvas"></canvas>
    </body>
    <!--
        TODO:
        - Hilight characters upon main tap
        - Tap/hold to speed advance
    -->
</html>