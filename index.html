<html>
    <head>
        <title>Learn Morse Code</title>
        <style>body { margin: 0; padding: 0; }</style>
        <script>
            var library = [
                { id: 'CWOPS',
                  name: 'CWOps Beginner',
                  lessons: [
                    { id: '1AC',
                      name: '1a Characters E T A N',
                      phrases: ['E', 'T', 'A', 'N', 'E E E', 'T T T', 'A A A', 'N N N'] },
                    { id: '1BW',
                      name: '1b Words E T A N',
                      phrases: ['tea', 'tee', 'eat', 'ate', 'at', 'tat', 'teen', 'neat', 'ten', 'net', 'tan'] },
                    { id: '1CP',
                      name: '1c Phrases E T A N',
                      phrases: ['eat at ten', 'ate at ten', 'at tee'] },
                    { id: '2AC',
                      name: '2a Characters O I S 1 4',
                      phrases: ['O', 'I', 'S', '1', '4', 'O O O', 'I I I', 'S S S', '1 1 1', '4 4 4', 'T T T', 'E E E', 'A A A', 'N N N'] },
                    { id: '2BW',
                      name: '2b Words O I S 1 4',
                      phrases: ['ten', 'ton', 'tin', 'tie', 'toe', 'no', 'not', 'note', 'it', 'at', 'one', 'neat', 'net', 'nit', 'toes', 'stone', 'tease', 'noise'] },
                    { id: '2CP',
                      name: '2c Phrases O I S 1 4',
                      phrases: ['one neat note', 'no noise', 'tie it', '1 ton stone'] },
                    { id: '2DC',
                      name: '2d Calls O I S 1 4',
                      phrases: ['N1AS', 'N4ON', 'S41T', 'NO1S', 'AI1E', 'IT4O', 'EA1ON', 'ES4IT'] },
                    { id: '3AC',
                      name: '3a Characters R H D L 2 5',
                      phrases: ['R', 'H', 'D', 'L', '2', '5', 'R R R', 'H H H', 'D D D', 'L L L', '2 2 2', '5 5 5', 'O O O', 'I I I', 'S S S'] },
                    { id: '3BW',
                      name: '3b Words R H D L 2 5',
                      phrases: ['all', 'tell', 'tall', 'deal', 'the', 'their', 'doll', 'dell', 'hall', 'hill', 'hole', 'load', 'lead', 'late', 'later', 'seal', 'sell', 'sole', 'she', 'shed', 'her', 'hear', '142', '451', '1425'] },
                    { id: '3BP',
                      name: '3b Phrases R H D L 2 5',
                      phrases: ['a tall hill', 'she is here', 'he is late', '4 sheds', '12 hills'] },
                    { id: '3CC',
                      name: '3c Calls R H D L 2 5',
                      phrases: ['DL1AT', 'HH5H', 'HS1TD', 'ND2T', 'NA4T'] },
                    { id: '4AC',
                      name: '4a Characters U C',
                      phrases: ['U', 'C', 'U U U', 'C C C', 'R R R', 'H H H', 'D D D', 'L L L', '1 1 1', '4 4 4'] },
                    { id: '4BW',
                      name: '4b Words U C',
                      phrases: ['chat', 'chair', 'chin', 'chart', 'ouch', 'couch', 'touch', 'such', 'teach', 'reach', 'sun', 'son', 'hold', 'told', 'sail', 'rail', 'tail', 'nail', 'oil', 'soil', 'toil', 'coil', 'rain', 'cause', 'sauce', 'toss', 'toll', 'tall', 'tell', 'cell', 'call', '4241', '1452'] },
                    { id: '4CP',
                      name: '4c Phrases U C',
                      phrases: ['in the cell', 'that hurts', 'at the hall', 'hole in 1', 'sail on sailor', 'tell all', 'hold on'] },
                    { id: '4DC',
                      name: '4d Calls U C',
                      phrases: ['NC5A', 'NA2T', 'CU1LL', 'CO5NO', 'NU4R', 'CT1AC', 'CE1NI'] },
                    { id: '5AC',
                      name: '5a Characters M W 3 6 ?',
                      phrases: ['M', 'W', '3', '6', '?', 'M M M', 'W W W', '3 3 3', '6 6 6', '? ? ?', 'U U U', 'C C C', '2 2 2', '5 5 5'] },
                    { id: '5BW',
                      name: '5b Words M W 3 6 ?',
                      phrases: ['wait', 'wall', 'well', 'will', 'mall', 'mill', 'chum', 'mow', 'much', 'such', 'water', 'wet', 'what', 'dew', 'date', 'atom', 'tow', 'tower', 'were', 'where', 'was', 'wish', 'wash', 'mat', 'matt', 'mel', 'him', 'her', 'his', 'hw?'] },
                    { id: '5CP',
                      name: '5c Phrases M W 3 6 ?',
                      phrases: ['well water', 'how is it?', 'is this it?', 'this is it', 'this is it', '1432 hill street', '1 and 4 is 5'] },
                    { id: '5DC',
                      name: '5d Calls M W 3 6 ?',
                      phrases: ['W3AA', 'N3AM', 'DM5RA', 'W6AM', 'N2AT', 'RW5L', 'ON4UN', '335', '1432', '6122'] },
                    { id: '6AC',
                      name: '6a Characters F Y',
                      phrases: ['F', 'Y', 'F F F', 'Y Y Y', 'M M M', 'W W W', '3 3 3', '6 6 6'] },
                    { id: '6BW',
                      name: '6b Words F Y',
                      phrases: ['you', 'toy', 'foot', 'tooth', 'root', 'cute', 'noise', 'larry', 'roy', 'ton', 'teeth', 'feet', 'yet', 'they', 'say', 'ray', 'hay', 'your', 'fair', 'fare', 'far', 'fur', 'furry', 'hw?'] },
                    { id: '6CP',
                      name: '6c Phrases F Y',
                      phrases: ['is this fair?', 'yes it is', 'the fur flies', 'she is shy', 'i say no', 'she says yes', 'he says no', 'who is he?', 'he is will', 'no he is walt'] },
                    { id: '6DC',
                      name: '6d Calls F Y',
                      phrases: ['F5IN', 'YO1AR', 'HH5H', 'NO3M', 'AA3U', 'S52R', '1512', '3316'] },
                    { id: '7AC',
                      name: '7a Characters P G 7 9 /',
                      phrases: ['P', 'G', '7', '9', '/', 'P P P', 'G G G', '7 7 7', '9 9 9', '/ / /', 'F F F', 'Y Y Y', '3 3 3', '6 6 6'] },
                    { id: '7BW',
                      name: '7b Words P G 7 9 /',
                      phrases: ['page', 'paper', 'pepper', 'glad', 'glare', 'large', 'ledge', 'george', 'geo', 'chas', 'chase', 'change', 'peg', 'pug', 'pig', 'pen', 'pencil', 'pipe', 'pit', 'gain', 'garage', 'guard', 'gas', 'gus', 'chug', 'yes', 'yet', 'yonder', 'coy', '7423', '14253679', '14253679'] },
                    { id: '7CP',
                      name: '7c Phrases P G 7 9 /',
                      phrases: ['he is a pro', 'she is near', 'do not gape', 'he is at 19 glen street', 'go to her', 'read the page', 'wat page?', 'page 15'] },
                    { id: '7DC',
                      name: '7d Calls P G 7 9 /',
                      phrases: ['G4AN/3', 'N1AR/5', 'W9UCA/9', 'W3/PY2AA', 'F6/N6AM', '2N2222'] },
                    { id: '8AC',
                      name: '8a Characters B V',
                      phrases: ['B', 'V', 'B B B', 'V V V', '7 7 7', '9 9 9', '/ / /'] },
                    { id: '8BW',
                      name: '8b Words B V',
                      phrases: ['vote', 'vat', 'view', 'wave', 'pave', 'save', 'vow', 'valve', 'solve', 'volt', 'vault', 'bad', 'body', 'bore', 'born', 'barn', 'barney', 'brad', 'bread', 'bed', 'better', 'best', 'bill', 'build', 'built', 'bolt', 'bulb', 'blame', 'blend', 'bland', 'blow', '6146', '5514'] },
                    { id: '8CP',
                      name: '8c Phrases B V',
                      phrases: ['name is bob', 'name is bill', 'name is ted', 'name is vinnie', 'name is art', 'ur rst is 559', 'ur rst is 459', 'ur rst is 579', 'ur rst is 449' ] },
                    { id: '8DC',
                      name: '8d Calls B V',
                      phrases: ['BV2AA', 'BA1RO', 'WB2AE', 'N6RB/4', 'W2/VE1AR', 'VE2/W2LE'] },
                    { id: '9AC',
                      name: '9a Characters J K 8 0 <BT>',
                      phrases: ['J', 'K', '8', '0', '<BT>', 'J J J', 'K K K', '8 8 8', '0 0 0', '<BT> <BT> <BT>', 'B B B', 'V V V'] },
                    { id: '9BW',
                      name: '9b Words J K 8 0 <BT>',
                      phrases: ['jack', 'jay', 'john', 'jim', 'jerry', 'back', 'rack', 'tack', 'tech', 'tach', 'reach', 'each', 'teach', 'help', 'high', 'hill', 'fact', 'face', 'far', 'fear', 'then', 'their', 'him', 'her', 'his', 'hers', 'them', 'they', 'their', 'switch', 'line', 'ant', 'dipole', 'vertical', 'ohms', 'home', 'away', 'test', 'asia', 'africa', '807', '3500Z', '4250A'] },
                    { id: '9CP',
                      name: '9c Phrases J K 8 0 <BT>',
                      phrases: ['hw is he?', 'name is joe <BT> age is 49', 'name is john <BT> age is 66', 'name is jim <BT> age is 17', 'name is fred <BT> age is 44', 'name is tom <BT> age is 72', 'name is john <BT> age is 23', 'name is bob <BT> age is 51', 'ur rst is 549', 'ur rst is 579', 'ur rst is 339', 'sri no cpy'] },
                    { id: '9DC',
                      name: '9d Calls J K 8 0 <BT>',
                      phrases: ['K1JD', 'N1AR', 'W2TT', 'K2UMU', 'N2NW', 'VE3NE', 'VA3KP', 'K4BAI', 'N5KO'] },
                    { id: '10AC',
                      name: '10a Characters X Q Z <BK>',
                      phrases: ['X', 'Q', 'Z', '<BK>', 'x x x', 'q q q', 'z z z', '<BK> <BK> <BK>', 'k k k', 'j j j', '8 8 8', '0 0 0'] },
                    { id: '10BW',
                      name: '10b Words X Q Z <BK>',
                      phrases: ['wl', 'ur', 'ok', 'hw?', 'qrx', 'qrz', 'qth', 'qrs', 'qro', 'qrp', 'rig', 'wx', 'ant', 'pwr', 'kw', 'name', 'memphis', 'nyc', 'sf', 'dallas', 'houston', 'nm', 'nj', 'ca', 'ut', 'al', 'ar', 'il', 'in', 'me', 'ma', 'ct', 'co', 'qrm', 'ne', 'sd', 'nd', 'pa', 'ky', 'fl', 'nc', 'sc', 'sdgo', 'lax', 'la', 'on', 'sk', 'mb', 'nt', 'ab', 'qc', 'nb', 'ns', 'nr', 'rst', 'uk', 'usa', 'tokyo', 'paris', 'london', 'hamburg', 'sydney', '8044', '7400', '73'] },
                    { id: '10CP',
                      name: '10c Phrases X Q Z <BK>',
                      phrases: ['u hv qsb', 'u hv qrm', 'name?', 'qth?', 'qth is ny <BK>', 'qth is paris <BK>', 'pse qsy to 7054', 'ur rst is 579 <BK>', 'qth is nr tulsa <BK>', 'name is barry <BK>', 'ur rst is 559 <BK>', 'qth is dayton oh <BK>', 'name is john'] },
                    { id: '10DC',
                      name: '10d Calls X Q Z <BK>',
                      phrases: ['ZL2TT', 'VK4OM', 'JE1TRV', 'BA1CW', 'KH6LC', 'AL2A', 'AA3B'] } ] },
                { id: 'QTH',
                  name: 'Locations',
                  lessons: [
                    { id: 'ST',
                      name: 'States/Provinces',
                      phrases: ['AL', 'AK', 'AB', 'AR', 'AZ', 'BC', 'CO', 'CT', 'DE', 'EB', 'GA', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MB', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NM', 'NL', 'NC', 'ND', 'NT', 'OH', 'OK', 'ON', 'OR', 'PR', 'QC', 'RI', 'SK', 'SC', 'SD', 'TN', 'VI', 'UT', 'VT', 'VA', 'WV', 'WI', 'WY'] } ] } ];
            var canvas;

            var ui = {
                dialog: null,
                playing: false,
                hide: false,
                buttons: [],
                dialog: { left: 0, right: 0, top: 0, bottom: 0 },
                speed: 20,
                farnsworth: 5,
            };

            var audioCtx;
            var toneGain;
            var toneOscillator;
            var dingGain;
            var dingOscillator;
            var audioStarted = false;
            function startAudio() {
                say('');
                (new Audio('silent.wav')).play();
                audioCtx = new (AudioContext || webkitAudioContext)();
                toneOscillator = audioCtx.createOscillator();
                dingOscillator = audioCtx.createOscillator();
                toneOscillator.frequency.value = getPitch();
                dingOscillator.frequency.value = 2000;
                toneGain = audioCtx.createGain();
                dingGain = audioCtx.createGain();
                toneGain.gain.value = 0;
                dingGain.gain.value = 0;
                toneOscillator.connect(toneGain);
                dingOscillator.connect(dingGain);
                toneGain.connect(audioCtx.destination);
                dingGain.connect(audioCtx.destination);
                toneOscillator.start(0);
                dingOscillator.start(0);
                audioStarted = true;
            }

            var t = 0;
            function stopAudio() {
                if (audioStarted) {
                    audioCtx.close();
                    t = 0;
                    audioStarted = false;
                }
            }

            function playTone(len) {
                const ramp = 0.005;
                if (!audioStarted) startAudio();
                var c = audioCtx.currentTime;
                t = c > t ? c : t;
                toneGain.gain.setTargetAtTime(1, t, ramp);
                t += len;
                toneGain.gain.setTargetAtTime(0, t, ramp);
            }

            function silence(len) {
                t += len;
            }

            function say(utterance) {
                var utter = '';
                for (var i in utterance) {
                    var c = utterance[i];
                    if (c == c.toUpperCase()) {
                        var spell = {
                            'A': 'alfa',
                            'B': 'bravo',
                            'C': 'charlie',
                            'D': 'delta',
                            'E': 'echo',
                            'F': 'foxtrot',
                            'G': 'golf',
                            'H': 'hotel',
                            'I': 'india',
                            'J': 'juliet',
                            'K': 'key-low', // kilo
                            'L': 'leema', // lima
                            'M': 'mike',
                            'N': 'november',
                            'O': 'oscar',
                            'P': 'papa',
                            'Q': 'quebec',
                            'R': 'romeo',
                            'S': 'sierra',
                            'T': 'tango',
                            'U': 'uniform',
                            'V': 'victor',
                            'W': 'whiskey',
                            'X': 'x-ray',
                            'Y': 'yanky',
                            'Z': 'zulu',
                            '1': 'one',
                            '2': 'two',
                            '3': 'three', // tree?
                            '4': 'four', // fower?
                            '5': 'five', // fife?
                            '6': 'six',
                            '7': 'seven',
                            '8': 'eight',
                            '9': 'niner',
                            '0': 'zero',
                            '?': 'question mark',
                            '.': 'full stop',
                            ',': 'comma',
                            ':': 'colon',
                            '-': 'dash',
                            ';': 'semicolon',
                            '!': 'exclamation point',
                            '/': 'slash',
                            "'": 'apostrophe',
                            '"': 'quotation mark',
                            '_': 'underscore',
                            '=': 'double dash',
                            '&': 'ampersand',
                            '$': 'dollar sign',
                            '(': 'left parenthesis',
                            ')': 'right parenthesis',
                            '+': 'plus',
                            '@': 'at sign',
                            '<': ' ', // nothing
                            '>': 'pro-sign',
                        }[c];
                        utter += ' ' + (spell || c) + ' ';
                    } else {
                        utter += c;
                    }
                }
                if ('speechSynthesis' in window) {
                    speechSynthesis.speak(new SpeechSynthesisUtterance(utter));
                }
            }

            function playDing() {
                if (!audioStarted) startAudio();
                var c = audioCtx.currentTime;
                t = c > t ? c : t;
                dingGain.gain.linearRampToValueAtTime(0.3, t + 0.005);
                t += 2.5;
                dingGain.gain.exponentialRampToValueAtTime(0.000001, t);
            }

            var morse = "  ETIANMSURWDKGOHVF L PJBXCYZQ  54 3   2& +    16=/   ( 7   8 90     $      ?_    \"  .    @   '  -        ;! )     ,    :";
            var playContinuation = function() {};
            var continuationTimeout0 = null;
            var continuationTimeout1 = null;

            function stopPhrase() {
                playContinuation = function() {};
                if (continuationTimeout0) clearTimeout(continuationTimeout0);
                if (continuationTimeout1) clearTimeout(continuationTimeout1);
                if (ui.hide) {
                    ui.hide = false;
                    redraw();
                }
            }

            function getCurrentPhrase() {
                return getContent().lessons[getLessonNum()].phrases[getPhraseNum()]
            }

            function encodePhrase(phrase) {
                function trim(str) { return str.endsWith(' ') ? str.substring(0, str.length - 1) : str; }
                var prosign = false;
                var code = '';
                for (var i in phrase) {
                    var c = phrase[i];
                    if (c == ' ') { // word break
                        code = trim(code) + '/';
                    } else {
                        if (c == '<') prosign = true;
                        if (c == '>') prosign = false;
                        var letter = '';
                        var j = morse.indexOf(c.toUpperCase());
                        while (j > 1) {
                            if (j % 2 == 0) {
                                letter = '.' + letter;
                                j /= 2;
                            } else {
                                letter = '-' + letter;
                                j = (j - 1) / 2;
                            }
                        }
                        code += letter;
                        if (!prosign) {
                            code += ' ';
                        }
                    }
                }
                return trim(code);
            }

            function playCode(code) {
                function continuation(j) {
                    if (code.length > j) {
                        var continueCode = code.substring(j);
                        continuationTimeout0 = setTimeout(
                            function() { playCode(continueCode); },
                            (t - startTime) * 1000);
                    }
                }
                if (!audioStarted) startAudio();
                var startTime = audioCtx.currentTime;
                for (var i = 0; i < code.length; i++) {
                    switch (code[i]) {
                        case '.':
                            playTone(ditlen);
                            silence(ditlen);
                            break;
                        case '-':
                            playTone(ditlen * 3);
                            silence(ditlen);
                            break;
                        case ' ':
                            silence(fditlen * 3);
                            continuation(i + 1);
                            return;
                        case '/':
                            silence(fditlen * 7);
                            continuation(i + 1);
                            return;
                    }
                }
            }

            function playPhrase(phrase, speakAndAdvance) {
                function codeMilliseconds(code) {
                    var s = 0;
                    for (var i = 0; i < code.length; i++) {
                        switch (code[i]) {
                            case '.':
                                s += ditlen * 2;
                                break;
                            case '-':
                                s += ditlen * 4;
                                break;
                            case ' ':
                                s += fditlen * 3;
                                break;
                            case '/':
                                s += fditlen * 7;
                                break;
                        }
                    }
                    return s * 1000;
                }
                if (speakAndAdvance && !ui.hide) {
                    ui.hide = true;
                    redraw();
                }
                var code = encodePhrase(phrase);
                playCode(code);
                const trainingSpeechPause = 2000;
                const trainingSpeechCharacterPause = 110;
                var delay = codeMilliseconds(code) + fditlen * 7 * 1000;
                if (speakAndAdvance) {
                    continuationTimeout1 = setTimeout(
                        function () {
                            if (ui.playing) {
                                playDing();
                                continuationTimeout1 = setTimeout(
                                    function () {
                                        if (ui.playing) {
                                            ui.hide = false;
                                            redraw();
                                            var phrase = getCurrentPhrase();
                                            say(phrase);
                                            continuationTimeout1 = setTimeout(
                                                function () {
                                                    if (ui.playing) {
                                                        nextPhrase(true);
                                                        redraw();
                                                        playPhrase(getCurrentPhrase(), speakAndAdvance, false);
                                                    }
                                                },
                                                trainingSpeechPause + phrase.length * trainingSpeechCharacterPause);
                                        }
                                    },
                                    trainingSpeechPause);
                            }
                        },
                        delay);
                } else {
                    continuationTimeout1 = setTimeout(
                        function () {
                            if (ui.playing) {
                                ui.playing = false;
                                redraw();
                            }
                        },
                        delay);

                }
            }

            function getContent() {
                var id = localStorage.getItem('content');
                var content = library.find(c => c.id == id);
                if (content) return content;
                var dflt = library[0];
                localStorage.setItem('content', dflt.id);
                return dflt;
            }

            function setContent(id) {
                localStorage.setItem('content', id);
            }

            function getLessonNum() {
                var content = getContent();
                var id = localStorage.getItem('lesson_' + content.id);
                if (id) {
                    for (var i = 0; i < content.lessons.length; i++) {
                        if (content.lessons[i].id == id) return i;
                    }
                    alert('Missing lesson: ' + id);
                    localStorage.setItem('lesson_' + content.id, content.lessons[0].id);
                }
                return 0;
            }

            function setLessonNum(num) {
                var content = getContent();
                localStorage.setItem('lesson_' + content.id, content.lessons[num].id);
            }

            function setLesson(id) {
                var lessons = getContent().lessons;
                for (var i = 0; i < lessons.length; i++) {
                    if (lessons[i].id == id) {
                        setLessonNum(i);
                        return;
                    }
                }
            }

            function getIntSetting(name, dflt) {
                return parseInt(localStorage.getItem(name) || dflt);
            }

            function getPhraseNum() {
                var content = getContent();
                var phrase = getIntSetting('phrase_' + content.id, 0);
                if (phrase >= 0 && phrase < content.lessons[getLessonNum()].phrases.length) return phrase;
                alert('Missing phrase: ' + phrase);
                localStorage.setItem('phrase_' + content.id, 0);
                return 0;
            }

            function setPhraseNum(num) {
                var content = getContent();
                localStorage.setItem('phrase_' + content.id, num);
            }

            function getDarkMode() {
                return (localStorage.getItem('mode') || 'dark') == 'dark';
            }

            function setDarkMode(dark) {
                localStorage.setItem('mode', dark ? 'dark' : 'light');
            }

            var ditlen;
            var fditlen;
            function computeSpeedVariables(wpm, farnsworth) {
                ditlen = 1.2 / wpm;
                fditlen = (60 / farnsworth - 31 * ditlen) / 19;
            }

            function setSpeed(wpm) {
                localStorage.setItem('speed', wpm);
                computeSpeedVariables(wpm, getFarnsworth());
            }

            function getSpeed() {
                return getIntSetting('speed', 25);
            }

            function setFarnsworth(farnsworthWpm) {
                localStorage.setItem('farnsworth', farnsworthWpm);
                computeSpeedVariables(getSpeed(), farnsworthWpm);
            }

            function getFarnsworth() {
                return getIntSetting('farnsworth', 5);
            }

            function setPitch(hz) { // TODO
                localStorage.setItem('pitch', hz);
                if (audioStarted) toneOscillator.frequency.value = hz;
            }

            function getPitch() { // TODO
                return getIntSetting('pitch', 650);
            }

            function resizeCanvas() {
                var ratio = devicePixelRatio;
                var w = window.innerWidth;
                var h = window.innerHeight;
                //var w = document.body.clientWidth;
                //var h = document.body.clientHeight;
                canvas.width = w * ratio;
                canvas.height = h * ratio;
                canvas.style.width = w + 'px';
                canvas.style.height = h + 'px';
            }

            function redraw() {
                const phraseTextColor = '#f43'; // red
                const lessonTextColor = '#07d'; // blue
                const phraseNumTextColor = '#2c4'; // green
                const dimColor = '#000b';

                var darkMode = getDarkMode();
                var backgroundColor = darkMode ? '#111' : '#eee'; // black/white
                var foregroundColor = darkMode ? '#eee' : '#111'; // white/black
                var mainButtonColor = foregroundColor;
                var subduedButtonColor = darkMode ? '#ccc' : '#333'; // gray
                var disabledButtonColor = darkMode ? '#333' : '#ccc'; // gray
                var dialogBackgroundColor = darkMode ? '#222' : '#ddd';
                var dialogAttributionColor = darkMode ? '#444' : '#bbb';

                var ctx = canvas.getContext('2d');
                ctx.scale(1, 1);
                var w = canvas.width;
                var h = canvas.height;

                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, w, h);
                document.body.style.backgroundColor = backgroundColor;

                function drawFittedText(txt, color, x, y, width, height, weight, actual, align) {
                    ctx.fillStyle = color;
                    function setFont(size) { ctx.font = weight + ' ' + size + 'px sans-serif'; }
                    const sampleSize = 100;
                    setFont(sampleSize);
                    var size = ctx.measureText(txt);
                    var ascent = actual ? size.actualBoundingBoxAscent : size.fontBoundingBoxAscent;
                    var descent = actual ? size.actualBoundingBoxDescent : size.fontBoundingBoxDescent;
                    var textHeight = ascent + descent;
                    var textWidth = size.actualBoundingBoxLeft + size.actualBoundingBoxRight;
                    var scale = Math.min(width / textWidth, height / textHeight);
                    setFont(scale * sampleSize);
                    ctx.textAlign = align;
                    ctx.fillText(txt, x + (align == 'center' ? width / 2 : align == 'left' ? 0 : width), y + ascent * scale + (height - textHeight * scale) / 2);
                }

                function fillRoundedRect(left, top, right, bottom, radius, color) {
                    ctx.beginPath();
                    ctx.moveTo(left + radius, top);
                    ctx.lineTo(right - radius, top);
                    ctx.arcTo(right, top, right, top + radius, radius);
                    ctx.lineTo(right, bottom - radius);
                    ctx.arcTo(right, bottom, right - radius, bottom, radius);
                    ctx.lineTo(left + radius, bottom);
                    ctx.arcTo(left, bottom, left, bottom - radius, radius);
                    ctx.lineTo(left, top + radius);
                    ctx.arcTo(left, top, left + radius, top, radius);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                }

                var padding = Math.min(canvas.width / 24, canvas.height / 24);

                var buttons = [];
                function drawButton(name, label, color, x, y, width, height, align, actual = true) {
                    drawFittedText(label, color, x, y, width, height, 'normal', actual, align);
                    var p = padding / 2;
                    buttons.push({
                        name: name,
                        left: x - p,
                        top: y - p,
                        right: x + width + p,
                        bottom: y + height + p })
                    // ctx.fillStyle = '#f00c';
                    // ctx.fillRect(x, y, width, height);
                }

                const numButtons = 5;
                const largeButton = 1.5;
                var buttonWidth = (w - (numButtons + 1) * padding) / (numButtons + largeButton - 1);
                var buttonSize = Math.min(buttonWidth, canvas.width / 12, canvas.height / 12);

                drawButton(
                    'settings',
                    '⁝',
                    subduedButtonColor,
                    w - padding - buttonSize,
                    padding, buttonSize, buttonSize,
                    'right');
                drawButton(
                    'prevLesson',
                    '⇤',
                    getLessonNum() > 0 ? subduedButtonColor : disabledButtonColor,
                    padding * 1 + buttonWidth * 0,
                    h - padding - buttonSize,
                    buttonWidth, buttonSize,
                    'left');
                drawButton(
                    'prevPhrase',
                    '⟲',
                    getPhraseNum() > 0 ? subduedButtonColor : disabledButtonColor,
                    padding * 2 + buttonWidth * 1,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize,
                    'center');
                drawButton(
                    'nextPhrase',
                    '⟳',
                    getPhraseNum() < getContent().lessons[getLessonNum()].phrases.length - 1 ? subduedButtonColor : disabledButtonColor,
                    padding * 4 + buttonWidth * 2 + buttonWidth * largeButton,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize,
                    'center');
                drawButton(
                    'nextLesson',
                    '⇥',
                    getLessonNum() < getContent().lessons.length - 1 ? subduedButtonColor : disabledButtonColor,
                    padding * 5 + buttonWidth * 3 + buttonWidth * largeButton,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize,
                    'right');
                drawButton(
                    'playPause',
                    ui.playing ? 'II' : '▸',
                    foregroundColor,
                    padding * 3 + buttonWidth * 2,
                    h - padding - buttonSize * largeButton,
                    buttonWidth * largeButton,
                    buttonSize * largeButton,
                    'center');
                ui.buttons = buttons;

                drawButton(
                    'content',
                    '☰',
                    subduedButtonColor,
                    padding / 2,
                    padding,
                    buttonSize,
                    buttonSize,
                    'left');
                drawButton(
                    'lesson',
                    getContent().lessons[getLessonNum()].name,
                    lessonTextColor,
                    padding * 2 + buttonSize,
                    padding,
                    w - padding * 5 - buttonSize * 3,
                    buttonSize,
                    'left');
                drawButton(
                    'phraseNum',
                    getPhraseNum() + 1,
                    phraseNumTextColor,
                    w - padding * 2 - buttonSize * 2,
                    padding,
                    buttonSize,
                    buttonSize,
                    'right');
                var phraseX = padding;
                var phraseY = buttonSize + padding * 2;
                var phraseWidth = w - padding * 2;
                var phraseHeight = h - padding * 4 - buttonSize - buttonSize * largeButton;
                drawFittedText(
                    ui.hide ? '?' : getContent().lessons[getLessonNum()].phrases[getPhraseNum()], 
                    ui.hide ? disabledButtonColor : phraseTextColor,
                    phraseX,
                    phraseY,
                    phraseWidth,
                    phraseHeight,
                    'bold',
                    false,
                    'center');
                ui.buttons.push({
                    name: 'phrase',
                    left: phraseX - padding,
                    top: phraseY - padding,
                    right: phraseWidth + padding,
                    bottom: phraseHeight + padding })
                if (ui.show == 'settings') {
                    ctx.fillStyle = dimColor;
                    ctx.fillRect(0, 0, w, h);
                    const attributionHeight = padding;
                    var left = padding * (w > h ? 4 : 1);
                    var right = w - padding * (w > h ? 4 : 1);
                    var top = padding * (h > w ? 4 : 1);
                    var bottom = top + buttonSize * 4 + padding * 6 + attributionHeight;
                    ui.dialog = {
                        left: left,
                        right: right,
                        top: top,
                        bottom: bottom
                    };
                    fillRoundedRect(left, top, right, bottom, padding, dialogBackgroundColor);
                    drawFittedText(
                        'Feedback to Ashley 73 de KK7HXU',
                        dialogAttributionColor,
                        left + padding,
                        bottom - padding - attributionHeight,
                        right - left - padding * 2,
                        attributionHeight,
                        'normal',
                        false,
                        'center');
                    drawFittedText(
                        'Light/Dark:',
                        subduedButtonColor,
                        left + padding,
                        top + padding,
                        right - padding - buttonSize * 3,
                        buttonSize,
                        'normal',
                        false,
                        'left');
                    controlLeft = right - padding - buttonSize * 3;
                    const switchThinFactor = 1.1;
                    fillRoundedRect(
                        controlLeft + padding * switchThinFactor,
                        top + padding * switchThinFactor,
                        right - padding * switchThinFactor - padding,
                        top + padding / switchThinFactor + buttonSize,
                        buttonSize / switchThinFactor / 2,
                        subduedButtonColor);
                    var dark = getDarkMode();
                    ctx.beginPath();
                    ctx.arc(
                        (dark ? right - padding * 2 - buttonSize : controlLeft + padding) + buttonSize / 2,
                        top + padding + buttonSize / 2,
                        buttonSize / 2,
                        0,
                        2 * Math.PI,
                        false);
                    ctx.fillStyle = backgroundColor;
                    ctx.fill();
                    ctx.lineWidth = padding / 10;
                    ctx.strokeStyle = subduedButtonColor;
                    ctx.stroke();
                    var margin = buttonSize / 4;
                    drawFittedText(
                        dark ? '☽' : '☼',
                        subduedButtonColor,
                        (dark ? right - padding * 2 - buttonSize : controlLeft + padding) + margin,
                        top + padding + margin,
                        buttonSize - margin * 2,
                        buttonSize - margin * 2,
                        'normal',
                        true,
                        'center');
                    buttons.push({
                        name: 'mode',
                        left: controlLeft,
                        top: top,
                        right: right,
                        bottom: top + buttonSize + padding / 2 })
                    function drawUpDownControl(label, name, val, min, max, row) {
                        drawFittedText(
                            label,
                            subduedButtonColor,
                            left + padding,
                            row,
                            right - padding - buttonSize * 3,
                            buttonSize,
                            'normal',
                            false,
                            'left');
                        const arrowScale = 0.5;
                        drawFittedText(
                            '❰',
                            val <= min ? disabledButtonColor : subduedButtonColor,
                            controlLeft,
                            row + (buttonSize * arrowScale / 2),
                            buttonSize * arrowScale,
                            buttonSize * arrowScale,
                            'normal',
                            true,
                            'center');
                        if (val > min) {
                            buttons.push({
                                name: name + 'Down',
                                left: controlLeft,
                                top: row,
                                right: controlLeft + buttonSize,
                                bottom: row + buttonSize
                            });
                        }
                        drawButton(
                            name,
                            val,
                            subduedButtonColor,
                            controlLeft + buttonSize,
                            row,
                            buttonSize,
                            buttonSize,
                            'center')
                        drawFittedText(
                            '❱',
                            val >= max ? disabledButtonColor : subduedButtonColor,
                            controlLeft + buttonSize * 2 + buttonSize * arrowScale,
                            row + (buttonSize * arrowScale / 2),
                            buttonSize * arrowScale,
                            buttonSize * arrowScale,
                            'normal',
                            true,
                            'center');
                        if (val < max) {
                            buttons.push({
                                name: name + 'Up',
                                left: controlLeft + buttonSize * 2,
                                top: row,
                                right: controlLeft + buttonSize * 4,
                                bottom: row + buttonSize });
                        }
                    }
                    drawUpDownControl('Speed', 'speed', getSpeed(), 5, 50, top + padding * 2 + buttonSize);
                    drawUpDownControl('Farnsworth', 'farnsworth', getFarnsworth(), 1, 50, top + padding * 3 + buttonSize * 2);
                    drawUpDownControl('Pitch', 'pitch', getPitch(), 100, 900, top + padding * 4 + buttonSize * 3);
                    ui.buttons = buttons;
                }
                function drawMenu(len, fnGetId, fnGetName) {
                    ctx.fillStyle = dimColor;
                    ctx.fillRect(0, 0, w, h);
                    var left = padding * (w > h ? 4 : 1);
                    var right = w - padding * (w > h ? 4 : 1);
                    var top = padding * (h > w ? 4 : 1);
                    var bottom = h - padding * (h > w ? 4 : 1) - padding;
                    var rowHeight = (bottom - top - padding * 2) / len;
                    if (rowHeight > buttonSize + padding * 2) {
                        rowHeight = buttonSize + padding * 2;
                        bottom = top + padding * 2 + rowHeight * len;
                    }
                    ui.dialog = {
                        left: left,
                        right: right,
                        top: top,
                        bottom: bottom
                    };
                    var rowWidth = right - left - padding * 2;
                    fillRoundedRect(left, top, right, bottom, padding, dialogBackgroundColor);
                    for (var i = 0; i < len; i++) {
                        drawButton(
                            'menu_' + fnGetId(i),
                            fnGetName(i),
                            subduedButtonColor,
                            left + padding,
                            top + padding + rowHeight * i,
                            rowWidth,
                            rowHeight,
                            'left',
                            false)
                    }
                }
                switch (ui.show) {
                    case 'content':
                        drawMenu(library.length, i => library[i].id, i => library[i].name);
                        break;
                    case 'lesson':
                        //var lessons = getContent().lessons;
                        //drawMenu(lessons.length, i => lessons[i].id, i => lessons[i].name);
                        break;
                    case 'phrase':
                        //var phrases = getContent().lessons[getLessonNum()].phrases;
                        //drawMenu(phrases.length, p => p, p => (p + 1) + ' ' + phrases[p]);
                        break;
                }
            }

            function prevLesson() {
                var lesson = getLessonNum();
                if (lesson > 0) setLessonNum(lesson - 1);
                setPhraseNum(0);
            }

            function nextLesson() {
                var lesson = getLessonNum();
                if (lesson < getContent().lessons.length - 1) setLessonNum(lesson + 1);
                setPhraseNum(0);
            }

            function prevPhrase() {
                var phrase = getPhraseNum();
                if (phrase > 0) setPhraseNum(phrase - 1);
            }

            function nextPhrase(autoAdvanceLesson) {
                var phrase = getPhraseNum();
                if (phrase < getContent().lessons[getLessonNum()].phrases.length - 1) {
                    setPhraseNum(phrase + 1);
                } else if (autoAdvanceLesson) {
                    nextLesson();
                    setPhraseNum(0);
                }
            }

            function dismissDialog(x, y) {
                if (x < ui.dialog.left || x > ui.dialog.right || y < ui.dialog.top || y > ui.dialog.bottom) {
                    ui.show = null;
                    redraw();
                    return true;
                }
                return false;
            }

            function selectDialogMenu(x, y, fnSelect) {
                if (dismissDialog(x, y)) return;
                for (var b = ui.buttons.length - 1; b >= 0; b--) {
                    var button = ui.buttons[b];
                    if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                        fnSelect(button.name.substring(5)); // sans 'menu_'
                        ui.show = null;
                        redraw();
                        return;
                    }
                }
            }

            function touch(x, y) {
                if (ui.show == 'settings') {
                    if (dismissDialog(x, y)) return;
                    for (var b = 0; b < ui.buttons.length; b++) {
                        var button = ui.buttons[b];
                        if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                            switch (button.name) {
                                case 'mode':
                                    setDarkMode(!getDarkMode());
                                    redraw();
                                    return;
                                case 'speed':
                                    stopPhrase();
                                    playPhrase('r', false);
                                    return;
                                case 'speedUp':
                                    stopPhrase();
                                    setSpeed(getSpeed() + 1);
                                    redraw();
                                    playPhrase('vv', false);
                                    return;
                                case 'speedDown':
                                    stopPhrase();
                                    setSpeed(getSpeed() - 1);
                                    redraw();
                                    playPhrase('vv', false);
                                    return;
                                case 'farnsworth':
                                    stopPhrase();
                                    playPhrase('vv', false);
                                    return;
                                case 'farnsworthUp':
                                    stopPhrase();
                                    setFarnsworth(getFarnsworth() + 1);
                                    redraw();
                                    playPhrase('vv', false);
                                    return;
                                case 'farnsworthDown':
                                    stopPhrase();
                                    setFarnsworth(getFarnsworth() - 1);
                                    redraw();
                                    playPhrase('vv', false);
                                    return;
                                case 'pitch':
                                    stopPhrase();
                                    playPhrase('v', false);
                                    return;
                                case 'pitchUp':
                                    stopPhrase();
                                    setPitch(getPitch() + 10);
                                    redraw();
                                    playPhrase('v', false);
                                    return;
                                case 'pitchDown':
                                    stopPhrase();
                                    setPitch(getPitch() - 10);
                                    redraw();
                                    playPhrase('v', false);
                                    return;
                            }
                        }
                    }
                } else if (ui.show == 'content') {
                    selectDialogMenu(x, y, c => setContent(c));
                    return;
                } else if (ui.show == 'lesson') {
                    selectDialogMenu(x, y, c => setLesson(c));
                    return;
                } else if (ui.show == 'phrase') {
                    selectDialogMenu(x, y, c => setPhraseNum(c));
                    return;
                } else {
                    for (var b in ui.buttons) {
                        var button = ui.buttons[b];
                        if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                            switch (button.name) {
                                case 'settings':
                                    stopPhrase();
                                    ui.playing = false;
                                    ui.show = 'settings';
                                    redraw();
                                    return;
                                case 'content':
                                    stopPhrase();
                                    ui.playing = false;
                                    ui.show = 'content';
                                    redraw();
                                    return;
                                case 'lesson':
                                    stopPhrase();
                                    ui.playing = false;
                                    ui.show = 'lesson';
                                    redraw();
                                    return;
                                case 'phraseNum':
                                    stopPhrase();
                                    ui.playing = false;
                                    ui.show = 'phrase';
                                    redraw();
                                    return;
                                case 'phrase':
                                    stopPhrase();
                                    ui.playing = true;
                                    playPhrase(getCurrentPhrase(), false);
                                    redraw();
                                    return;
                                case 'playPause':
                                    stopPhrase();
                                    ui.playing = !ui.playing;
                                    if (ui.playing) playPhrase(getCurrentPhrase(), true);
                                    redraw();
                                    return;
                                case 'prevLesson':
                                    stopPhrase();
                                    ui.playing = false;
                                    prevLesson();
                                    redraw();
                                    return;
                                case 'nextLesson':
                                    stopPhrase();
                                    ui.playing = false;
                                    nextLesson(false);
                                    redraw();
                                    return;
                                case 'prevPhrase':
                                    stopPhrase();
                                    ui.playing = false;
                                    prevPhrase();
                                    redraw();
                                    return;
                                case 'nextPhrase':
                                    stopPhrase();
                                    ui.playing = false;
                                    nextPhrase(false);
                                    redraw();
                                    return;
                            }
                        }
                    }
                }
            }

            function migrateSettings() {
                function migrateV0toV1() {
                    // v0 had only CWOPS content (no 'content' setting) and a single 'lesson'/'phrase'
                    var lessonNum = localStorage.getItem('lesson');
                    var phraseNum = localStorage.getItem('phrase');
                    if (lessonNum && phraseNum) {
                        localStorage.setItem('content', 'CWOPS');
                        localStorage.removeItem('lesson');
                        localStorage.setItem('lesson_CWOPS', library.find(c => c.id == 'CWOPS').lessons[lessonNum].id);
                        localStorage.removeItem('phrase');
                        localStorage.setItem('phrase_CWOPS', phraseNum);
                        localStorage.setItem('version', 1);
                    }
                }
                try
                {
                    var version = localStorage.getItem('version') || '0';
                    if (version == '0') migrateV0toV1()
                } catch (e) {
                    alert('Settings migration error: ' + e);
                    localStorage.clear();
                }
            }

            function testMigration() {
                localStorage.removeItem('version'); // v0
                localStorage.setItem('lesson', 3);
                localStorage.setItem('phrase', 4);
                migrateSettings();
            }

            onload = function() {
                if (location.search == '?clear-settings') localStorage.clear();
                //testMigration();
                migrateSettings();
                var ratio = devicePixelRatio;
                canvas = document.getElementById('canvas');
                canvas.onmousedown = function(e) { e.preventDefault(); touch(e.x * ratio, e.y * ratio); };

                resizeCanvas();
                redraw();
                setSpeed(getSpeed());
                setFarnsworth(getFarnsworth());
                document.onvisibilitychange = function(e) {
                    if (document.hidden) {
                        stopPhrase();
                        stopAudio();
                        ui.playing = false;
                        redraw();
                    }
                };
            }

            onresize = function() {
                resizeCanvas();
                redraw();
            }
        </script>
    </head>
    <body class="dark">
        <canvas id="canvas"></canvas>
    </body>
    <!--
        TODO:
        - Hilight characters upon main tap
        - Tap/hold to speed advance
        - Random playback?
        - Quick lesson picker?
        - Course picker?
        - Keyboard control for desktop
        - Flag to speak numbers (e.g. "#42" -> "fourty-two", "42" -> "four two")

        BUGS:
        - Speech length is only estimated
    -->
</html>
