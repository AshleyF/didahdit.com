<html>
    <head>
        <title>Learn Morse Code</title>
        <style>body { margin: 0; padding: 0; }</style>
        <script>
            var lessons = [
                { name: 'E T A N — 1a Characters',
                  phrases: ['E', 'T', 'A', 'N', 'E E E', 'T T T', 'A A A', 'N N N'] },
                { name: 'E T A N — 1b Words',
                  phrases: ['tea', 'tee', 'eat', 'ate', 'at', 'tat', 'teen', 'neat', 'ten', 'net', 'tan'] },
                { name: 'E T A N — 1c Sentences',
                  phrases: ['eat at ten', 'ate at ten', 'at tee'] },
                { name: 'O I S 1 4 — 2a Characters',
                  phrases: ['O', 'I', 'S', '1', '4', 'O O O', 'I I I', 'S S S', '1 1 1', '4 4 4', 'T T T', 'E E E', 'A A A', 'N N N'] },
                { name: 'O I S 1 4 — 2b Words',
                  phrases: ['ten', 'ton', 'tin', 'tie', 'toe', 'no', 'not', 'note', 'it', 'at', 'one', 'neat', 'net', 'nit', 'toes', 'stone', 'tease', 'noise'] },
                { name: 'O I S 1 4 — 2c Sentences',
                  phrases: ['one neat note', 'no noise', 'tie it', '1 ton stone'] },
                { name: 'O I S 1 4 — 2d Calls',
                  phrases: ['N1AS', 'N4ON', 'S41T', 'NO1S', 'AI1E', 'IT4O', 'EA1ON', 'ES4IT'] },
                { name: 'R H D L 2 5 — 3a Characters',
                  phrases: ['R', 'H', 'D', 'L', '2', '5', 'R R R', 'H H H', 'D D D', 'L L L', '2 2 2', '5 5 5', 'O O O', 'I I I', 'S S S'] },
                { name: 'R H D L 2 5 — 3b Words',
                  phrases: ['all', 'tell', 'tall', 'deal', 'the', 'their', 'doll', 'dell', 'hall', 'hill', 'hole', 'load', 'lead ', 'late', 'later', 'seal', 'sell', 'sole', 'she', 'shed', 'her', 'hear', '142', '451', '1425'] },
                { name: 'R H D L 2 5 — 3b Sentences',
                  phrases: ['a tall hill', 'she is here', 'he is late', '4 sheds', '12 hills'] },
                { name: 'R H D L 2 5 — 3c Calls',
                  phrases: ['DL1AT', 'HH5H', 'HS1TD', 'ND2T', 'NA4T'] },
                { name: 'U C - 4a Characters',
                  phrases: ['U U U', 'C C C', 'R R R', 'H H H', 'D D D', 'L L L', '1 1 1', '4 4 4'] },
                { name: 'U C - 4b Words',
                  phrases: ['chat', 'chair', 'chin', 'chart', 'ouch', 'couch', 'touch', 'such', 'teach', 'reach', 'sun', 'son', 'hold', 'told', 'sail', 'rail', 'tail', 'nail', 'oil', 'soil', 'toil', 'coil', 'rain', 'cause', 'sauce', 'toss', 'toll', 'tall', 'tell', 'cell', 'call', '4241', '1452'] },
                { name: 'U C - 4c Sentences',
                  phrases: ['in the cell', 'that hurts', 'at the hall', 'hole in 1', 'sail on sailor', 'tell all', 'hold on'] },
                { name: 'U C - 4d Calls',
                  phrases: ['NC5A', 'NA2T', 'CU1LL', 'CO5NO', 'NU4R', 'CT1AC', 'CE1NI'] },
                { name: 'M W 3 6 ? - 5a Characters',
                  phrases: ['M', 'W', '3', '6', '?', 'M M M', 'W W W', '3 3 3', '6 6 6', '? ? ?', 'U U U', 'C C C', '2 2 2', '5 5 5'] },
                { name: 'M W 3 6 ? - 5b Words',
                  phrases: ['wait', 'wall', 'well', 'will', 'mall', 'mill', 'chum', 'mow', 'much', 'such', 'water', 'wet', 'what', 'dew', 'date', 'atom', 'tow', 'tower', 'were', 'where', 'was', 'wish', 'wash', 'mat', 'matt', 'mel', 'him', 'her', 'his', 'hw?'] },
                { name: 'M W 3 6 ? - 5c Sentences',
                  phrases: ['well water', 'how is it?', 'is this it?', 'this is it', 'this is it', '1432 hill street', '1 and 4 is 5'] },
                { name: 'M W 3 6 ? - 5d Calls',
                  phrases: ['W3AA', 'N3AM', 'DM5RA', 'W6AM', 'N2AT', 'RW5L', 'ON4UN', '335', '1432', '6122'] },
            ];

            var canvas;

            var ui = {
                playing: false,
                hide: false,
                buttons: [],
            };

            var audioCtx;
            var audioStarted = false;
            function startAudio() {
                audioCtx = new (AudioContext || webkitAudioContext)();
                var oscillator = audioCtx.createOscillator();
                oscillator.frequency.value = 750;
                gain = audioCtx.createGain();
                gain.gain.value = 0;
                oscillator.connect(gain);
                gain.connect(audioCtx.destination);
                oscillator.start(0);
                audioStarted = true;
            }

            var t = 0;
            function playTone(len) {
                const ramp = 0.01;
                if (!audioStarted) startAudio();
                var c = audioCtx.currentTime;
                t = c > t ? c : t;
                gain.gain.setTargetAtTime(1, t, ramp);
                t += len;
                gain.gain.setTargetAtTime(0, t, ramp);
                t += ditlen;
            }

            function silence(len) {
                t += len;
            }

            var ditlen;
            function setSpeed(wpm) {
                ditlen = 1.2 / wpm;
            }

            var farnsworth;
            function setFarnsworth(dits) {
                farnsworth = dits;
            }

            function say(utterance) {
                var utter = '';
                for (var i in utterance) {
                    var c = utterance[i];
                    if (c == c.toUpperCase()) {
                        var spell = {
                            'A': 'ay',
                            'B': 'bee',
                            'C': 'cee',
                            'D': 'dee',
                            'E': 'ee',
                            'F': 'ef',
                            'G': 'gee',
                            'H': 'aych',
                            'I': 'eye',
                            'J': 'jay',
                            'K': 'kay',
                            'L': 'el',
                            'M': 'em',
                            'N': 'in',
                            'O': 'oh',
                            'P': 'pee',
                            'Q': 'cue',
                            'R': 'ar',
                            'S': 'ess',
                            'T': 'tee',
                            'U': 'you',
                            'V': 'vee',
                            'W': 'double you',
                            'X': 'ex',
                            'Y': 'wye',
                            'Z': 'zee',
                            '?': 'question mark',
                            '.': 'full stop',
                            ',': 'comma',
                            ':': 'colon',
                            '-': 'dash',
                            ';': 'semicolon',
                            '!': 'exclamation point',
                            '/': 'slash',
                            "'": 'apostrophe',
                            '"': 'quotation mark',
                            '_': 'underscore',
                            '=': 'double dash',
                            '&': 'ampersand',
                            '$': 'dollar sign',
                            '(': 'left parenthesis',
                            ')': 'right parenthesis',
                            '+': 'plus',
                            '@': 'at sign',
                            '<': ' ', // nothing
                            '>': 'prosign',
                        }[c];
                        utter += ' ' + (spell || c) + ' ';
                    } else {
                        utter += c;
                    }
                }
                if ('speechSynthesis' in window) {
                    speechSynthesis.speak(new SpeechSynthesisUtterance(utter));
                }
            }

            var morse = "  ETIANMSURWDKGOHVF L PJBXCYZQ  54 3   2& +    16=/   ( 7   8 90     $      ?_    \"  .    @   '  -        ;! )     ,    :";
            var playContinuation = function() {};
            var playContinuationTimeoutId = null;

            function stopPhrase() {
                playContinuation = function() {};
                if (playContinuationTimeoutId) {
                    clearTimeout(playContinuationTimeoutId);
                    if (ui.hide) {
                        ui.hide = false;
                        redraw();
                    }
                }
            }

            function getCurrentPhrase() {
                return lessons[getLesson()].phrases[getPhrase()]
            }

            function playPhrase(phrase, speakAndAdvance) {
                if (speakAndAdvance && !ui.hide) {
                    ui.hide = true;
                    redraw();
                }
                var prosign = false;
                if (!audioStarted) startAudio();
                var startTime = audioCtx.currentTime;
                var c = phrase[0];
                if (c == ' ') { // word break
                    silence(ditlen * 7 + (ditlen * farnsworth));
                } else {
                    if (c == '<') prosign = true;
                    if (c == '>') prosign = false;
                    var j = morse.indexOf(c.toUpperCase());
                    var letter = [];
                    while (j > 1) {
                        if (j % 2 == 0) {
                            letter.push(true);
                            j /= 2;
                        } else {
                            letter.push(false);
                            j = (j - 1) / 2;
                        }
                    }
                    letter.reverse();
                    for (var j in letter) {
                        playTone(letter[j] ? ditlen : ditlen * 3);
                        silence(ditlen);
                    }
                    if (!prosign) {
                        silence(ditlen * 3 + (ditlen * farnsworth));
                    }
                }
                if (phrase.length > 1) {
                    var continuePhrase = phrase.substring(1);
                    playContinuationTimeoutId = setTimeout(
                        function() { playPhrase(continuePhrase, speakAndAdvance); },
                        (t - startTime) * 1000);
                } else {
                    const trainingSpeechPause = 2; // TODO: settings
                    if (speakAndAdvance) {
                        playContinuationTimeoutId = setTimeout(
                            function () {
                                ui.hide = false;
                                redraw();
                                say(getCurrentPhrase());
                            },
                            (t - startTime + trainingSpeechPause) * 1000);
                    }
                    setTimeout(
                        function () {
                            if (ui.playing) {
                                nextPhrase();
                                redraw();
                                playPhrase(getCurrentPhrase(), speakAndAdvance);
                            }
                        },
                        (t - startTime + trainingSpeechPause * 2) * 1000);
                }
            }

            function getIntSetting(name) {
                return parseInt(localStorage.getItem(name) || '0');
            }

            function getLesson() {
                return getIntSetting('lesson');
            }

            function setLesson(num) {
                localStorage.setItem('lesson', num);
            }

            function getPhrase() {
                return getIntSetting('phrase');
            }

            function setPhrase(num) {
                localStorage.setItem('phrase', num);
            }

            function getDarkMode() {
                return (localStorage.getItem('mode') || 'dark') == 'dark';
            }

            function setDarkMode(dark) {
                localStorage.setItem('mode', dark ? 'dark' : 'light');
            }

            function resizeCanvas() {
                //canvas.width = document.body.clientWidth;
                //canvas.height = document.body.clientHeight;

                var ratio = devicePixelRatio;
                var w = document.body.clientWidth;
                var h = document.body.clientHeight;
                canvas.width = w * ratio;
                canvas.height = h * ratio;
                canvas.style.width = w + 'px';
                canvas.style.height = h + 'px';
            }

            function redraw() {
                const phraseTextColor = '#f43'; // red
                const lessonTextColor = '#07d'; // blue
                const phraseNumTextColor = '#2c4'; // green

                var darkMode = getDarkMode();
                var backgroundColor = darkMode ? '#111' : '#eee'; // black/white
                var foregroundColor = darkMode ? '#eee' : '#111'; // white/black
                var mainButtonColor = foregroundColor;
                var subduedButtonColor = darkMode ? '#ccc' : '#333'; // gray
                var disabledButtonColor = darkMode ? '#333' : '#ddd'; // gray

                var ctx = canvas.getContext('2d');
                ctx.scale(1, 1);
                var ratio = devicePixelRatio;
                var w = canvas.width;
                var h = canvas.height;

                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, w, h);
                document.body.style.backgroundColor = backgroundColor;

                function drawFittedText(txt, color, x, y, width, height, weight, actual, centered) {
                    ctx.fillStyle = color;
                    function setFont(size) { ctx.font = weight + ' ' + size + 'px sans-serif'; }
                    const sampleSize = 100;
                    setFont(sampleSize);
                    var size = ctx.measureText(txt);
                    var ascent = actual ? size.actualBoundingBoxAscent : size.fontBoundingBoxAscent;
                    var descent = actual ? size.actualBoundingBoxDescent : size.fontBoundingBoxDescent;
                    var textHeight = ascent + descent;
                    var textWidth = size.actualBoundingBoxLeft + size.actualBoundingBoxRight;
                    var scale = Math.min(width / textWidth, height / textHeight);
                    setFont(scale * sampleSize);
                    ctx.textAlign = centered ? 'center' : 'left';
                    ctx.fillText(txt, x + (centered ? width / 2 : 0), y + ascent * scale + (height - textHeight * scale) / 2);
                }

                var padding = 40 * ratio;

                var buttons = [];
                function drawButton(name, label, color, x, y, width, height) {
                    drawFittedText(label, color, x, y, width, height, 'normal', true, true);
                    var p = padding / 2;
                    buttons.push({
                        name: name,
                        left: x - p,
                        top: y - p,
                        right: x + width + p,
                        bottom: y + height + p })
                }

                const numButtons = 5;
                const largeButton = 1.5;
                var buttonWidth = (w - (numButtons + 1) * padding) / (numButtons + largeButton - 1);
                var buttonHeight = Math.min(buttonWidth, canvas.width / 10, canvas.height / 10);

                drawButton(
                    'mode',
                    getDarkMode() ? '☼' : '☽',
                    subduedButtonColor,
                    w - padding - buttonHeight,
                    padding, buttonHeight, buttonHeight);
                drawButton(
                    'prevLesson',
                    '⇤',
                    getLesson() > 0 ? subduedButtonColor : disabledButtonColor,
                    padding * 1 + buttonWidth * 0,
                    h - padding - buttonHeight,
                    buttonWidth, buttonHeight);
                drawButton(
                    'prevPhrase',
                    '⟲',
                    subduedButtonColor,
                    padding * 2 + buttonWidth * 1,
                    h - padding - buttonHeight,
                    buttonWidth,
                    buttonHeight);
                drawButton(
                    'nextPhrase',
                    '⟳',
                    subduedButtonColor,
                    padding * 4 + buttonWidth * 2 + buttonWidth * largeButton,
                    h - padding - buttonHeight,
                    buttonWidth,
                    buttonHeight);
                drawButton(
                    'nextLesson',
                    '⇥',
                    getLesson() < lessons.length - 1 ? subduedButtonColor : disabledButtonColor,
                    padding * 5 + buttonWidth * 3 + buttonWidth * largeButton,
                    h - padding - buttonHeight,
                    buttonWidth,
                    buttonHeight);
                drawButton(
                    'playPause',
                     ui.playing ? 'II' : '▸',
                     foregroundColor,
                     padding * 3 + buttonWidth * 2,
                     h - padding - buttonHeight * largeButton,
                     buttonWidth * largeButton,
                     buttonHeight * largeButton);
                ui.buttons = buttons;

                drawFittedText(
                    lessons[getLesson()].name,
                    lessonTextColor,
                    padding,
                    padding,
                    w - padding * 6 - buttonHeight * 2,
                    buttonHeight,
                    'normal',
                    false,
                    false);
                drawFittedText(
                    getPhrase() + 1,
                    phraseNumTextColor,
                    w - padding * 3 - buttonHeight * 2,
                    padding,
                    buttonHeight,
                    buttonHeight,
                    'normal',
                    false,
                    false);
                var phraseX = padding;
                var phraseY = buttonHeight + padding * 2;
                var phraseWidth = w - padding * 2;
                var phraseHeight = h - padding * 4 - buttonHeight - buttonHeight * largeButton;
                drawFittedText(
                    ui.hide ? '?' : lessons[getLesson()].phrases[getPhrase()], 
                    ui.hide ? disabledButtonColor : phraseTextColor,
                    phraseX,
                    phraseY,
                    phraseWidth,
                    phraseHeight,
                    'bold',
                    false,
                    true);
                ui.buttons.push({
                    name: 'phrase',
                    left: phraseX - padding,
                    top: phraseY - padding,
                    right: phraseWidth + padding,
                    bottom: phraseHeight + padding })
            }

            function nextPhrase() {
                setPhrase((getPhrase() + 1) % lessons[getLesson()].phrases.length);
            }

            function touch(x, y) {
                ui.x = x;
                ui.y = y;
                for (var b in ui.buttons) {
                    var button = ui.buttons[b];
                    if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                        switch (button.name) {
                            case 'mode':
                                setDarkMode(!getDarkMode());
                                break;
                            case 'phrase':
                                stopPhrase();
                                ui.playing = false;
                                playPhrase(getCurrentPhrase(), false);
                                break;
                            case 'playPause':
                                stopPhrase();
                                ui.playing = !ui.playing;
                                if (ui.playing) playPhrase(getCurrentPhrase(), true);
                                break;
                            case 'prevLesson':
                                stopPhrase();
                                ui.playing = false;
                                var lesson = getLesson();
                                if (lesson > 0) setLesson(lesson - 1);
                                setPhrase(0);
                                break;
                            case 'nextLesson':
                                stopPhrase();
                                ui.playing = false;
                                var lesson = getLesson();
                                if (lesson < lessons.length - 1) setLesson(lesson + 1);
                                setPhrase(0);
                                break;
                            case 'prevPhrase':
                                stopPhrase();
                                ui.playing = false;
                                var phrase = getPhrase();
                                setPhrase(phrase > 0 ? phrase - 1 : lessons[phrase].phrases.length - 1);
                                break;
                            case 'nextPhrase':
                                stopPhrase();
                                ui.playing = false;
                                nextPhrase();
                                break;
                        }
                    }
                }
                redraw();
            }

            onload = function() {
                if (location.search == '?clear-settings') localStorage.clear();
                var ratio = devicePixelRatio;
                canvas = document.getElementById('canvas');
                canvas.onmousedown = function(e) { e.preventDefault(); touch(e.x * ratio, e.y * ratio); }
                // canvas.ontouchstart = function(e) { e.preventDefault(); touch(e.touches[0].clientX * ratio, e.touches[0].clientY * ratio); }
                resizeCanvas();
                redraw();
                setSpeed(25); // TODO: settings
                setFarnsworth(21); // TODO: settings
            }

            onresize = function() {
                resizeCanvas();
                redraw();
            }
        </script>
    </head>
    <body class="dark">
        <canvas id="canvas"></canvas>
    </body>
</html>