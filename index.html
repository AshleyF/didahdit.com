<html>
    <head>
        <title>Learn Morse Code</title>
        <style>body { margin: 0; padding: 0; }</style>
        <script>
            var library = [
                { id: 'CWOPS',
                  name: 'CWOps Beginner',
                  lessons: [
                    { id: 'CWOB1',
                      name: 'E T A N',
                      phrases: ['E', 'T', 'A', 'N', 'E E E', 'T T T', 'A A A', 'N N N', 'tea', 'tee', 'eat', 'ate', 'at', 'tat', 'teen', 'neat', 'ten', 'net', 'tan', 'ant', 'antenna', 'eat at ten', 'ate at ten', 'at tee'] },
                    { id: 'CWOB2',
                      name: 'O I S 1 4',
                      phrases: ['O', 'I', 'S', '1', '4', 'O O O', 'I I I', 'S S S', '1 1 1', '4 4 4', 'T T T', 'E E E', 'A A A', 'N N N', 'ten', 'ton', 'tin', 'tie', 'toe', 'no', 'not', 'note', 'it', 'at', 'one', 'neat', 'net', 'nit', 'toes', 'stone', 'tease', 'noise', 'one neat note', 'no noise', 'tie it', '1 ton stone', 'N1AS', 'N4ON', 'S41T', 'NO1S', 'AI1E', 'IT4O', 'EA1ON', 'ES4IT'] },
                    { id: 'CWOB3',
                      name: 'R H D L 2 5',
                      phrases: ['R', 'H', 'D', 'L', '2', '5', 'R R R', 'H H H', 'D D D', 'L L L', '2 2 2', '5 5 5', 'O O O', 'I I I', 'S S S', 'all', 'tell', 'tall', 'deal', 'the', 'their', 'doll', 'dell', 'hall', 'hill', 'hole', 'load', 'lead', 'late', 'later', 'seal', 'sell', 'sole', 'she', 'shed', 'her', 'hear', '#142', '#451', '#1425', 'a tall hill', 'she is here', 'he is late', '#4 sheds', '#12 hills', 'DL1AT', 'HH5H', 'HS1TD', 'ND2T', 'NA4T'] },
                    { id: 'CWOB4',
                      name: 'U C',
                      phrases: ['U', 'C', 'U U U', 'C C C', 'R R R', 'H H H', 'D D D', 'L L L', '1 1 1', '4 4 4', 'chat', 'chair', 'chin', 'chart', 'ouch', 'couch', 'touch', 'such', 'teach', 'reach', 'sun', 'son', 'hold', 'told', 'sail', 'rail', 'tail', 'nail', 'oil', 'soil', 'toil', 'coil', 'rain', 'cause', 'sauce', 'toss', 'toll', 'tall', 'tell', 'cell', 'call', '#4241', '#1452', 'in the cell', 'that hurts', 'at the hall', 'hole in #1', 'sail on sailor', 'tell all', 'hold on', 'NC5A', 'NA2T', 'CU1LL', 'CO5NO', 'NU4R', 'CT1AC', 'CE1NI'] },
                    { id: 'CWOB5',
                      name: 'M W 3 6 ?',
                      phrases: ['M', 'W', '3', '6', '?', 'M M M', 'W W W', '3 3 3', '6 6 6', '? ? ?', 'U U U', 'C C C', '2 2 2', '5 5 5', 'wait', 'wall', 'well', 'will', 'mall', 'mill', 'chum', 'mow', 'much', 'such', 'water', 'wet', 'what', 'dew', 'date', 'atom', 'tow', 'tower', 'were', 'where', 'was', 'wish', 'wash', 'mat', 'matt', 'mel', 'him', 'her', 'his', 'hw?', 'well water', 'how is it?', 'is this it?', 'this is it', 'this is it', '#1432 hill street', '#1 and #4 is #5', 'W3AA', 'N3AM', 'DM5RA', 'W6AM', 'N2AT', 'RW5L', 'ON4UN', '#335', '#1432', '#6122'] },
                    { id: 'CWOB6',
                      name: 'F Y',
                      phrases: ['F', 'Y', 'F F F', 'Y Y Y', 'M M M', 'W W W', '3 3 3', '6 6 6', 'you', 'toy', 'foot', 'tooth', 'root', 'cute', 'noise', 'larry', 'roy', 'ton', 'teeth', 'feet', 'yet', 'they', 'say', 'ray', 'hay', 'your', 'fair', 'fare', 'far', 'fur', 'furry', 'hw?', 'is this fair?', 'yes it is', 'the fur flies', 'she is shy', 'i say no', 'she says yes', 'he says no', 'who is he?', 'he is will', 'no he is walt', 'F5IN', 'YO1AR', 'HH5H', 'NO3M', 'AA3U', 'S52R', '#1512', '#3316'] },
                    { id: 'CWOB7',
                      name: 'P G 7 9 /',
                      phrases: ['P', 'G', '7', '9', '/', 'P P P', 'G G G', '7 7 7', '9 9 9', '/ / /', 'F F F', 'Y Y Y', '3 3 3', '6 6 6', 'page', 'paper', 'pepper', 'glad', 'glare', 'large', 'ledge', 'george', 'geo', 'chas', 'chase', 'change', 'peg', 'pug', 'pig', 'pen', 'pencil', 'pipe', 'pit', 'gain', 'garage', 'guard', 'gas', 'gus', 'chug', 'yes', 'yet', 'yonder', 'coy', '#7423', '#14253679', '#14253679', 'he is a pro', 'she is near', 'do not gape', 'he is at #19 glen street', 'go to her', 'read the page', 'what page?', 'page #15', 'G4AN/3', 'N1AR/5', 'W9UCA/9', 'W3/PY2AA', 'F6/N6AM', '2N2222'] },
                    { id: 'CWOB8',
                      name: 'B V',
                      phrases: ['B', 'V', 'B B B', 'V V V', '7 7 7', '9 9 9', '/ / /', 'vote', 'vat', 'view', 'wave', 'pave', 'save', 'vow', 'valve', 'solve', 'volt', 'vault', 'bad', 'body', 'bore', 'born', 'barn', 'barney', 'brad', 'bread', 'bed', 'better', 'best', 'bill', 'build', 'built', 'bolt', 'bulb', 'blame', 'blend', 'bland', 'blow', '#6146', '#5514', 'name is bob', 'name is bill', 'name is ted', 'name is vinnie', 'name is art', 'ur rst is 559', 'ur rst is 459', 'ur rst is 579', 'ur rst is 449', 'BV2AA', 'BA1RO', 'WB2AE', 'N6RB/4', 'W2/VE1AR', 'VE2/W2LE'] },
                    { id: 'CWOB9',
                      name: 'J K 8 0 <BT>',
                      phrases: ['J', 'K', '8', '0', '<BT>', 'J J J', 'K K K', '8 8 8', '0 0 0', '<BT> <BT> <BT>', 'B B B', 'V V V', 'jack', 'jay', 'john', 'jim', 'jerry', 'back', 'rack', 'tack', 'tech', 'tach', 'reach', 'each', 'teach', 'help', 'high', 'hill', 'fact', 'face', 'far', 'fear', 'then', 'their', 'him', 'her', 'his', 'hers', 'them', 'they', 'their', 'switch', 'line', 'ant', 'dipole', 'vertical', 'ohms', 'home', 'away', 'test', 'asia', 'africa', '#807', '3500Z', '4250A', 'hw is he?', 'name is joe <BT> age is #49', 'name is john <BT> age is #66', 'name is jim <BT> age is #17', 'name is fred <BT> age is #44', 'name is tom <BT> age is #72', 'name is john <BT> age is #23', 'name is bob <BT> age is #51', 'ur rst is 549', 'ur rst is 579', 'ur rst is 339', 'sri no cpy', 'K1JD', 'N1AR', 'W2TT', 'K2UMU', 'N2NW', 'VE3NE', 'VA3KP', 'K4BAI', 'N5KO'] },
                    { id: 'CWOB10',
                      name: 'X Q Z <BK>',
                      phrases: ['X', 'Q', 'Z', '<BK>', 'x x x', 'q q q', 'z z z', '<BK> <BK> <BK>', 'k k k', 'j j j', '8 8 8', '0 0 0', 'wl', 'ur', 'ok', 'hw?', 'qrx', 'qrz', 'qth', 'qrs', 'qro', 'qrp', 'rig', 'wx', 'ant', 'pwr', 'kw', 'name', 'memphis', 'nyc', 'sf', 'dallas', 'houston', 'nm', 'nj', 'ca', 'ut', 'al', 'ar', 'il', 'in', 'me', 'ma', 'ct', 'co', 'qrm', 'ne', 'sd', 'nd', 'pa', 'ky', 'fl', 'nc', 'sc', 'sdgo', 'lax', 'la', 'on', 'sk', 'mb', 'nt', 'ab', 'qc', 'nb', 'ns', 'nr', 'rst', 'uk', 'usa', 'tokyo', 'paris', 'london', 'hamburg', 'sydney', '#8044', '#7400', '#73', 'u hv qsb', 'u hv qrm', 'name?', 'qth?', 'qth is ny <BK>', 'qth is paris <BK>', 'pse qsy to #7054', 'ur rst is 579 <BK>', 'qth is nr tulsa <BK>', 'name is barry <BK>', 'ur rst is 559 <BK>', 'qth is dayton oh <BK>', 'name is john', 'ZL2TT', 'VK4OM', 'JE1TRV', 'BA1CW', 'KH6LC', 'AL2A', 'AA3B'] } ] },
                { id: 'QTH',
                  name: 'QTH Locations',
                  lessons: [
                    { id: 'ST',
                      name: 'States (US)/Provinces (CA)',
                      phrases: ['AL|alabama', 'AK|alaska', 'AB|alberta', 'AR|arkansas', 'AS|american samoa', 'AZ|arizona', 'BC|british columbia', 'DC|district of columbia', 'CO|colorado', 'CT|connecticut', 'DE|delaware', 'GA|georgia', 'GU|guam', 'ID|idaho', 'IL|illinois', 'IN|indiana', 'IA|iowa', 'KS|kansas', 'KY|kentucky', 'LA|louisiana', 'ME|maine', 'MB|manitoba', 'MH|marshall islands', 'MI|michigan', 'MN|minnesota', 'MS|mississippi', 'MO|missouri', 'MT|montana', 'NB|new brunswick', 'NE|nebraska', 'NV|nevada', 'NH|new hampshire', 'NM|new mexico', 'NL|newfoundland', 'NC|north carolina', 'NS|nova scotia', 'NU|nunavut', 'ND|north dakota', 'NT|northwest territories', 'OH|ohio', 'OK|oklahoma', 'ON|ontario', 'OR|oregon', 'PW|palau', 'PR|puerto rico', 'PE|prince edward island', 'QC|quebec', 'RI|rhode island', 'SK|saskatchewan', 'SC|south carolina', 'SD|south dakota', 'TN|tennesee', 'VI|virgin islands', 'UT|utah', 'VT|vermont', 'VA|verginia', 'WV|west verginia', 'WI|wisconsin', 'WY|wyoming', 'YT|yukon'] },
                    { id: 'PRE',
                      name: 'Prefectures (JP)',
                      phrases: ['AI|aichi', 'AK|akita', 'AO|aomori', 'CH|chiba', 'EH|ehime', 'FI|fukui', 'FO|fukuoka', 'FS|fukushima', 'GF|gifu', 'GM|gumma', 'HS|hiroshima', 'HK|hokkaido', 'HG|hyogo', 'IB|ibaraki', 'IS|ishikawa', 'IW|iwate', 'KG|kagawa', 'KS|kagoshima', 'KN|kanagawa', 'KC|kochi', 'KM|kumamoto', 'KY|kyoto', 'ME|mie', 'MG|miyagi', 'MZ|miyazaki', 'NN|nagano', 'NS|nagasaki', 'NR|nara', 'NI|niigata', 'OT|oita', 'OY|okayama', 'ON|okinawa', 'OS|osaka', 'SG|saga', 'ST|saitama', 'SH|shiga', 'SM|shimane', 'SZ|shizuoka', 'TC|tochigi', 'TS|tokushima', 'TK|tokyo', 'TT|tottori', 'TY|toyama', 'WK|wakayama', 'YT|yamagata', 'YC|yamaguchi', 'YN|yamanashi'] },
                    { id: 'CITY_WORLD',
                      name: '100 Cities (World)',
                      phrases: ['tokyo', 'delhi', 'shanghai', 'dhaka', 'sao paulo', 'mexico city', 'cairo', 'beijing', 'mumbai', 'osaka', 'chongqing', 'karachi', 'istanbul', 'kinshasa', 'lagos', 'buenos aires', 'kolkata', 'manila', 'tianjin', 'guangzhou', 'rio de janeiro', 'lahore', 'bangalore', 'shenzhen', 'moscow', 'chennai', 'bogota', 'paris', 'jakarta', 'lima', 'bangkok', 'hyderabad', 'seoul', 'nagoya', 'london', 'chengdu', 'nanjing', 'tehran', 'ho chi minh city', 'luanda', 'new york city', 'wuhan', 'xi an shaanxi', 'ahmedabad', 'kuala lumpur', 'hangzhou', 'surat', 'suzhou', 'hong kong', 'riyadh', 'shenyang', 'baghdad', 'dongguan', 'foshan', 'dar es salaam', 'pune', 'santiago', 'madrid', 'haerbin', 'toronto', 'belo horizonte', 'khartoum', 'johannesburg', 'singapore', 'dalian', 'qingdao', 'zhengzhou', 'ji nan shandong', 'barcelona', 'saint petersburg', 'abidjan', 'yangon', 'fukuoka', 'alexandria', 'guadalajara', 'ankara', 'chittagong', 'addis ababa', 'melbourne', 'nairobi', 'hanoi', 'sydney', 'monterrey', 'changsha', 'brasilia', 'cape town', 'jiddah', 'urumqi', 'kunming', 'changchun', 'hefei', 'shantou', 'xinbei', 'kabul', 'ningbo', 'tel aviv', 'yaounde', 'rome', 'shijiazhuang', 'montreal'] },
                    { id: 'CITY_AFRICA',
                      name: '100 Cities (Africa)',
                      phrases: ['kinshasa', 'lagos', 'cairo', 'giza', 'luanda', 'dar es salaam', 'khartoum', 'johannesburg', 'abidjan', 'alexandria', 'addis ababa', 'nairobi', 'cape town', 'yaoundé', 'kano', 'east rand', 'douala', 'casablanca', 'ibadan', 'antananarivo', 'abuja', 'kampala', 'kumasi', 'dakar', 'port harcourt', 'durban', 'ouagadougou', 'lusaka', 'algiers', 'bamako', 'omdurman', 'mbuji-mayi', 'pretoria', 'lubumbashi', 'accra', 'brazzaville', 'mogadishu', 'tunis', 'conakry', 'rabat', 'lomé', 'benin city', 'matola', 'monrovia', 'kananga', 'harare', 'onitsha', "n'djamena", 'nouakchott', 'mombasa', 'niamey', 'kisangani', 'pointe-noire', 'port elizabeth', 'tangier', 'freetown', 'fez', 'uyo', 'mwanza', 'lilongwe', 'kigali', 'bukavu', 'abomey-calavi', 'nnewi', 'tripoli', 'kaduna', 'aba', 'bujumbura', 'maputo', 'hargeisa', 'bobo dioulasso', 'shubra el-kheima', 'ikorodu', 'asmara', 'marrakesh', 'tshikapa', 'nyala', 'ilorin', 'blantyre', 'agadir', 'misratah', 'owerri', 'warri', 'jos', 'bangui', 'nampula', 'oran', 'west rand', 'lubango', 'cabinda', 'umuahia', 'libreville', 'benghazi', 'maiduguri', 'enugu', 'lokoja', 'vereeniging', 'benguela', 'bunia', 'zanzibar'] },
                    { id: 'CITY_ASIA',
                      name: '100 Cities (Asia)',
                      phrases: ['shanghai', 'beijing', 'shenzhen', 'guangzhou', 'istanbul', 'chengdu', 'mumbai', 'karachi', 'tianjin', 'delhi', 'wuhan', 'dhaka', 'seoul', 'dongguan', "xi'an", 'nanjing', 'hangzhou', 'foshan', 'ho chi minh city', 'jakarta', 'bengaluru', 'tokyo', 'hanoi', 'taipei', 'hong kong', 'chongqing', 'baghdad', 'qingdao', 'tehran', 'shenyang', 'hyderabad', 'suzhou', 'ahmedabad', 'lahore', 'harbin', 'bangkok', 'hefei', 'dalian', 'chennai', 'kolkata', 'xiamen', 'surat', 'yangon', 'wuxi', 'jinan', 'taiyuan', 'zhengzhou', 'riyadh', 'changchun', 'shijiazhuang', 'chattogram', 'kunming', 'zhongshan', 'nanning', 'shantou', 'fuzhou', 'ningbo', 'busan', 'puyang', 'yokohama', 'singapore', 'ankara', 'shiyan', 'tangshan', 'changzhou', 'pyongyang', 'zibo', 'pune', 'changsha', 'kabul', 'guiyang', 'ueruemqi', 'lanzhou', 'dubai', 'huizhou', 'haikou', 'jeddah', 'kanpur', 'quezon city', 'osaka', 'linyi', 'baoding', 'jaipur', 'wenzhou', 'incheon', 'yunfu', 'basrah', 'navi mumbai', 'daegu', 'faisalabad', 'izmir', "huai'an", 'lucknow', 'surabaya', 'nanchang', 'hohhot', 'mashhad', 'shaoxing', 'nantong', 'nagpur'] },
                    { id: 'CITY_EUROPE',
                      name: '100 Cities (Europe)',
                      phrases: ['moscow', 'london', 'saint petersburg', 'berlin', 'madrid', 'kyiv', 'rome', 'paris', 'bucharest', 'minsk', 'budapest', 'hamburg', 'warsaw', 'vienna', 'barcelona', 'stockholm', 'kharkiv', 'novosibirsk', 'yekaterinburg', 'nizhniy novgorod', 'belgrade', 'munich', 'milan', 'prague', 'copenhagen', 'sofia', 'samara', 'omsk', 'kazan', 'rostov-na-donu', 'chelyabinsk', 'ufa', 'donetsk', 'dublin', 'brussels', 'odessa', 'volgograd', 'dnipro', 'birmingham', 'perm', 'koeln', 'naples', 'krasnoyarsk', 'turin', 'liverpool', 'saratov', 'voronezh', 'valencia', 'marseille', 'lodz', 'krakow', 'riga', 'amsterdam', 'zaporizhzhya', 'lviv', 'sevilla', 'tolyatti', 'zagreb', 'sarajevo', 'sheffield', 'zaragoza', 'athens', 'frankfurt am main', 'krasnodar', 'palermo', 'ulyanovsk', 'chisinau', 'wroclaw', 'izhevsk', 'kryvyy rih', 'bristol', 'yaroslavl', 'barnaul', 'rotterdam', 'essen', 'glasgow', 'stuttgart', 'dortmund', 'vladivostok', 'irkutsk', 'genoa', 'oslo', 'khabarovsk', 'khabarovsk vtoroy', 'duesseldorf', 'goeteborg', 'poznan', 'malaga', 'helsinki', 'orenburg', 'bremen', 'vilnius', 'novokuznetsk', 'ryazan', 'tyumen', 'lisbon', 'lipetsk', 'nuernberg', 'hannover', 'penza'] },
                    { id: 'CITY_NA',
                      name: '100 Cities (N America)',
                      phrases: ['mexico city', 'new york city', 'los angeles', 'chicago', 'toronto', 'brooklyn', 'houston', 'queens', 'santo domingo', 'havana', 'iztapalapa', 'ecatepec de morelos', 'phoenix', 'philadelphia', 'montreal', 'guadalajara', 'manhattan', 'san antonio', 'puebla', 'san diego', 'the bronx', 'ciudad juarez', 'tijuana', 'dallas', 'leon de los aldama', 'port-au-prince', 'santiago de los caballeros', 'gustavo adolfo madero', 'zapopan', 'monterrey', 'ciudad nezahualcoyotl', 'san jose', 'calgary', 'guatemala city', 'managua', 'jacksonville', 'kingston', 'austin', 'fort worth', 'columbus', 'indianapolis', 'charlotte', 'san francisco', 'tegucigalpa', 'ottawa', 'chihuahua', 'naucalpan de juarez', 'merida', 'seattle', 'alvaro obregon', 'san luis potosi', 'aguascalientes', 'denver', 'hermosillo', 'edmonton', 'saltillo', 'santo domingo oeste', 'santo domingo este', 'mexicali', 'washington', 'nashville', 'el paso', 'oklahoma city', 'detroit', 'culiacan', 'boston', 'guadalupe', 'acapulco de juarez', 'mississauga', 'memphis', 'tlalnepantla', 'portland', 'new south memphis', 'winnipeg', 'cancun', 'santiago de queretaro', 'las vegas', 'baltimore', 'coyoacan', 'santa maria chimalhuacan', 'torreon', 'milwaukee', 'vancouver', 'morelia', 'brampton', 'reynosa', 'new kingston', 'tlaquepaque', 'tlalpan', 'south boston', 'albuquerque', 'santiago de cuba', 'tuxtla', 'cuauhtemoc', 'tucson', 'quebec', 'san salvador', 'fresno', 'hamilton', 'victoria de durango'] },
                    { id: 'CITY_SA',
                      name: '100 Cities (S America)',
                      phrases: ['buenos aires', 'sao paulo', 'lima', 'bogota', 'rio de janeiro', 'santiago', 'caracas', 'salvador', 'fortaleza', 'cali', 'belo horizonte', 'maracaibo', 'brasilia', 'la paz', 'medellin', 'guayaquil', 'santa cruz de la sierra', 'maracay', 'curitiba', 'valencia', 'manaus', 'asuncion', 'recife', 'cordoba', 'belem', 'quito', 'barranquilla', 'porto alegre', 'montevideo', 'rosario', 'goiania', 'guarulhos', 'barquisimeto', 'campinas', 'nova iguacu', 'maceio', 'cartagena', 'ciudad guayana', 'sao luis', 'mendoza', 'cochabamba', 'arequipa', 'duque de caxias', 'callao', 'san miguel de tucuman', 'natal', 'trujillo', 'teresina', 'sao bernardo do campo', 'campo grande', 'cucuta', 'jaboatao', 'la plata', 'osasco', 'santo andre', 'joao pessoa', 'jaboatao dos guararapes', 'contagem', 'ribeirao preto', 'feira de santana', 'sao jose dos campos', 'chiclayo', 'bucaramanga', 'uberlandia', 'sorocaba', 'mar del plata', 'maturin', 'cuiaba', 'salta', 'aparecida de goiania', 'puente alto', 'barcelona', 'aracaju', 'santa fe', 'londrina', 'juiz de fora', 'belford roxo', 'joinville', 'niteroi', 'sao joao de meriti', 'san juan', 'pereira', 'iquitos', 'ananindeua', 'santa marta', 'ciudad bolivar', 'cumana', 'ibague', 'florianopolis', 'santos', 'ribeirao das neves', 'vila velha', 'serra', 'bello', 'diadema', 'campos dos goytacazes', 'resistencia', 'maua', 'betim', 'pasto'] },
                    { id: 'CITY_OCEANIA',
                      name: '100 Cities (Oceania)',
                      phrases: ['auckland', 'brisbane', 'gold coast', 'canberra', 'jayapura', 'christchurch', 'canterbury-bankstown', 'blacktown', 'port moresby', 'honolulu', 'casey', 'logan', 'wyndham', 'geelong', 'sorong', 'parramatta', 'sydney', 'cumberland', 'hume', 'liverpool', 'whittlesea', 'stirling', 'wellington', 'wollongong', 'ipswich', 'fairfield', 'penrith', 'brimbank', 'lake macquarie', 'wanneroo', 'monash', 'townsville', 'moreland', 'boroondara', 'hamilton', 'whitehorse', 'onkaparinga', 'melbourne', 'campbelltown', 'toowoomba', 'dandenong', 'newcastle', 'kingston', 'knox', 'darebin', 'joondalup', 'redland', 'melton', 'tauranga', 'radwick', 'cairns', 'glen eira', 'swan', 'salisbury', 'frankston', 'rockingham', 'dunedin', 'banyule', 'moonee valley', 'ryde', 'port adelaide enfield', 'manningham', 'gosnells', 'maroondah', 'charles sturt', 'stonnington', 'port phillip', 'lower hutt', 'cockburn', 'ballarat', 'manokwari', 'bayside', 'shoalhaven', 'bendigo', 'melville', 'lae', 'tea tree gully', 'yarra', 'hobsons bay', 'canada bay', 'nouméa', 'playford', 'canning', 'marion', 'maribyrnong', 'palmerston north', 'hastings', 'armadale', 'new plymouth', 'suva', 'mandurah', 'darwin', 'honiara', 'maitland', 'willoughby', 'mackay', 'blue mountains', 'rockhampton', 'rotorua', 'coffs harbour'] },
                    { id: 'CITY_US',
                      name: '100 Cities (U.S.)',
                      phrases: ['new york', 'los angeles', 'chicago', 'houston', 'phoenix', 'philadelphia', 'san antonio', 'san diego', 'dallas', 'san jose', 'austin', 'jacksonville', 'fort worth', 'columbus', 'indianapolis', 'charlotte', 'san francisco', 'seattle', 'denver', 'oklahoma city', 'nashville', 'el paso', 'washington', 'boston', 'las vegas', 'portland', 'detroit', 'louisville', 'memphis', 'baltimore', 'milwaukee', 'albuquerque', 'fresno', 'tucson', 'sacramento', 'mesa', 'kansas city', 'atlanta', 'omaha', 'colorado springs', 'raleigh', 'virginia beach', 'long beach', 'miami', 'oakland', 'minneapolis', 'tulsa', 'bakersfield', 'wichita', 'arlington', 'aurora', 'tampa', 'new orleans', 'cleveland', 'anaheim', 'honolulu', 'henderson', 'stockton', 'lexington', 'corpus christi', 'riverside', 'santa ana', 'orlando', 'irvine', 'cincinnati', 'newark', 'saint paul', 'pittsburgh', 'greensboro', 'st. louis', 'lincoln', 'plano', 'anchorage', 'durham', 'jersey city', 'chandler', 'chula vista', 'buffalo', 'north las vegas', 'gilbert', 'madison', 'reno', 'toledo', 'fort wayne', 'lubbock', 'st. petersburg', 'laredo', 'irving', 'chesapeake', 'winston–salem', 'glendale', 'scottsdale', 'garland', 'boise', 'norfolk', 'spokane', 'fremont', 'richmond', 'santa clarita', 'san bernardino'] } ] },
                { id: 'NAME',
                  name: 'Names',
                  lessons: [
                    { id: 'NAME2',
                      name: 'Two-letter Names',
                      phrases: ['an', 'bo', 'vi', 'cy', 'zo', 'el', 'ed', 'di', 'li', 'po', 'em', 'al', 'lo', 'ty', 'ki', 'ab', 'jo', 'oz', 'mo', 'su', 'lu', 'aj', 'cj', 'dj', 'jc', 'jd', 'jj', 'jr', 'jt', 'kc', 'lj', 'rj', 'tj'] },
                    { id: 'NAME3',
                      name: 'Three-letter Names',
                      phrases: ['ash', 'ace', 'abe', 'ali', 'art', 'ava', 'axl', 'bob', 'cam', 'dan', 'don', 'doc', 'dev', 'ham', 'fen', 'hal', 'ben', 'ivy', 'ian', 'lev', 'lon', 'lee', 'lex', 'mac', 'mae', 'moe', 'cal', 'ada', 'dax', 'mia', 'neo', 'eva', 'guy', 'gay', 'gus', 'gil', 'roy', 'red', 'reb', 'eli', 'tam', 'tal', 'tom', 'tim', 'tex', 'obi', 'pat', 'poe', 'pax', 'ted', 'lou', 'fox', 'rip', 'rex', 'noa', 'ned', 'mel', 'ida', 'ira', 'ike', 'jay', 'jac', 'joe', 'jon', 'jun', 'jet', 'jed', 'jeb', 'jim', 'ren', 'rue', 'rob', 'ron', 'pip', 'eve', 'kai', 'kit', 'kal', 'kay', 'ken', 'kip', 'koa', 'leo', 'sam', 'sal', 'sid', 'sly', 'ray', 'rae', 'amy', 'gia', 'wes', 'zoe', 'van', 'bea', 'aya', 'val', 'vin', 'wil', 'liv', 'max', 'zac', 'zak', 'zed'] },
                ] } ];

            var canvas;

            var ui = {
                dialog: null,
                playing: false,
                hide: false,
                buttons: [],
                dialog: { left: 0, right: 0, top: 0, bottom: 0 },
                speed: 20,
                farnsworth: 5,
            };

            function trace(message) {
                //alert(message);
            }

            var audioCtx;
            var toneGain;
            var toneOscillator;
            var dingGain;
            var dingOscillator;
            var audioStarted = false;
            function startAudio() {
                say('');
                (new Audio('silent.wav')).play();
                audioCtx = new (AudioContext || webkitAudioContext)();
                toneOscillator = audioCtx.createOscillator();
                dingOscillator = audioCtx.createOscillator();
                toneOscillator.frequency.value = getPitch();
                dingOscillator.frequency.value = 2000;
                toneGain = audioCtx.createGain();
                dingGain = audioCtx.createGain();
                toneGain.gain.value = 0;
                dingGain.gain.value = 0;
                toneOscillator.connect(toneGain);
                dingOscillator.connect(dingGain);
                toneGain.connect(audioCtx.destination);
                dingGain.connect(audioCtx.destination);
                toneOscillator.start(0);
                dingOscillator.start(0);
                audioStarted = true;
            }

            var t = 0;
            function stopAudio() {
                if (audioStarted) {
                    audioCtx.close();
                    t = 0;
                    audioStarted = false;
                }
            }

            function playTone(len) {
                const ramp = 0.005;
                if (!audioStarted) startAudio();
                var c = audioCtx.currentTime;
                t = c > t ? c : t;
                toneGain.gain.setTargetAtTime(1, t, ramp);
                t += len;
                toneGain.gain.setTargetAtTime(0, t, ramp);
            }

            function silence(len) {
                t += len;
            }

            function convertPhrase(phrase) {
                var split = phrase.split('|');
                return split[0].replace('#', '');
            }

            function convertUtterance(utterance) {
                var utter = '';
                var numberMode = false;
                for (var i in utterance) {
                    var c = utterance[i];
                    switch (c) {
                        case '#':
                            numberMode = true;
                            break;
                        case ' ':
                            numberMode = false;
                            utter += ' ';
                            break;
                        default:
                            if (c == c.toUpperCase() && (!numberMode || c < '0' || c > '9')) {
                                var spell = {
                                    'A': 'alfa',
                                    'B': 'bravo',
                                    'C': 'charlie',
                                    'D': 'delta',
                                    'E': 'echo',
                                    'F': 'foxtrot',
                                    'G': 'golf',
                                    'H': 'hotel',
                                    'I': 'india',
                                    'J': 'juliet',
                                    'K': 'key-low', // kilo
                                    'L': 'lee-ma', // lima
                                    'M': 'mike',
                                    'N': 'november',
                                    'O': 'oscar',
                                    'P': 'papa',
                                    'Q': 'quebec',
                                    'R': 'romeo',
                                    'S': 'sierra',
                                    'T': 'tango',
                                    'U': 'uniform',
                                    'V': 'victor',
                                    'W': 'whiskey',
                                    'X': 'x-ray',
                                    'Y': 'yanky',
                                    'Z': 'zulu',
                                    '1': 'one',
                                    '2': 'two',
                                    '3': 'three', // tree?
                                    '4': 'four', // fower?
                                    '5': 'five', // fife?
                                    '6': 'six',
                                    '7': 'seven',
                                    '8': 'eight',
                                    '9': 'niner',
                                    '0': 'zero',
                                    '?': 'question mark',
                                    '.': 'full stop',
                                    ',': 'comma',
                                    ':': 'colon',
                                    '-': 'dash',
                                    ';': 'semicolon',
                                    '!': 'exclamation point',
                                    '/': 'slash',
                                    "'": 'apostrophe',
                                    '"': 'quotation mark',
                                    '_': 'underscore',
                                    '=': 'double dash',
                                    '&': 'ampersand',
                                    '$': 'dollar sign',
                                    '(': 'left parenthesis',
                                    ')': 'right parenthesis',
                                    '+': 'plus',
                                    '@': 'at sign',
                                    '<': ' ', // nothing
                                    '>': 'pro-sign',
                                    '|': ',', // pause (separator)
                                }[c];
                                utter += ' ' + (spell || c) + ' ';
                            } else {
                                utter += c;
                            }
                            break;
                    }
                }
                return utter;
            }

            function say(utterance) {
                if ('speechSynthesis' in window) {
                    speechSynthesis.speak(new SpeechSynthesisUtterance(utterance));
                }
            }

            function playDing() {
                if (!audioStarted) startAudio();
                var c = audioCtx.currentTime;
                t = c > t ? c : t;
                dingGain.gain.linearRampToValueAtTime(0.2, t + 0.005);
                t += 2.5;
                dingGain.gain.exponentialRampToValueAtTime(0.000001, t);
            }

            var morse = "  ETIANMSURWDKGOHVF L PJBXCYZQ  54 3   2& +    16=/   ( 7   8 90     $      ?_    \"  .    @   '  -        ;! )     ,    :";
            var playContinuation = function() {};
            var continuationTimeout0 = null;
            var continuationTimeout1 = null;

            function stopPhrase() {
                playContinuation = function() {};
                if (continuationTimeout0) clearTimeout(continuationTimeout0);
                if (continuationTimeout1) clearTimeout(continuationTimeout1);
                if (ui.hide) {
                    ui.hide = false;
                    redraw();
                }
            }

            function getCurrentPhrase() {
                return getContent().lessons[getLessonNum()].phrases[getPhraseNum()]
            }

            function encodePhrase(phrase) {
                function trim(str) { return str.endsWith(' ') ? str.substring(0, str.length - 1) : str; }
                var prosign = false;
                var code = '';
                for (var i in phrase) {
                    var c = phrase[i];
                    if (c == ' ') { // word break
                        code = trim(code) + '/';
                    } else {
                        if (c == '<') prosign = true;
                        if (c == '>') prosign = false;
                        var letter = '';
                        var j = morse.indexOf(c.toUpperCase());
                        while (j > 1) {
                            if (j % 2 == 0) {
                                letter = '.' + letter;
                                j /= 2;
                            } else {
                                letter = '-' + letter;
                                j = (j - 1) / 2;
                            }
                        }
                        code += letter;
                        if (!prosign) {
                            code += ' ';
                        }
                    }
                }
                return trim(code);
            }

            function playCode(code) {
                function continuation(j) {
                    if (code.length > j) {
                        var continueCode = code.substring(j);
                        continuationTimeout0 = setTimeout(
                            function() { playCode(continueCode); },
                            (t - startTime) * 1000);
                    }
                }
                if (!audioStarted) startAudio();
                var startTime = audioCtx.currentTime;
                for (var i = 0; i < code.length; i++) {
                    switch (code[i]) {
                        case '.':
                            playTone(ditlen);
                            silence(ditlen);
                            break;
                        case '-':
                            playTone(ditlen * 3);
                            silence(ditlen);
                            break;
                        case ' ':
                            silence(fditlen * 3);
                            continuation(i + 1);
                            return;
                        case '/':
                            silence(fditlen * 7);
                            continuation(i + 1);
                            return;
                    }
                }
            }

            function playPhrase(phrase, speakAndAdvance) {
                function codeMilliseconds(code) {
                    var s = 0;
                    for (var i = 0; i < code.length; i++) {
                        switch (code[i]) {
                            case '.':
                                s += ditlen * 2;
                                break;
                            case '-':
                                s += ditlen * 4;
                                break;
                            case ' ':
                                s += fditlen * 3;
                                break;
                            case '/':
                                s += fditlen * 7;
                                break;
                        }
                    }
                    return s * 1000;
                }
                if (speakAndAdvance && !ui.hide) {
                    ui.hide = true;
                    redraw();
                }
                var code = encodePhrase(convertPhrase(phrase));
                playCode(code);
                const trainingSpeechPause = 2000;
                const trainingSpeechCharacterPause = 110;
                var delay = codeMilliseconds(code) + fditlen * 7 * 1000;
                if (speakAndAdvance) {
                    continuationTimeout1 = setTimeout(
                        function () {
                            if (ui.playing) {
                                playDing();
                                continuationTimeout1 = setTimeout(
                                    function () {
                                        if (ui.playing) {
                                            ui.hide = false;
                                            redraw();
                                            var utter = convertUtterance(getCurrentPhrase());
                                            say(utter);
                                            continuationTimeout1 = setTimeout(
                                                function () {
                                                    if (ui.playing) {
                                                        nextPhrase(true);
                                                        redraw();
                                                        playPhrase(getCurrentPhrase(), speakAndAdvance, false);
                                                    }
                                                },
                                                trainingSpeechPause + utter.length * trainingSpeechCharacterPause);
                                        }
                                    },
                                    trainingSpeechPause);
                            }
                        },
                        delay);
                } else {
                    continuationTimeout1 = setTimeout(
                        function () {
                            if (ui.playing) {
                                ui.playing = false;
                                redraw();
                            }
                        },
                        delay);

                }
            }

            function getContent() {
                var id = localStorage.getItem('content');
                var content = library.find(c => c.id == id);
                if (content) return content;
                var dflt = library[0];
                localStorage.setItem('content', dflt.id);
                return dflt;
            }

            function setContent(id) {
                localStorage.setItem('content', id);
            }

            function getLessonNum() {
                var content = getContent();
                var id = localStorage.getItem('lesson_' + content.id);
                if (id) {
                    for (var i = 0; i < content.lessons.length; i++) {
                        if (content.lessons[i].id == id) return i;
                    }
                    trace('Missing lesson: ' + id);
                    localStorage.setItem('lesson_' + content.id, content.lessons[0].id);
                }
                return 0;
            }

            function setLessonNum(num) {
                var content = getContent();
                localStorage.setItem('lesson_' + content.id, content.lessons[num].id);
            }

            function setLesson(id) {
                var lessons = getContent().lessons;
                for (var i = 0; i < lessons.length; i++) {
                    if (lessons[i].id == id) {
                        setLessonNum(i);
                        setPhraseNum(0);
                        return;
                    }
                }
            }

            function getIntSetting(name, dflt) {
                return parseInt(localStorage.getItem(name) || dflt);
            }

            function getPhraseNum() {
                var content = getContent();
                var phrase = getIntSetting('phrase_' + content.id, 0);
                if (phrase >= 0 && phrase < content.lessons[getLessonNum()].phrases.length) return phrase;
                trace('Missing phrase: ' + phrase);
                localStorage.setItem('phrase_' + content.id, 0);
                return 0;
            }

            function setPhraseNum(num) {
                var content = getContent();
                localStorage.setItem('phrase_' + content.id, num);
            }

            function getDarkMode() {
                return (localStorage.getItem('mode') || 'dark') == 'dark';
            }

            function setDarkMode(dark) {
                localStorage.setItem('mode', dark ? 'dark' : 'light');
            }

            var ditlen;
            var fditlen;
            function computeSpeedVariables(wpm, farnsworth) {
                ditlen = 1.2 / wpm;
                fditlen = (60 / farnsworth - 31 * ditlen) / 19;
            }

            function setSpeed(wpm) {
                localStorage.setItem('speed', wpm);
                computeSpeedVariables(wpm, getFarnsworth());
            }

            function getSpeed() {
                return getIntSetting('speed', 25);
            }

            function setFarnsworth(farnsworthWpm) {
                localStorage.setItem('farnsworth', farnsworthWpm);
                computeSpeedVariables(getSpeed(), farnsworthWpm);
            }

            function getFarnsworth() {
                return getIntSetting('farnsworth', 5);
            }

            function setPitch(hz) { // TODO
                localStorage.setItem('pitch', hz);
                if (audioStarted) toneOscillator.frequency.value = hz;
            }

            function getPitch() { // TODO
                return getIntSetting('pitch', 650);
            }

            function resizeCanvas() {
                var ratio = devicePixelRatio;
                var w = window.innerWidth;
                var h = window.innerHeight;
                //var w = document.body.clientWidth;
                //var h = document.body.clientHeight;
                canvas.width = w * ratio;
                canvas.height = h * ratio;
                canvas.style.width = w + 'px';
                canvas.style.height = h + 'px';
            }

            function redraw() {
                const phraseTextColor = '#f43'; // red
                const lessonTextColor = '#07d'; // blue
                const phraseNumTextColor = '#2c4'; // green
                const dimColor = '#000b';

                var darkMode = getDarkMode();
                var backgroundColor = darkMode ? '#111' : '#eee'; // black/white
                var foregroundColor = darkMode ? '#eee' : '#111'; // white/black
                var mainButtonColor = foregroundColor;
                var subduedButtonColor = darkMode ? '#ccc' : '#333'; // gray
                var disabledButtonColor = darkMode ? '#333' : '#ccc'; // gray
                var dialogBackgroundColor = darkMode ? '#222' : '#ddd';
                var dialogAttributionColor = darkMode ? '#444' : '#bbb';

                var ctx = canvas.getContext('2d');
                ctx.scale(1, 1);
                var w = canvas.width;
                var h = canvas.height;

                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, w, h);
                document.body.style.backgroundColor = backgroundColor;

                function drawFittedText(txt, color, x, y, width, height, weight, actual, align) {
                    ctx.fillStyle = color;
                    function setFont(size) { ctx.font = weight + ' ' + size + 'px sans-serif'; }
                    const sampleSize = 100;
                    setFont(sampleSize);
                    var size = ctx.measureText(txt);
                    var ascent = actual ? size.actualBoundingBoxAscent : size.fontBoundingBoxAscent;
                    var descent = actual ? size.actualBoundingBoxDescent : size.fontBoundingBoxDescent;
                    var textHeight = ascent + descent;
                    var textWidth = size.actualBoundingBoxLeft + size.actualBoundingBoxRight;
                    var scale = Math.min(width / textWidth, height / textHeight);
                    setFont(scale * sampleSize);
                    ctx.textAlign = align;
                    ctx.fillText(txt, x + (align == 'center' ? width / 2 : align == 'left' ? 0 : width), y + ascent * scale + (height - textHeight * scale) / 2);
                }

                function fillRoundedRect(left, top, right, bottom, radius, color) {
                    ctx.beginPath();
                    ctx.moveTo(left + radius, top);
                    ctx.lineTo(right - radius, top);
                    ctx.arcTo(right, top, right, top + radius, radius);
                    ctx.lineTo(right, bottom - radius);
                    ctx.arcTo(right, bottom, right - radius, bottom, radius);
                    ctx.lineTo(left + radius, bottom);
                    ctx.arcTo(left, bottom, left, bottom - radius, radius);
                    ctx.lineTo(left, top + radius);
                    ctx.arcTo(left, top, left + radius, top, radius);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                }

                var padding = Math.min(canvas.width / 24, canvas.height / 24);

                var buttons = [];
                function drawButton(name, label, color, x, y, width, height, align, actual = true) {
                    drawFittedText(label, color, x, y, width, height, 'normal', actual, align);
                    var p = padding / 2;
                    buttons.push({
                        name: name,
                        left: x - p,
                        top: y - p,
                        right: x + width + p,
                        bottom: y + height + p })
                    //ctx.fillStyle = '#f00c';
                    //ctx.fillRect(x, y, width, height);
                    //ctx.beginPath();
                    //ctx.strokeStyle = '#f00';
                    //ctx.rect(x, y, width, height);
                    //ctx.stroke();
                }

                const numButtons = 5;
                const largeButton = 1.5;
                var buttonWidth = (w - (numButtons + 1) * padding) / (numButtons + largeButton - 1);
                var buttonSize = Math.min(buttonWidth, canvas.width / 12, canvas.height / 12);

                var content = getContent();
                var lessonNum = getLessonNum();
                var phraseNum = getPhraseNum();

                drawButton(
                    'settings',
                    '⁝',
                    subduedButtonColor,
                    w - padding - buttonSize,
                    padding, buttonSize, buttonSize,
                    'right');
                drawButton(
                    'prevLesson',
                    '⇤',
                    lessonNum > 0 ? subduedButtonColor : disabledButtonColor,
                    padding * 1 + buttonWidth * 0,
                    h - padding - buttonSize,
                    buttonWidth, buttonSize,
                    'left');
                drawButton(
                    'prevPhrase',
                    '⟲',
                    phraseNum > 0 ? subduedButtonColor : disabledButtonColor,
                    padding * 2 + buttonWidth * 1,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize,
                    'center');
                drawButton(
                    'nextPhrase',
                    '⟳',
                    phraseNum < content.lessons[lessonNum].phrases.length - 1 ? subduedButtonColor : disabledButtonColor,
                    padding * 4 + buttonWidth * 2 + buttonWidth * largeButton,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize,
                    'center');
                drawButton(
                    'nextLesson',
                    '⇥',
                    lessonNum < content.lessons.length - 1 ? subduedButtonColor : disabledButtonColor,
                    padding * 5 + buttonWidth * 3 + buttonWidth * largeButton,
                    h - padding - buttonSize,
                    buttonWidth,
                    buttonSize,
                    'right');
                drawButton(
                    'playPause',
                    ui.playing ? 'II' : '▸',
                    foregroundColor,
                    padding * 3 + buttonWidth * 2,
                    h - padding - buttonSize * largeButton,
                    buttonWidth * largeButton,
                    buttonSize * largeButton,
                    'center');
                ui.buttons = buttons;

                const progressHeight = Math.max(2, padding / 4);
                var lessonPercent = lessonNum/ content.lessons.length;
                var phrasePercent = (phraseNum + 1) / content.lessons[lessonNum].phrases.length;
                var lessonWidth = w * lessonPercent;
                ctx.fillStyle = lessonTextColor;
                ctx.fillRect(0, 0, lessonWidth, progressHeight);
                ctx.fillStyle = phraseNumTextColor;
                ctx.fillRect(lessonWidth, 0, (w - lessonWidth) * phrasePercent, progressHeight);

                drawButton(
                    'content',
                    '☰',
                    subduedButtonColor,
                    padding / 2,
                    padding + progressHeight,
                    buttonSize,
                    buttonSize,
                    'left');
                drawButton(
                    'lesson',
                    content.lessons[lessonNum].name,
                    lessonTextColor,
                    padding * 2 + buttonSize,
                    padding + progressHeight,
                    w - padding * 5 - buttonSize * 3,
                    buttonSize,
                    'left');
                drawButton(
                    'phraseNum',
                    phraseNum + 1,
                    phraseNumTextColor,
                    w - padding * 2 - buttonSize * 2,
                    padding + progressHeight,
                    buttonSize,
                    buttonSize,
                    'right');
                var phraseX = padding;
                var phraseY = buttonSize + padding * 2 + progressHeight;
                var phraseWidth = w - padding * 2;
                var phraseHeight = h - padding * 4 - progressHeight - buttonSize - buttonSize * largeButton;
                drawFittedText(
                    ui.hide ? '?' : convertPhrase(content.lessons[lessonNum].phrases[phraseNum]), 
                    ui.hide ? disabledButtonColor : phraseTextColor,
                    phraseX,
                    phraseY,
                    phraseWidth,
                    phraseHeight,
                    'bold',
                    false,
                    'center');
                ui.buttons.push({
                    name: 'phrase',
                    left: phraseX - padding,
                    top: phraseY - padding,
                    right: phraseWidth + padding,
                    bottom: phraseHeight + padding })
                if (ui.show == 'settings') {
                    ctx.fillStyle = dimColor;
                    ctx.fillRect(0, 0, w, h);
                    const attributionHeight = padding;
                    var left = padding * (w > h ? 4 : 1);
                    var right = w - padding * (w > h ? 4 : 1);
                    var top = padding * (h > w ? 4 : 1);
                    var bottom = top + buttonSize * 4 + padding * 6 + attributionHeight;
                    ui.dialog = {
                        left: left,
                        right: right,
                        top: top,
                        bottom: bottom
                    };
                    fillRoundedRect(left, top, right, bottom, padding, dialogBackgroundColor);
                    drawFittedText(
                        'Feedback to Ashley 73 de KK7HXU',
                        dialogAttributionColor,
                        left + padding,
                        bottom - padding - attributionHeight,
                        right - left - padding * 2,
                        attributionHeight,
                        'normal',
                        false,
                        'center');
                    drawFittedText(
                        'Light/Dark:',
                        subduedButtonColor,
                        left + padding,
                        top + padding,
                        right - padding - buttonSize * 3,
                        buttonSize,
                        'normal',
                        false,
                        'left');
                    controlLeft = right - padding - buttonSize * 3;
                    const switchThinFactor = 1.1;
                    fillRoundedRect(
                        controlLeft + padding * switchThinFactor,
                        top + padding * switchThinFactor,
                        right - padding * switchThinFactor - padding,
                        top + padding / switchThinFactor + buttonSize,
                        buttonSize / switchThinFactor / 2,
                        subduedButtonColor);
                    var dark = getDarkMode();
                    ctx.beginPath();
                    ctx.arc(
                        (dark ? right - padding * 2 - buttonSize : controlLeft + padding) + buttonSize / 2,
                        top + padding + buttonSize / 2,
                        buttonSize / 2,
                        0,
                        2 * Math.PI,
                        false);
                    ctx.fillStyle = backgroundColor;
                    ctx.fill();
                    ctx.lineWidth = padding / 10;
                    ctx.strokeStyle = subduedButtonColor;
                    ctx.stroke();
                    var margin = buttonSize / 4;
                    drawFittedText(
                        dark ? '☽' : '☼',
                        subduedButtonColor,
                        (dark ? right - padding * 2 - buttonSize : controlLeft + padding) + margin,
                        top + padding + margin,
                        buttonSize - margin * 2,
                        buttonSize - margin * 2,
                        'normal',
                        true,
                        'center');
                    buttons.push({
                        name: 'mode',
                        left: controlLeft,
                        top: top,
                        right: right,
                        bottom: top + buttonSize + padding / 2 })
                    function drawUpDownControl(label, name, val, min, max, row) {
                        drawFittedText(
                            label,
                            subduedButtonColor,
                            left + padding,
                            row,
                            right - padding - buttonSize * 3,
                            buttonSize,
                            'normal',
                            false,
                            'left');
                        const arrowScale = 0.5;
                        drawFittedText(
                            '❰',
                            val <= min ? disabledButtonColor : subduedButtonColor,
                            controlLeft,
                            row + (buttonSize * arrowScale / 2),
                            buttonSize * arrowScale,
                            buttonSize * arrowScale,
                            'normal',
                            true,
                            'center');
                        if (val > min) {
                            buttons.push({
                                name: name + 'Down',
                                left: controlLeft,
                                top: row,
                                right: controlLeft + buttonSize,
                                bottom: row + buttonSize
                            });
                        }
                        drawButton(
                            name,
                            val,
                            subduedButtonColor,
                            controlLeft + buttonSize,
                            row,
                            buttonSize,
                            buttonSize,
                            'center')
                        drawFittedText(
                            '❱',
                            val >= max ? disabledButtonColor : subduedButtonColor,
                            controlLeft + buttonSize * 2 + buttonSize * arrowScale,
                            row + (buttonSize * arrowScale / 2),
                            buttonSize * arrowScale,
                            buttonSize * arrowScale,
                            'normal',
                            true,
                            'center');
                        if (val < max) {
                            buttons.push({
                                name: name + 'Up',
                                left: controlLeft + buttonSize * 2,
                                top: row,
                                right: controlLeft + buttonSize * 4,
                                bottom: row + buttonSize });
                        }
                    }
                    drawUpDownControl('Speed', 'speed', getSpeed(), 5, 50, top + padding * 2 + buttonSize);
                    drawUpDownControl('Farnsworth', 'farnsworth', getFarnsworth(), 1, 50, top + padding * 3 + buttonSize * 2);
                    drawUpDownControl('Pitch', 'pitch', getPitch(), 100, 900, top + padding * 4 + buttonSize * 3);
                    ui.buttons = buttons;
                }
                function drawMenu(len, fnGetId, fnGetName) {
                    ctx.fillStyle = dimColor;
                    ctx.fillRect(0, 0, w, h);
                    var left = padding * (w > h ? 4 : 1);
                    var right = w - padding * (w > h ? 4 : 1);
                    var top = padding * (h > w ? 4 : 1);
                    var bottom = h - padding * (h > w ? 4 : 1) - padding;
                    var rowHeight = (bottom - top - padding * 2) / len;
                    if (rowHeight > buttonSize + padding * 2) {
                        rowHeight = buttonSize + padding * 2;
                        bottom = top + padding * 2 + rowHeight * len;
                    }
                    ui.dialog = {
                        left: left,
                        right: right,
                        top: top,
                        bottom: bottom
                    };
                    var rowWidth = right - left - padding * 2;
                    fillRoundedRect(left, top, right, bottom, padding, dialogBackgroundColor);
                    for (var i = 0; i < len; i++) {
                        drawButton(
                            'menu_' + fnGetId(i),
                            fnGetName(i),
                            subduedButtonColor,
                            left + padding,
                            top + padding + rowHeight * i,
                            rowWidth,
                            rowHeight,
                            'left',
                            false)
                    }
                }
                switch (ui.show) {
                    case 'content':
                        drawMenu(library.length, i => library[i].id, i => library[i].name);
                        break;
                    case 'lesson':
                        var lessons = content.lessons;
                        drawMenu(lessons.length, i => lessons[i].id, i => lessons[i].name);
                        break;
                    case 'phrase':
                        //var phrases = content.lessons[lessonNum].phrases;
                        //drawMenu(phrases.length, p => p, p => (p + 1) + ' ' + phrases[p]);
                        break;
                }
            }

            function prevLesson() {
                var lesson = getLessonNum();
                if (lesson > 0) setLessonNum(lesson - 1);
                setPhraseNum(0);
            }

            function nextLesson() {
                var lesson = getLessonNum();
                if (lesson < getContent().lessons.length - 1) setLessonNum(lesson + 1);
                setPhraseNum(0);
            }

            function prevPhrase() {
                var phrase = getPhraseNum();
                if (phrase > 0) setPhraseNum(phrase - 1);
            }

            function nextPhrase(autoAdvanceLesson) {
                var phrase = getPhraseNum();
                if (phrase < getContent().lessons[getLessonNum()].phrases.length - 1) {
                    setPhraseNum(phrase + 1);
                } else if (autoAdvanceLesson) {
                    nextLesson();
                    setPhraseNum(0);
                }
            }

            function dismissDialog(x, y) {
                if (x < ui.dialog.left || x > ui.dialog.right || y < ui.dialog.top || y > ui.dialog.bottom) {
                    ui.show = null;
                    redraw();
                    return true;
                }
                return false;
            }

            function selectDialogMenu(x, y, fnSelect) {
                if (dismissDialog(x, y)) return;
                for (var b = ui.buttons.length - 1; b >= 0; b--) {
                    var button = ui.buttons[b];
                    if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                        fnSelect(button.name.substring(5)); // sans 'menu_'
                        ui.show = null;
                        redraw();
                        return;
                    }
                }
            }

            function touch(x, y) {
                if (ui.show == 'settings') {
                    if (dismissDialog(x, y)) return;
                    for (var b = 0; b < ui.buttons.length; b++) {
                        var button = ui.buttons[b];
                        if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                            switch (button.name) {
                                case 'mode':
                                    setDarkMode(!getDarkMode());
                                    redraw();
                                    return;
                                case 'speed':
                                    stopPhrase();
                                    playPhrase('r', false);
                                    return;
                                case 'speedUp':
                                    stopPhrase();
                                    setSpeed(getSpeed() + 1);
                                    redraw();
                                    playPhrase('vv', false);
                                    return;
                                case 'speedDown':
                                    stopPhrase();
                                    setSpeed(getSpeed() - 1);
                                    redraw();
                                    playPhrase('vv', false);
                                    return;
                                case 'farnsworth':
                                    stopPhrase();
                                    playPhrase('vv', false);
                                    return;
                                case 'farnsworthUp':
                                    stopPhrase();
                                    setFarnsworth(getFarnsworth() + 1);
                                    redraw();
                                    playPhrase('vv', false);
                                    return;
                                case 'farnsworthDown':
                                    stopPhrase();
                                    setFarnsworth(getFarnsworth() - 1);
                                    redraw();
                                    playPhrase('vv', false);
                                    return;
                                case 'pitch':
                                    stopPhrase();
                                    playPhrase('v', false);
                                    return;
                                case 'pitchUp':
                                    stopPhrase();
                                    setPitch(getPitch() + 10);
                                    redraw();
                                    playPhrase('v', false);
                                    return;
                                case 'pitchDown':
                                    stopPhrase();
                                    setPitch(getPitch() - 10);
                                    redraw();
                                    playPhrase('v', false);
                                    return;
                            }
                        }
                    }
                } else if (ui.show == 'content') {
                    selectDialogMenu(x, y, c => setContent(c));
                    return;
                } else if (ui.show == 'lesson') {
                    selectDialogMenu(x, y, c => setLesson(c));
                    return;
                } else if (ui.show == 'phrase') {
                    selectDialogMenu(x, y, c => setPhraseNum(c));
                    return;
                } else {
                    for (var b in ui.buttons) {
                        var button = ui.buttons[b];
                        if (x >= button.left && x <= button.right && y >= button.top && y <= button.bottom) {
                            switch (button.name) {
                                case 'settings':
                                    stopPhrase();
                                    ui.playing = false;
                                    ui.show = 'settings';
                                    redraw();
                                    return;
                                case 'content':
                                    stopPhrase();
                                    ui.playing = false;
                                    ui.show = 'content';
                                    redraw();
                                    return;
                                case 'lesson':
                                    stopPhrase();
                                    ui.playing = false;
                                    ui.show = 'lesson';
                                    redraw();
                                    return;
                                case 'phraseNum':
                                    stopPhrase();
                                    ui.playing = false;
                                    ui.show = 'phrase';
                                    redraw();
                                    return;
                                case 'phrase':
                                    stopPhrase();
                                    ui.playing = true;
                                    playPhrase(getCurrentPhrase(), false);
                                    redraw();
                                    return;
                                case 'playPause':
                                    stopPhrase();
                                    ui.playing = !ui.playing;
                                    if (ui.playing) playPhrase(getCurrentPhrase(), true);
                                    redraw();
                                    return;
                                case 'prevLesson':
                                    stopPhrase();
                                    ui.playing = false;
                                    prevLesson();
                                    redraw();
                                    return;
                                case 'nextLesson':
                                    stopPhrase();
                                    ui.playing = false;
                                    nextLesson(false);
                                    redraw();
                                    return;
                                case 'prevPhrase':
                                    stopPhrase();
                                    ui.playing = false;
                                    prevPhrase();
                                    redraw();
                                    return;
                                case 'nextPhrase':
                                    stopPhrase();
                                    ui.playing = false;
                                    nextPhrase(false);
                                    redraw();
                                    return;
                            }
                        }
                    }
                }
            }

            function migrateSettings() {
                function migrateV0toV1() {
                    // v0 had only CWOPS content (no 'content' setting) and a single 'lesson'/'phrase'
                    var lessonNum = localStorage.getItem('lesson');
                    var phraseNum = localStorage.getItem('phrase');
                    if (lessonNum && phraseNum) {
                        localStorage.setItem('content', 'CWOPS');
                        localStorage.removeItem('lesson');
                        localStorage.setItem('lesson_CWOPS', library.find(c => c.id == 'CWOPS').lessons[lessonNum].id);
                        localStorage.removeItem('phrase');
                        localStorage.setItem('phrase_CWOPS', phraseNum);
                        localStorage.setItem('version', 1);
                    }
                }
                function migrateV1toV2() {
                    // v1 had words/phrases/calls which were collapsed to a single 'practice'
                    var lesson = localStorage.getItem('lesson_CWOPS');
                    if (lesson.endsWith('P') || lesson.endsWith('CC') || lesson.endsWith('DC')) {
                        var migrate = lesson[0] + 'BW';
                        localStorage.setItem('lesson_CWOPS', migrate); // migrate lesson
                        localStorage.setItem('phrase_CWOPS', 0); // reset phrase within (sorry)
                        localStorage.setItem('version', 2);
                    }
                }
                function migrateV2toV3() {
                    // v2 had characters/practice which were collapsed to a single lesson
                    var lesson = localStorage.getItem('lesson_CWOPS');
                    var migrate = 'CWOB' + (lesson[0] || '1');
                    if (lesson[1] == '0') migrate += '0';
                    localStorage.setItem('lesson_CWOPS', migrate); // migrate lesson
                    localStorage.setItem('phrase_CWOPS', 0); // reset phrase within (sorry)
                    localStorage.setItem('version', 3);
                }
                try
                {
                    if ((localStorage.getItem('version') || '0') == '0') migrateV0toV1()
                    if ((localStorage.getItem('version') || '0') == '1') migrateV1toV2()
                    if ((localStorage.getItem('version') || '0') == '2') migrateV2toV3()
                } catch (e) {
                    trace('Settings migration error: ' + e);
                    localStorage.clear();
                }
            }

            function testMigration() {
                localStorage.removeItem('version'); // v0 -> v1
                localStorage.setItem('lesson', 3);
                localStorage.setItem('phrase', 4);
                migrateSettings();
                localStorage.setItem('version', 1); // v1 -> v2
                localStorage.setItem('lesson_CWOPS', '3CC');
                localStorage.setItem('phrase_CWOPS', 4);
                migrateSettings();
                localStorage.setItem('version', 2); // v2 -> v3
                localStorage.setItem('lesson_CWOPS', '3CC');
                localStorage.setItem('phrase_CWOPS', 4);
                migrateSettings();
            }

            onload = function() {
                if (location.search == '?clear-settings') localStorage.clear();
                //testMigration();
                migrateSettings();
                var ratio = devicePixelRatio;
                canvas = document.getElementById('canvas');
                canvas.onmousedown = function(e) { e.preventDefault(); touch(e.x * ratio, e.y * ratio); };

                resizeCanvas();
                redraw();
                setSpeed(getSpeed());
                setFarnsworth(getFarnsworth());
                document.onvisibilitychange = function(e) {
                    if (document.hidden) {
                        stopPhrase();
                        stopAudio();
                        ui.playing = false;
                        redraw();
                    }
                };
            }

            onresize = function() {
                resizeCanvas();
                redraw();
            }
        </script>
    </head>
    <body class="dark">
        <canvas id="canvas"></canvas>
    </body>
    <!--
        TODO:
        - Hilight characters upon main tap
        - Tap/hold to speed advance
        - Random playback?
        - Phrase picker?
        - Keyboard control for desktop
    -->
</html>
